<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOMBO Dream API</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 min-h-screen font-sans antialiased">

    <div class="p-4 space-y-4 md:flex md:flex-row md:h-screen">

        <!-- Parameter Area -->
        <div class="bg-white/50 backdrop-blur-md rounded-lg shadow-md p-4 md:w-1/4 md:overflow-y-auto">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">WOMBO Dream</h1>

            <!-- Authorization Token Input -->
            <div class="mb-4">
                <label for="authorization-token" class="block text-gray-700 text-sm font-bold mb-2">Authorization
                    Token:</label>
                <input type="text" id="authorization-token"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="Enter your Authorization Token">
            </div>

            <div class="mb-4">
                <label for="prompt" class="block text-gray-700 text-sm font-bold mb-2">Prompt:</label>
                <input type="text" id="prompt"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    value="cow eat grass">
            </div>

            <div class="mb-4">
                <label for="aspect_ratio" class="block text-gray-700 text-sm font-bold mb-2">Aspect Ratio:</label>
                <select id="aspect_ratio"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="old_vertical_ratio">Old Vertical Ratio</option>
                    <option value="square">Square</option>
                    <option value="widescreen">Widescreen</option>
                    <option value="vertical">Vertical</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="style" class="block text-gray-700 text-sm font-bold mb-2">Style:</label>
                <input type="number" id="style"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    value="123">
            </div>

            <div class="flex justify-start">
                <button id="request-button-1"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Generate
                    Image</button>
            </div>
        </div>

        <!-- Image Area -->
        <div
            class="bg-white/50 backdrop-blur-md rounded-lg shadow-md p-4 md:w-3/4 md:flex md:items-center md:justify-center">
            <img id="final-image" src="" alt="Generated Image" class="max-w-full rounded-lg md:max-h-full">
        </div>

    </div>

    <script>
        const requestButton1 = document.getElementById('request-button-1');
        const finalImage = document.getElementById('final-image');
        const authTokenInput = document.getElementById('authorization-token');

        const promptInput = document.getElementById('prompt');
        const aspectRatioSelect = document.getElementById('aspect_ratio');
        const styleInput = document.getElementById('style');

        let taskId = null;
        const LOCAL_STORAGE_TOKEN_KEY = 'wombo_auth_token';
        let polling = true;
        let timeoutId = null;
        const DEFAULT_DISPLAY_FREQ = 10; // 设置默认的 Display Frequency

        function saveTokenToLocalStorage(token) {
            localStorage.setItem(LOCAL_STORAGE_TOKEN_KEY, token);
        }

        function getTokenFromLocalStorage() {
            return localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY);
        }

        window.addEventListener('load', () => {
            const storedToken = getTokenFromLocalStorage();
            if (storedToken) {
                authTokenInput.value = storedToken;
            }
        });

        async function handleFirstRequest() {
            const promptValue = promptInput.value;
            const aspectRatioValue = aspectRatioSelect.value;
            const styleValue = styleInput.value;
            const authTokenValue = authTokenInput.value;

            if (!authTokenValue) {
                alert("Please enter your Authorization Token.");
                return;
            }

            try {
                const response = await fetch('/api/wombo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `bearer ${authTokenValue}`
                    },
                    body: JSON.stringify({
                        prompt: promptValue,
                        aspect_ratio: aspectRatioValue,
                        style: styleValue,
                        display_freq: DEFAULT_DISPLAY_FREQ // 使用默认值
                    })
                });

                const data = await response.json();

                taskId = data.id;
                saveTokenToLocalStorage(authTokenValue);

                console.log("Task ID:", taskId);
                polling = true;
                handleSecondRequest();

            } catch (error) {
                console.error("Error:", error);
            }
        }

        async function handleSecondRequest() {
            const authTokenValue = authTokenInput.value;

            if (!taskId) {
                alert("Task ID is not available. Please generate an image first.");
                return;
            }

            if (!authTokenValue) {
                alert("Please enter your Authorization Token.");
                return;
            }

            if (!polling) {
                console.log("Polling stopped.");
                return;
            }

            try {
                const response = await fetch(`/api/get-wombo-status?taskId=${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `bearer ${authTokenValue}`
                    },
                });

                const data = await response.json();

                if (data.state === "completed") {
                    if (data.result && data.result.final) {
                        finalImage.src = data.result.final;
                        finalImage.alt = "WOMBO Dream Image";
                        polling = false;
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                        }
                        console.log("Image complete. Polling stopped.");
                    }
                    return;

                } else if (data.state === "pending") {
                    // 清空图片区域
                    finalImage.src = "";
                    finalImage.alt = "No image generated yet.";
                    timeoutId = setTimeout(() => handleSecondRequest(), 1000);
                } else {
                    polling = false;
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }
                }


            } catch (error) {
                console.error("Error:", error);
                polling = false;
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
            }
        }

        requestButton1.addEventListener('click', handleFirstRequest);
    </script>

</body>

</html>
