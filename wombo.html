<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOMBO Dream 艺术生成</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .container-wrapper {
            display: flex;
            height: 100vh;
            padding: 1rem;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
        }
        
        .secondary-btn {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .download-btn {
            background: linear-gradient(45deg, #0ba360 0%, #3cba92 100%);
        }
        
        .history-item-delete {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            padding: 0.25rem 0.5rem;
            background-color: rgba(220, 38, 38, 0.8);
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        
        .history-item:hover .history-item-delete {
            opacity: 1;
        }
        
        .input-field {
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload-btn {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload-btn:hover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .radio-btn:checked + .radio-label {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .preview-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: #f8fafc;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-placeholder {
            color: #94a3b8;
            text-align: center;
            padding: 2rem;
        }
        
        .history-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .history-item:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toggle button styles */
        .toggle-btn {
            position: relative;
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .toggle-btn:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .toggle-btn i {
            transition: transform 0.3s ease;
        }
        
        .image-ref-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }
        
        .image-ref-section.expanded {
            max-height: 500px;
        }

        #styleGalleryContainer {
            display: none;
        }
        #styleGalleryContainer.show {
            display: block;
        }
        #imagePreviewContainer {
            border: 2px dashed #cbd5e0;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        #imagePreview {
            max-height: 100%;
            object-fit: contain; /* Add this line */
            justify-self: center;
        }
        .input-field {
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

    </style>
</head>

<body>
    <div class="container-wrapper gap-4">
        <!-- Left Panel - Parameters -->
        <div class="panel w-80 p-4 flex flex-col">
            <div class="flex items-center mb-2">
                <div class="bg-gradient-to-r from-purple-500 to-blue-500 w-10 h-10 rounded-lg flex items-center justify-center text-white mr-3">
                    <i class="fas fa-magic"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">WOMBO Dream</h1>
            </div>
            <div class="flex flex-row justify-center items-center mb-4">
                <a href="./wombohistory.html" target="_blank" class="text-blue-500">批量下载</a>
                <a href="./womboauth.html" target="_blank" class="text-blue-500 ml-4">授权令牌</a>
            </div>
            <div class="mb-2 relative">
                <label for="authorization-token" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                    <i class="fas fa-key mr-2 text-gray-500"></i> 授权令牌
                </label>
                <input type="text" id="authorization-token"
                    class="input-field w-full px-3 py-2 rounded-lg bg-white shadow-sm focus:outline-none pr-10"
                    placeholder="输入你的授权令牌">
                <button id="refresh-token-button"
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg p-2 transition">
                    <i class="fas fa-sync"></i>
                </button>
            </div>            
            
            <div>
                
                <div>
                    <input type="hidden" id="aspect_ratio" value="old_vertical_ratio">
                </div>

                <div class="mb-2">
                    <label for="style" class="block text-sm font-medium text-gray-700 mb-1"><i class="fas fa-seedling mr-2 text-blue-500"></i>风格 ID</label>
                    <input type="number" id="style"
                        class="input-field w-full px-3 py-2 rounded-lg bg-white shadow-sm focus:outline-none"
                        value="147"
                        onkeydown="if (event.keyCode == 13) { handleFirstRequest(); return false; }">
                        <div class="flex items-center justify-between">
                        <div id="imagePreviewContainer" class="mt-1 h-48 rounded-lg overflow-hidden p-2">
                            <img id="imagePreview" src="" alt="预览">
                        </div>
                        </div>
                </div>

                <div class="mb-2">
                    <label for="prompt" class="block text-sm font-medium text-gray-700 mb-1">提示词</label>
                    <input type="text" id="prompt"
                        class="input-field w-full px-3 py-2 rounded-lg bg-white shadow-sm focus:outline-none"
                        value="a woman in A-POSE, white background"
                        onkeydown="if (event.keyCode == 13) { handleFirstRequest(); return false; }">
                </div>
            </div>
            
            <!-- Image Reference Toggle Button -->
            <div class="toggle-btn" id="toggle-image-ref">
                <i class="fas fa-caret-right mr-2 text-gray-500"></i>
                <span class="text-sm font-medium text-gray-700">图片参考</span>
            </div>
            
            <!-- Image Reference Section (initially hidden) -->
            <div class="image-ref-section mb-2 overflow-y-auto" id="image-ref-section">
                <div class="mb-2">
                    <div class="file-upload">
                        <div class="file-upload-btn">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-1"></i>
                            <p class="text-sm text-gray-500">拖放文件到这里或点击上传</p>
                            <span class="text-xs text-gray-400">支持 JPG, PNG</span>
                        </div>
                        <input type="file" id="image-upload" accept="image/jpeg, image/png">
                    </div>
                </div>
                
                <div class="mb-2">
                    <label for="mediastore-uid" class="block text-sm font-medium text-gray-700 mb-1">Mediastore UID</label>
                    <input type="text" id="mediastore-uid"
                        class="input-field w-full px-3 py-2 rounded-lg bg-white shadow-sm focus:outline-none"
                        placeholder="输入 Mediastore UID">
                </div>

                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">权重</label>
                    <div class="flex flex-wrap gap-2">
                        <div class="flex items-center">
                            <input type="radio" id="weight-low" name="weight" value="LOW" class="hidden radio-btn" checked>
                            <label for="weight-low" class="radio-label px-3 py-1 border rounded-lg cursor-pointer transition">低</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="weight-medium" name="weight" value="MEDIUM" class="hidden radio-btn">
                            <label for="weight-medium" class="radio-label px-3 py-1 border rounded-lg cursor-pointer transition">中</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="weight-high" name="weight" value="HIGH" class="hidden radio-btn">
                            <label for="weight-high" class="radio-label px-3 py-1 border rounded-lg cursor-pointer transition">高</label>
                        </div>
                    </div>
                </div>
                <button id="clear-button"
                    class="w-full py-2 px-3 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition flex items-center justify-center">
                    <i class="fas fa-trash-alt mr-2"></i> 清除
                </button>
            </div>
            
            <div>
                <button id="request-button-1"
                    class="w-full py-2 px-3 rounded-lg text-white text-sm font-medium gradient-btn flex items-center justify-center">
                    <i class="fas fa-magic mr-2"></i> 生成图片
                </button>
            </div>
        </div>
        
        <!-- Style Gallery Container -->
        <div id="styleGalleryContainer" class="fixed top-0 left-0 w-full bg-black bg-opacity-50 z-50 hidden items-center justify-center px-8">
            <div id="styleGallery" class="bg-white rounded-lg shadow-xl p-4 grid grid-cols-4 md:grid-cols-8 lg:grid-cols-12 gap-4 max-h-screen overflow-y-auto">
            <!-- Image List (Replace with your images) -->
            <img src="https://img.liyao.sbs/file/WB_style/1744611574347_161.png" alt="161" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611508199_159.png" alt="159" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611579706_158.png" alt="158" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611577432_157.png" alt="157" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611570368_156.png" alt="156" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611567284_155.png" alt="155" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611985721_154.png" alt="154" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611978402_151.png" alt="151" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611584599_150.png" alt="150" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611978433_148.png" alt="148" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611519710_147.png" alt="147" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
                <img src="https://img.liyao.sbs/file/WB_style/1744611943165_146.png" alt="146" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611614777_145.png" alt="145" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611526021_144.png" alt="144" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611613484_143.png" alt="143" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611615841_142.png" alt="142" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611529263_141.png" alt="141" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611619512_139.png" alt="139" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611980227_138.png" alt="138" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611613456_137.png" alt="137" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611528786_136.png" alt="136" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611530805_135.png" alt="135" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611629445_134.png" alt="134" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611623593_133.png" alt="133" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611524632_132.png" alt="132" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611983981_131.png" alt="131" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611625086_130.png" alt="130" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611623510_129.png" alt="129" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611915357_128.png" alt="128" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611633079_127.png" alt="127" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611639652_126.png" alt="126" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611636532_125.png" alt="125" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611631708_124.png" alt="124" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611628917_123.png" alt="123" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611628367_122.png" alt="122" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611632576_121.png" alt="121" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611640430_120.png" alt="120" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611640618_119.png" alt="119" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611631660_118.png" alt="118" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611428368_117.png" alt="117" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611428972_116.png" alt="116" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611437648_115.png" alt="115" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611435895_114.png" alt="114" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611431512_113.png" alt="113" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611635708_112.png" alt="112" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611442809_111.png" alt="111" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611443977_110.png" alt="110" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611448884_109.png" alt="109" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611444660_108.png" alt="108" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611448796_107.png" alt="107" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611446328_106.png" alt="106" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611457282_105.png" alt="105" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611454681_104.png" alt="104" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611450126_103.png" alt="103" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611500532_100.png" alt="100" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611505452_97.png" alt="97" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611396156_96.png" alt="96" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611399935_95.png" alt="95" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611396657_94.png" alt="94" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611394148_84.png" alt="84" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611503020_83.png" alt="83" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611395258_80.png" alt="80" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611393550_78.png" alt="78" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611390634_77.png" alt="77" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611390509_76.png" alt="76" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611387358_74.png" alt="74" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611391625_73.png" alt="73" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611382962_72.png" alt="72" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611390913_71.png" alt="71" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611381405_68.png" alt="68" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611381954_67.png" alt="67" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611383822_66.png" alt="66" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611379603_65.png" alt="65" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611379550_63.png" alt="63" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611376105_61.png" alt="61" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611579947_60.png" alt="60" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611377177_58.png" alt="58" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611380794_57.png" alt="57" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611568477_55.png" alt="55" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611505579_54.png" alt="54" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611502722_53.png" alt="53" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611574535_52.png" alt="52" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611490556_50.png" alt="50" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611493556_49.png" alt="49" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611491029_48.png" alt="48" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611492868_47.png" alt="47" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611570898_46.png" alt="46" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611494574_45.png" alt="45" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611564551_42.png" alt="42" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611550432_41.png" alt="41" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611563362_40.png" alt="40" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611979658_39.png" alt="39" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611566544_38.png" alt="38" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611567097_37.png" alt="37" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611572034_36.png" alt="36" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611979889_35.png" alt="35" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611568522_34.png" alt="34" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611913749_32.png" alt="32" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611916349_31.png" alt="31" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611913971_29.png" alt="29" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611556201_28.png" alt="28" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611476752_27.png" alt="27" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611484368_26.png" alt="26" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611483344_25.png" alt="25" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611479576_24.png" alt="24" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611475293_23.png" alt="23" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611481750_22.png" alt="22" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611341897_21.png" alt="21" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611550009_20.png" alt="20" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611339874_19.png" alt="19" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611341334_18.png" alt="18" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611335681_17.png" alt="17" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611334323_16.png" alt="16" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611337133_15.png" alt="15" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611330568_14.png" alt="14" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611329262_13.png" alt="13" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611331118_12.png" alt="12" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611322582_11.png" alt="11" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611331312_10.png" alt="10" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611329489_9.png" alt="9" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611327141_8.png" alt="8" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611320337_7.png" alt="7" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611321222_6.png" alt="6" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611317504_5.png" alt="5" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611317151_4.png" alt="4" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611322146_3.png" alt="3" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611315181_2.png" alt="2" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            <img src="https://img.liyao.sbs/file/WB_style/1744611319218_1.png" alt="1" class="w-full h-auto cursor-pointer border border-gray-200 rounded">
            </div>
        </div>
        <!-- Center Panel - Image Preview -->
        <div class="panel flex-1 p-4 flex flex-col">
            <div class="preview-image-container mb-3">
                <img id="final-image" src="" alt="生成的图片" class="w-full h-full object-contain hidden">
                <div id="preview-placeholder" class="preview-placeholder">
                    <i class="fas fa-image fa-3x mb-2 text-gray-300"></i>
                    <p class="text-gray-500">图片预览区域</p>
                    <p class="text-xs text-gray-400 mt-1">生成的图片将显示在这里</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="filename" placeholder="自定义文件名 (可选)" 
                    class="input-field flex-1 px-3 py-2 rounded-lg bg-white shadow-sm focus:outline-none text-sm">
                <button id="download-button" 
                    class="download-btn py-2 px-4 rounded-lg text-white text-sm font-medium flex items-center">
                    <i class="fas fa-download mr-2"></i> 下载
                </button>
            </div>
        </div>
        
        <!-- Right Panel - History -->
        <div class="panel w-80 p-4 flex flex-col">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-md font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-history mr-2 text-purple-500"></i> 历史记录
                </h2>
                <button id="export-button"
                    class="ml-2 py-1 px-2 rounded-lg bg-gray-200 text-gray-700 text-xs font-medium hover:bg-gray-300 transition flex items-center">
                    <i class="fas fa-file-export mr-1"></i> 导出
                </button>
                <span id="history-count" class="bg-gray-100 text-gray-600 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span>
            </div>
            
            <div id="history-container" class="space-y-2 flex-1 overflow-y-auto pb-2">
                <div id="empty-history" class="text-center py-8">
                    <i class="fas fa-images fa-2x text-gray-300 mb-2"></i>
                    <p class="text-gray-500">暂无历史记录</p>
                    <p class="text-xs text-gray-400 mt-1">生成的图片将显示在这里</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Original JavaScript Code (unchanged) -->
    <script>
        // All original JavaScript code goes here unchanged
        // Only the HTML and CSS have been restyled
        
        // ==== ORIGINAL JAVASCRIPT CODE ==== //
        const requestButton1 = document.getElementById('request-button-1');
        const finalImage = document.getElementById('final-image');
        const authTokenInput = document.getElementById('authorization-token');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const emptyHistory = document.getElementById('empty-history');
        const historyCount = document.getElementById('history-count');

        const promptInput = document.getElementById('prompt');
        const styleInput = document.getElementById('style');

        // New elements for image upload
        const imageUploadInput = document.getElementById('image-upload');
        const clearButton = document.getElementById('clear-button');
        const mediastoreUidInput = document.getElementById('mediastore-uid');

        // History elements
        const historyContainer = document.getElementById('history-container');
        const exportButton = document.getElementById('export-button');

        const openGalleryBtn = document.getElementById('imagePreviewContainer');
        const styleGalleryContainer = document.getElementById('styleGalleryContainer');
        const styleGallery = document.getElementById('styleGallery');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');

        const refreshTokenButton = document.getElementById('refresh-token-button');

        let taskId = null;
        const LOCAL_STORAGE_TOKEN_KEY = 'wombo_auth_token';
        let polling = true;
        let timeoutId = null;
        const DEFAULT_DISPLAY_FREQ = 10; // 设置默认的 Display Frequency
        let selectedFileBase64 = null; // 用于存储所选文件的 Base64 字符串
        let selectedFileType = 'jpeg'; // 默认或检测到的文件类型
        let mediastoreUid = null; // Store the mediastore_uid from the upload response

        // --- IndexedDB Setup ---
        const DB_NAME = 'womboDreamHistoryDB';
        const DB_VERSION = 1; // Increment to trigger onupgradeneeded
        const OBJECT_STORE_NAME = 'imageHistory';

        let db;

        function initializeDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error("Database open error:", event);
                    reject(event);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("Database opened successfully");
                    resolve();
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // 如果旧版本的数据库存在，删除旧的对象仓库
                    if (db.objectStoreNames.contains(OBJECT_STORE_NAME)) {
                        db.deleteObjectStore(OBJECT_STORE_NAME);
                    }

                    // 创建新的对象仓库
                    const objectStore = db.createObjectStore(OBJECT_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('prompt', 'prompt', { unique: false }); // 创建 prompt 索引
                    console.log("Object store created");
                };
            });
        }

        // --- Local Storage Functions ---
        function saveTokenToLocalStorage(token) {
            localStorage.setItem(LOCAL_STORAGE_TOKEN_KEY, token);
        }

        function getTokenFromLocalStorage() {
            return localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY);
        }

        // --- Utility Functions ---
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function displayHistory() {
            getAllHistoryItems().then(items => {
                // 反转数组，使最新的记录排在最前面
                items.reverse();
                // 使用新的方式更新UI
                updateHistoryUI(items);
                historyCount.textContent = items.length;
            });
        }

        function updateHistoryUI(items) {
            // 首先清空历史记录容器
            historyContainer.innerHTML = '';

            if (items.length > 0) {
                emptyHistory.style.display = 'none';
                // 使用文档片段优化性能
                const fragment = document.createDocumentFragment();
                items.forEach(item => {
                    const historyItemDiv = createHistoryItemDiv(item);
                    fragment.appendChild(historyItemDiv);
                });
                historyContainer.appendChild(fragment);
            } else {
                emptyHistory.style.display = 'block';
            }
        }

        function createHistoryItemDiv(item) {
            const historyItemDiv = document.createElement('div');
            historyItemDiv.classList.add('history-item', 'bg-white', 'p-2', 'rounded-lg', 'shadow-sm', 'relative', 'hover:shadow-md');
            historyItemDiv.dataset.id = item.id; // Store ID for easy access
            historyItemDiv.innerHTML = `
                <div class="flex items-start">
                    <div class="relative w-16 h-16 rounded-md overflow-hidden flex-shrink-0">
                        <img src="${item.image}" alt="${item.prompt}" 
                            class="w-full h-full object-cover transition duration-200 ease-in-out">
                    </div>
                    <div class="ml-2 flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-800 line-clamp-2">${item.prompt || '无提示词'}</p>
                        <div class="flex items-center mt-1">
                            <span class="inline-block w-2 h-2 rounded-full bg-blue-500 mr-1"></span>
                            <span class="text-xs text-gray-500 font-bold">${item.style}</span>
                        </div>
                        ${item.mediastore_uid ? `<p class="text-xs text-gray-400 mt-1 truncate">${item.mediastore_uid}</p>` : ''}
                    </div>
                </div>
                <button class="history-item-delete">
                    <i class="fas fa-times"></i>
                </button>
            `;
            historyItemDiv.addEventListener('click', () => {
                // Set Input field
                promptInput.value = item.prompt;
                styleInput.value = item.style;
                aspectRatioSelect.value = item.aspect_ratio;
                // Set Image field
                finalImage.src = item.image;
                finalImage.classList.remove('hidden');
                previewPlaceholder.style.display = 'none';
                finalImage.alt = "WOMBO Dream Image";
                // Set Mediastore field
                mediastoreUid = item.mediastore_uid;
                mediastoreUidInput.value = item.mediastore_uid; // Set the input field
                // Set radio field
                if (item.weight) {
                    const weightRadio = document.querySelector(`input[name="weight"][value="${item.weight}"]`);
                    if (weightRadio) {
                        weightRadio.checked = true;
                        document.querySelector(`label[for="${weightRadio.id}"]`).classList.add('border-blue-500', 'bg-blue-50');
                    }
                }
                // HightLight
                document.querySelectorAll('.history-item').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                historyItemDiv.classList.add('ring-2', 'ring-blue-500');
            });
            // Add delete function
            const deleteButton = historyItemDiv.querySelector('.history-item-delete');
            deleteButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent item click
                const itemId = parseInt(historyItemDiv.dataset.id);
                deleteHistoryItem(itemId).then(() => {
                    // 删除成功后，从 UI 中移除该元素
                    const itemToRemove = document.querySelector(`.history-item[data-id="${itemId}"]`);
                    if (itemToRemove) {
                        historyContainer.removeChild(itemToRemove);
                    }
                    // 重新获取历史记录数量并更新
                    getAllHistoryItems().then(items => {
                        historyCount.textContent = items.length;
                        if (items.length === 0) {
                            emptyHistory.style.display = 'block';
                        }
                    });
                }).catch(err => {
                    console.error('Error deleting history item:', err);
                });
            });
            return historyItemDiv;
        }

        // --- IndexedDB Functions ---
        function saveImageToDB(data, imageBase64) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([OBJECT_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(OBJECT_STORE_NAME);

                const item = {
                    ...data,
                    image: imageBase64 // Store the base64 image
                };

                const request = objectStore.add(item);

                request.onsuccess = (event) => {
                    console.log('Image saved to DB with id:', event.target.result);
                    resolve(event.target.result); // Resolve with the new ID
                };

                request.onerror = (event) => {
                    console.error('Error saving image to DB:', event);
                    reject(event);
                };
            });
        }

        function getAllHistoryItems() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([OBJECT_STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(OBJECT_STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error('Error getting all history items:', event);
                    reject(event);
                };
            });
        }

        function deleteHistoryItem(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([OBJECT_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(OBJECT_STORE_NAME);
                const request = objectStore.delete(id);
                request.onsuccess = (event) => {
                    console.log('History item deleted from DB with id:', id);
                    resolve();
                };
                request.onerror = (event) => {
                    console.error('Error deleting history item from DB:', event);
                    reject(event);
                };
            });
        }

        function addHistoryItemToUI(item) {
            const historyItemDiv = createHistoryItemDiv(item);
            historyContainer.appendChild(historyItemDiv);
        }

        function imageToBase64(imageUrl) {
            const proxiedImageUrl = `https://aipic.liyao.sbs/api/image-proxy?url=${encodeURIComponent(imageUrl)}`;

            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';

                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL();
                    resolve(dataURL);
                };

                img.onerror = (error) => {
                    reject(error);
                };

                img.src = proxiedImageUrl;
            });
        }

        // Update radio button styling when changed
        document.querySelectorAll('input[name="weight"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.radio-label').forEach(label => {
                    label.classList.remove('border-blue-500', 'bg-blue-50');
                });
                document.querySelector(`label[for="${this.id}"]`).classList.add('border-blue-500', 'bg-blue-50');
            });
        });

        // Initialize radio buttons
        document.querySelector('input[name="weight"]:checked + label').classList.add('border-blue-500', 'bg-blue-50');

        // --- Event Listeners and Initialization ---
        window.addEventListener('load', async () => {
            const storedToken = getTokenFromLocalStorage();
            if (storedToken) {
                authTokenInput.value = storedToken;
            }
            finalImage.alt = "生成的图片区域"; // 设置初始 alt 文本

            try {
                await initializeDatabase();
                displayHistory();
            } catch (error) {
                console.error("Failed to initialize database:", error);
                // Handle the error appropriately, e.g., display a message to the user
            }
        });

        // --- Image Reference Toggle Functionality ---
        const toggleImageRefBtn = document.getElementById('toggle-image-ref');
        const imageRefSection = document.getElementById('image-ref-section');

        toggleImageRefBtn.addEventListener('click', () => {
            imageRefSection.classList.toggle('expanded');
            const icon = toggleImageRefBtn.querySelector('i');
            if (imageRefSection.classList.contains('expanded')) {
                icon.classList.remove('fa-caret-right');
                icon.classList.add('fa-caret-down');
            } else {
                icon.classList.remove('fa-caret-down');
                icon.classList.add('fa-caret-right');
            }
        });

        async function handleFirstRequest() {
            const promptValue = promptInput.value;
            // const aspectRatioValue = aspectRatioSelect.value;  // 删除这行
            const aspectRatioValue = "old_vertical_ratio";  // 使用固定值
            const styleValue = styleInput.value;
            const authTokenValue = authTokenInput.value;
            mediastoreUid = mediastoreUidInput.value.trim() || null;

            if (!authTokenValue) {
                alert("请输入你的授权令牌。");
                return;
            }

            // Clear previous image and stop polling if any
            finalImage.src = "";
            finalImage.classList.add('hidden');
            previewPlaceholder.style.display = 'flex';
            finalImage.alt = "生成中...";
            polling = false;
            if (timeoutId) {
                clearTimeout(timeoutId);
            }


            try {
                let requestUrl = 'https://aipic.liyao.sbs/api/wombo'; // Default URL
                let requestBody = { // Default body
                    prompt: promptValue,
                    aspect_ratio: aspectRatioValue,
                    style: styleValue,
                    display_freq: DEFAULT_DISPLAY_FREQ
                };

                if (mediastoreUid) {
                // Use the new API endpoint and structure
                requestUrl = 'https://aipic.liyao.sbs/api/wombo-with-image';
                const weightValue = document.querySelector('input[name="weight"]:checked').value; // Get selected weight
                requestBody = {
                    prompt: promptValue,
                    aspect_ratio: aspectRatioValue,
                    style: styleValue,
                    display_freq: DEFAULT_DISPLAY_FREQ,
                    mediastore_id: mediastoreUid,
                    weight: weightValue
                };

                }

                // Use the existing or new proxy endpoint for generating images
                const response = await fetch(requestUrl, { // Dynamic URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `bearer ${authTokenValue}`
                    },
                    body: JSON.stringify(requestBody) // Dynamic body
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`启动生成任务失败: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();

                if (!data.id) {
                    throw new Error(`响应中找不到任务 ID: ${JSON.stringify(data)}`);
                }

                taskId = data.id;
                saveTokenToLocalStorage(authTokenValue); // 成功启动时保存令牌

                console.log("任务 ID:", taskId);
                polling = true; // 开始轮询
                handleSecondRequest(); // 开始检查状态

            } catch (error) {
                console.error("启动图像生成时出错:", error);
                finalImage.alt = `生成图像时出错: ${error.message}`;
                alert(`生成图像时出错: ${error.message}`);
            }
        }

        async function handleSecondRequest() {
            const authTokenValue = authTokenInput.value;

            if (!taskId) {
                console.log("尝试在没有任务 ID 的情况下进行轮询。");
                return; // 如果正确调用，则不应发生
            }

            if (!authTokenValue) {
                // 令牌可能已被清除，停止轮询
                polling = false;
                 console.log("轮询已停止：缺少身份验证令牌。");
                return;
            }

            if (!polling) {
                console.log("轮询已停止。");
                return;
            }

            try {
                 // Use the proxy endpoint for getting status
                const response = await fetch(`https://aipic.liyao.sbs/api/get-wombo-status?taskId=${taskId}`, { // 假设代理在 /api/get-wombo-status
                    method: 'GET',
                    headers: {
                         // 如果你的代理/API 需要，也发送令牌以进行状态检查
                        'Authorization': `bearer ${authTokenValue}`
                    },
                });

                if (!response.ok) {
                     const errorText = await response.text();
                     throw new Error(`获取任务状态失败: ${response.status} ${response.statusText} - ${errorText}`);
                 }


                const data = await response.json();

                if (data.state === "completed") {
                    if (data.result && data.result.final) {
                        const imageUrl = data.result.final; // Get the image URL
                        finalImage.src = imageUrl;
                        finalImage.classList.remove('hidden');
                        previewPlaceholder.style.display = 'none';
                        finalImage.alt = "WOMBO Dream Image";
                        polling = false;
                        if (timeoutId) clearTimeout(timeoutId);
                        console.log("图像已完成。轮询已停止。");

                        // Convert image URL to Base64
                        imageToBase64(imageUrl)
                            .then(imageBase64 => {
                                // --- Store to IndexDB after successful image generation ---
                                const currentParams = {
                                    prompt: promptInput.value,
                                    style: styleInput.value,
                                    aspect_ratio: aspectRatioSelect.value,
                                    mediastore_uid: mediastoreUid,
                                    weight: document.querySelector('input[name="weight"]:checked').value
                                };

                                saveImageToDB(currentParams,imageBase64)
                                    .then(() => {
                                        displayHistory(); // Refresh history
                                    })
                                    .catch(err => {
                                        console.error("Error saving image to history:", err);
                                    });
                            })
                            .catch(error => {
                                console.error("Error converting image to base64:", error);
                                // Handle error, maybe store the URL instead, or show an error message
                            });
                    } else {
                        // 已完成但没有最终图像？处理错误
                        polling = false;
                        if (timeoutId) clearTimeout(timeoutId);
                        finalImage.alt = "任务已完成，但未找到最终图像 URL。";
                        console.error("任务已完成但没有最终图像 URL:", data);
                    }
                    return; // 停止轮询

                } else if (data.state === "failed") {
                    polling = false;
                    if (timeoutId) clearTimeout(timeoutId);
                    finalImage.alt = `图像生成失败: ${data.result?.error || '未知错误'}`;
                    console.error("图像生成失败:", data);
                    alert(`图像生成失败: ${data.result?.error || '未知错误'}`);
                     return; // 停止轮询

                } else if (data.state === "pending" || data.state === "generating") {
                     // Update status if needed (e.g., display progress)
                     const progress = data.photo_url_list && data.photo_url_list.length > 0 ? ` (${data.photo_url_list.length * 10}%)` : '';
                     finalImage.alt = `生成中... ${data.state}${progress}`;
                     if (data.photo_url_list && data.photo_url_list.length > 0) {
                         // 可选择显示中间图像
                         finalImage.src = data.photo_url_list[data.photo_url_list.length - 1];
                         finalImage.classList.remove('hidden');
                         previewPlaceholder.style.display = 'none';
                     } else {
                         // 如果没有中间图像可用，则清除图像
                         finalImage.src = "";
                         finalImage.classList.add('hidden');
                         previewPlaceholder.style.display = 'flex';
                     }
                     // Continue polling
                    timeoutId = setTimeout(() => handleSecondRequest(), 1500); // 每 1.5 秒轮询一次
                } else {
                     // Unknown state, stop polling to prevent infinite loops
                     polling = false;
                     if (timeoutId) clearTimeout(timeoutId);
                     finalImage.alt = `未知任务状态: ${data.state}`;
                     console.warn("收到未知任务状态:", data);
                     return; // 停止轮询
                }

            } catch (error) {
                console.error("轮询任务状态时出错:", error);
                finalImage.alt = `检查状态时出错: ${error.message}`;
                polling = false; // 发生错误时停止轮询
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
            }
        }

        requestButton1.addEventListener('click', handleFirstRequest);

        // --- Image Upload Logic ---
        imageUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
               // Clear previous mediastore data
               clearMediastoreData(); // Call the clear function
               mediastoreUid = null; // Clear existing mediastoreUid
               mediastoreUidInput.value = ''; // Clear the input field

                const reader = new FileReader();
                reader.onload = async function(e) {
                    const fullBase64 = e.target.result;
                    // 仅提取逗号后面的 Base64 部分
                    selectedFileBase64 = fullBase64.split(',')[1];
                    // 确定 media_suffix 的文件类型
                    if (file.type === 'image/png') {
                        selectedFileType = 'png';
                    } else {
                        selectedFileType = 'jpeg'; // 默认为 jpeg
                    }

                  // Automatically upload after reading
                  try {
                      const authTokenValue = authTokenInput.value;
                      if (!authTokenValue) {
                          alert("请输入你的授权令牌。");
                          return;
                      }

                      const payload = {
                          media_suffix: selectedFileType,
                          num_uploads: 1,
                          image: selectedFileBase64
                      };

                      // Call the new backend proxy endpoint
                      const response = await fetch('https://aipic.liyao.sbs/api/mediastore-proxy', { // Use the new proxy endpoint
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json', // Frontend sends JSON to proxy
                              'Authorization': `bearer ${authTokenValue}` // Send token to proxy
                          },
                          body: JSON.stringify(payload) // Send JSON payload
                      });

                      const responseData = await response.json(); // Assume proxy forwards JSON

                      if (!response.ok) {
                           throw new Error(`Mediastore 上传失败: ${response.status} ${response.statusText} - ${JSON.stringify(responseData)}`);
                       }

                       // Store the mediastore_uid
                       mediastoreUid = responseData.mediastore_uid;
                       mediastoreUidInput.value = mediastoreUid;

                       // Show success message
                       alert('图片上传成功！现在可以生成新的图像了。');

                  } catch (error) {
                      console.error("上传到 mediastore 时出错:", error);
                      alert(`上传图像时出错: ${error.message}`);
                  }
                }
                reader.onerror = function(e) {
                    console.error("读取文件时出错:", e);
                    alert("读取文件时出错。");
                    selectedFileBase64 = null;
                }
                reader.readAsDataURL(file); // 将文件读取为 Data URL
            } else {
                 clearMediastoreData(); // Clear if no file is selected
            }
        });

        function clearMediastoreData() {
            selectedFileBase64 = null;
            mediastoreUid = null;
            imageUploadInput.value = ''; // Clear the file input
            mediastoreUidInput.value = ''; // Clear the input field
        }

        clearButton.addEventListener('click', () => {
            clearMediastoreData();
        });

        const downloadButton = document.getElementById('download-button');
        const filenameInput = document.getElementById('filename');

        downloadButton.addEventListener('click', () => {
            const imageUrl = finalImage.src;
            if (imageUrl) {
                let filename = filenameInput.value.trim();
                if (!filename) {
                    filename = promptInput.value.trim().substring(0, 30) || 'wombo-dream-image';
                }
                downloadImage(imageUrl, filename);
            } else {
                alert('请先生成图片！');
            }
        });

        function downloadImage(imageUrl, filename) {
            fetch(imageUrl, {
                    method: 'GET',
                    mode: 'cors', // 解决跨域问题
                    headers: {
                        'Access-Control-Allow-Origin': '*'
                    }
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename + '.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('下载图片时出错:', error);
                    alert('下载图片时出错，请检查控制台。');
                });
        }

        exportButton.addEventListener('click', async () => {
            try {
                const allItems = await getAllHistoryItems();
                if (allItems.length === 0) {
                    alert('没有历史记录可以导出！');
                    return;
                }
                const json = JSON.stringify(allItems);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wombo-dream-history.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('导出历史记录时出错:', error);
                alert('导出历史记录时出错，请检查控制台。');
            }
        });

        // Function to update the image preview based on gallery alt
        function updateImagePreview(inputValue) {
            if (inputValue) {
            // Find the image in the gallery with the matching alt
            const galleryImage = styleGallery.querySelector(`img[alt="${inputValue}"]`);
            if (galleryImage) {
                // If the image is found, set the preview image source
                const imageSource = galleryImage.src;
                imagePreview.src = imageSource;
                imagePreviewContainer.classList.add('show');
                imagePreviewContainer.classList.remove('hidden');
            } else {
                // If no image is found, clear the preview and hide the container
                imagePreview.src = '';
                imagePreviewContainer.classList.remove('show');
                imagePreviewContainer.classList.add('hidden');
            }
            } else {
            // If input is empty, clear the preview and hide the container
            imagePreview.src = '';
            imagePreviewContainer.classList.remove('show');
            imagePreviewContainer.classList.add('hidden');
            }
        }
        // Open Gallery
        openGalleryBtn.addEventListener('click', () => {
            styleGalleryContainer.classList.add('show', 'flex'); // Show and use flexbox
            styleGalleryContainer.classList.remove('hidden');
        });
        // Click on Image
        styleGallery.addEventListener('click', (event) => {
            if (event.target.tagName === 'IMG') {
            styleInput.value = event.target.alt;
            styleGalleryContainer.classList.remove('show', 'flex'); // Hide and remove flexbox
            styleGalleryContainer.classList.add('hidden');
            updateImagePreview(event.target.alt); // Update the preview
            }
        });
        // Close gallery when clicking outside
        styleGalleryContainer.addEventListener('click', (event) => {
            if (event.target === styleGalleryContainer) {
            styleGalleryContainer.classList.remove('show', 'flex'); // Hide and remove flexbox
            styleGalleryContainer.classList.add('hidden');
            }
        });
        // Listen for input changes to update the preview
        styleInput.addEventListener('input', () => {
            updateImagePreview(styleInput.value);
        });
        // Initialize preview based on initial input value (if any)
        updateImagePreview(styleInput.value);

        // 模拟生成 x-firebase-appcheck
        function generateAppCheckToken() {
            const header = {
                "kid": "D_o00g",
                "typ": "JWT",
                "alg": "RS256"
            };
            const payload = {
                "sub": "1:181681569359:web:277133b57fecf57af0f43a",
                "aud": ["projects/181681569359", "projects/paint-prod"],
                "provider": "recaptcha_enterprise",
                "iss": "https://firebaseappcheck.googleapis.com/181681569359",
                "exp": Math.floor(Date.now() / 1000) + 3600, // 1 hour
                "iat": Math.floor(Date.now() / 1000),
                "jti": generateRandomString(32)
            };

            const encodedHeader = btoa(JSON.stringify(header));
            const encodedPayload = btoa(JSON.stringify(payload));
            const signature = generateRandomString(64); // 模拟签名

            return `${encodedHeader}.${encodedPayload}.${signature}`;
        }

        function generateRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        async function refreshToken() {
            const backendUrl = 'https://aipic.liyao.sbs/api/womboauth'; // Firebase API Endpoint
            const appCheckToken = generateAppCheckToken(); // 模拟生成 x-firebase-appcheck
            const email = "2313814221@qq.com"; //  你的邮箱
            const password = "liyao2313814221"; // 你的密码
            
            const requestBody = {
                returnSecureToken: true,
                email: email,
                password: password,
                clientType: "CLIENT_TYPE_WEB"
            };

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'authority': 'identitytoolkit.googleapis.com',
                        'accept': '*/*',
                        'accept-encoding': 'gzip, deflate, br, zstd',
                        'accept-language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
                        'content-type': 'application/json',
                        'origin': 'https://dream.ai',
                        'priority': 'u=1, i',
                        'sec-ch-ua': '"Microsoft Edge";v="135", "Not-A.Brand";v="8", "Chromium";v="135"',
                        'sec-ch-ua-mobile': '?0',
                        'sec-ch-ua-platform': '"Windows"',
                        'sec-fetch-dest': 'empty',
                        'sec-fetch-mode': 'cors',
                        'sec-fetch-site': 'cross-site',
                        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36 Edg/135.0.0.0',
                        'x-client-version': 'Chrome/JsCore/9.23.0/FirebaseCore-web',
                        'x-firebase-appcheck': appCheckToken,
                        'x-firebase-gmpid': '1:181681569359:web:277133b57fecf57af0f43a',
                    },
                    body: JSON.stringify(requestBody) // 使用构建好的请求体
                });

                const responseData = await response.json();

                // 提取 idToken 并更新 UI
                if (responseData && responseData.idToken) {
                    const newToken = responseData.idToken;
                    authTokenInput.value = newToken;
                    saveTokenToLocalStorage(newToken);
                    alert('授权令牌已刷新！');
                } else {
                    alert('刷新授权令牌失败，请检查控制台。');
                    console.error('刷新授权令牌失败：', responseData);
                }

            } catch (error) {
                alert(`刷新授权令牌时出错: ${error}`);
                console.error("刷新授权令牌时出错:", error);
            }
        }

        refreshTokenButton.addEventListener('click', refreshToken);
    </script>
</body>
</html>

