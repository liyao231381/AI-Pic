<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOMBO Dream API</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles for JSON display with scrollbars */
        #json-display-1,
        #json-display-2,
        #json-display-1-desktop,
        #json-display-2-desktop {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: rgba(255, 255, 255, 0.3);
            /* Glassmorphism background */
            padding: 10px;
            border-radius: 5px;
            backdrop-filter: blur(10px);
            /* Apply blur filter */
            overflow: auto;
            /* Enable scroll if content overflows */
            max-height: 200px;
            /* Fixed max height for scroll */
        }

        /* Hide scrollbar on Chrome, Safari and Opera */
        #json-display-1::-webkit-scrollbar,
        #json-display-2::-webkit-scrollbar,
        #json-display-1-desktop::-webkit-scrollbar,
        #json-display-2-desktop::-webkit-scrollbar {
            width: 0.5em;
        }

        #json-display-1::-webkit-scrollbar-track,
        #json-display-2::-webkit-scrollbar-track,
        #json-display-1-desktop::-webkit-scrollbar-track,
        #json-display-2-desktop::-webkit-scrollbar-track {
            background-color: transparent;
        }

        #json-display-1::-webkit-scrollbar-thumb,
        #json-display-2::-webkit-scrollbar-thumb,
        #json-display-1-desktop::-webkit-scrollbar-thumb,
        #json-display-2-desktop::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        /* Hide scrollbar on Firefox */
        #json-display-1,
        #json-display-2,
        #json-display-1-desktop,
        #json-display-2-desktop {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans antialiased">

    <!-- Mobile View -->
    <div class="md:hidden p-4 space-y-4">
        <div class="bg-white/50 backdrop-blur-md rounded-lg shadow-md p-4">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">WOMBO Dream</h1>

            <!-- Authorization Token Input -->
            <div class="mb-4">
                <label for="authorization-token" class="block text-gray-700 text-sm font-bold mb-2">Authorization
                    Token:</label>
                <input type="text" id="authorization-token"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="Enter your Authorization Token">
            </div>

            <div class="mb-4">
                <label for="prompt" class="block text-gray-700 text-sm font-bold mb-2">Prompt:</label>
                <input type="text" id="prompt"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    value="cow eat grass">
            </div>

            <div class="mb-4">
                <label for="aspect_ratio" class="block text-gray-700 text-sm font-bold mb-2">Aspect Ratio:</label>
                <select id="aspect_ratio"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="old_vertical_ratio">Old Vertical Ratio</option>
                    <option value="square">Square</option>
                    <option value="widescreen">Widescreen</option>
                    <option value="vertical">Vertical</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="style" class="block text-gray-700 text-sm font-bold mb-2">Style:</label>
                <input type="number" id="style"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    value="123">
            </div>

            <div class="mb-4">
                <label for="display_freq" class="block text-gray-700 text-sm font-bold mb-2">Display Frequency:</label>
                <input type="number" id="display_freq"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    value="10">
            </div>

            <div class="flex justify-start">
                <button id="request-button-1"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Generate
                    Image</button>
                <button id="request-button-2"
                    class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline ml-4"
                    disabled>Get Image Status</button>
            </div>
        </div>

        <div class="bg-white/50 backdrop-blur-md rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Request 1 Response:</h2>
            <div id="json-display-1" class="border rounded p-4"></div>
        </div>

        <div class="bg-white/50 backdrop-blur-md rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Request 2 Response:</h2>
            <div id="json-display-2" class="border rounded p-4"></div>
        </div>

        <div class="bg-white/50 backdrop-blur-md rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Final Image:</h2>
            <img id="final-image" src="" alt="Generated Image" class="max-w-full rounded-lg">
        </div>
    </div>

    <!-- Desktop View -->
    <div class="hidden md:flex flex-row h-screen">

        <!-- Parameter Area -->
        <div class="w-1/4 bg-white/50 backdrop-blur-md p-6 space-y-4 overflow-y-auto">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">WOMBO Dream</h1>
            <!-- Authorization Token Input -->
            <div class="mb-4">
                <label for="authorization-token-desktop"
                    class="block text-gray-700 text-sm font-bold mb-2">Authorization
                    Token:</label>
                <input type="text" id="authorization-token-desktop"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="Enter your Authorization Token">
            </div>

            <div class="mb-4">
                <label for="prompt" class="block text-gray-700 text-sm font-bold mb-2">Prompt:</label>
                <input type="text" id="prompt-desktop"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    value="cow eat grass">
            </div>

            <div class="mb-4">
                <label for="aspect_ratio" class="block text-gray-700 text-sm font-bold mb-2">Aspect Ratio:</label>
                <select id="aspect_ratio-desktop"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="old_vertical_ratio">Old Vertical Ratio</option>
                    <option value="square">Square</option>
                    <option value="widescreen">Widescreen</option>
                    <option value="vertical">Vertical</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="style" class="block text-gray-700 text-sm font-bold mb-2">Style:</label>
                <input type="number" id="style-desktop"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    value="123">
            </div>

            <div class="mb-4">
                <label for="display_freq" class="block text-gray-700 text-sm font-bold mb-2">Display Frequency:</label>
                <input type="number" id="display_freq-desktop"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    value="10">
            </div>

            <div class="flex justify-start">
                <button id="request-button-1-desktop"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Generate
                    Image</button>
                <button id="request-button-2-desktop"
                    class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline ml-4"
                    disabled>Get Image Status</button>
            </div>
        </div>

        <!-- JSON Area -->
        <div class="w-1/4 bg-white/50 backdrop-blur-md p-6 flex flex-col space-y-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Request 1 Response:</h2>
            <div id="json-display-1-desktop" class="border rounded p-4 flex-grow overflow-auto"></div>

            <h2 class="text-lg font-semibold text-gray-800 mb-2">Request 2 Response:</h2>
            <div id="json-display-2-desktop" class="border rounded p-4 flex-grow overflow-auto"></div>
        </div>

        <!-- Image Area -->
        <div class="w-2/4 bg-white/50 backdrop-blur-md p-6 flex items-center justify-center">
            <img id="final-image-desktop" src="" alt="Generated Image" class="max-w-full max-h-full rounded-lg">
        </div>

    </div>


    <script>
        // Mobile elements
        const requestButton1Mobile = document.getElementById('request-button-1');
        const requestButton2Mobile = document.getElementById('request-button-2');
        const jsonDisplay1Mobile = document.getElementById('json-display-1');
        const jsonDisplay2Mobile = document.getElementById('json-display-2');
        const finalImageMobile = document.getElementById('final-image');
        const authTokenInputMobile = document.getElementById('authorization-token'); // Authorization Token Input

        // Desktop elements
        const requestButton1Desktop = document.getElementById('request-button-1-desktop');
        const requestButton2Desktop = document.getElementById('request-button-2-desktop');
        const jsonDisplay1Desktop = document.getElementById('json-display-1-desktop');
        const jsonDisplay2Desktop = document.getElementById('json-display-2-desktop');
        const finalImageDesktop = document.getElementById('final-image-desktop');
        const authTokenInputDesktop = document.getElementById('authorization-token-desktop'); // Authorization Token Input


        // Input elements (shared between mobile and desktop for simplicity)
        const promptInputMobile = document.getElementById('prompt');
        const aspectRatioSelectMobile = document.getElementById('aspect_ratio');
        const styleInputMobile = document.getElementById('style');
        const displayFreqInputMobile = document.getElementById('display_freq');

        const promptInputDesktop = document.getElementById('prompt-desktop');
        const aspectRatioSelectDesktop = document.getElementById('aspect_ratio-desktop');
        const styleInputDesktop = document.getElementById('style-desktop');
        const displayFreqInputDesktop = document.getElementById('display_freq-desktop');


        let taskId = null; // Store the task ID from the first request
        const LOCAL_STORAGE_TOKEN_KEY = 'wombo_auth_token'; // Key for local storage
        let polling = true; // Flag to control polling
        let timeoutId = null; // Store the timeout ID for clearing


        // Function to save the token to local storage
        function saveTokenToLocalStorage(token) {
            localStorage.setItem(LOCAL_STORAGE_TOKEN_KEY, token);
        }

        // Function to retrieve the token from local storage
        function getTokenFromLocalStorage() {
            return localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY);
        }

        // On page load, try to get the token from local storage and populate the input fields
        window.addEventListener('load', () => {
            const storedToken = getTokenFromLocalStorage();
            if (storedToken) {
                authTokenInputMobile.value = storedToken;
                authTokenInputDesktop.value = storedToken;
            }
        });


        // Function to handle the first API request
        async function handleFirstRequest(isDesktop = false) {
            // Determine if the call is from desktop or mobile
            const promptInput = isDesktop ? promptInputDesktop : promptInputMobile;
            const aspectRatioSelect = isDesktop ? aspectRatioSelectDesktop : aspectRatioSelectMobile;
            const styleInput = isDesktop ? styleInputDesktop : styleInputMobile;
            const displayFreqInput = isDesktop ? displayFreqInputDesktop : displayFreqInputMobile;
            const authTokenInput = isDesktop ? authTokenInputDesktop : authTokenInputMobile; // Authorization Token Input

            const promptValue = promptInput.value;
            const aspectRatioValue = aspectRatioSelect.value;
            const styleValue = styleInput.value;
            const displayFreqValue = displayFreqInput.value;
            const authTokenValue = authTokenInput.value; // Get Authorization Token

            if (!authTokenValue) {
                alert("Please enter your Authorization Token.");
                return;
            }

            try {
                const response = await fetch('/api/wombo', {  //  改为你的 Vercel Function 地址
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `bearer ${authTokenValue}` // Set Authorization Header
                    },
                    body: JSON.stringify({
                        prompt: promptValue,
                        aspect_ratio: aspectRatioValue,
                        style: styleValue,
                        display_freq: displayFreqValue
                    }) //  传递数据
                });

                const data = await response.json();

                // Update displays for both mobile and desktop
                jsonDisplay1Mobile.textContent = JSON.stringify(data, null, 2);
                jsonDisplay1Desktop.textContent = JSON.stringify(data, null, 2);

                taskId = data.id; // Store the task ID

                // Save the token to local storage on successful request
                saveTokenToLocalStorage(authTokenValue);

                console.log("Task ID:", taskId);
                polling = true; // Reset polling flag
                // Immediately trigger the second request
                handleSecondRequest(isDesktop);

            } catch (error) {
                // Update displays for both mobile and desktop in case of error
                jsonDisplay1Mobile.textContent = `Error: ${error}`;
                jsonDisplay1Desktop.textContent = `Error: ${error}`;

                console.error("Error:", error);
            }
        }

        // Function to handle the second API request and poll for completion
        async function handleSecondRequest(isDesktop = false) {
            // Determine if the call is from desktop or mobile
            const authTokenInput = isDesktop ? authTokenInputDesktop : authTokenInputMobile; // Authorization Token Input
            const jsonDisplay2 = isDesktop ? jsonDisplay2Desktop : jsonDisplay2Mobile;
            const finalImage = isDesktop ? finalImageDesktop : finalImageMobile;
            const authTokenValue = authTokenInput.value; // Get Authorization Token

            if (!taskId) {
                alert("Task ID is not available. Please generate an image first.");
                return;
            }

            if (!authTokenValue) {
                alert("Please enter your Authorization Token.");
                return;
            }
                if (!polling) {
                    console.log("Polling stopped.");
                    return;
                }

            try {
                const response = await fetch(`/api/get-wombo-status?taskId=${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `bearer ${authTokenValue}`
                    },
                });

                const data = await response.json();

                // Update displays for both mobile and desktop
                jsonDisplay2Mobile.textContent = JSON.stringify(data, null, 2);
                jsonDisplay2Desktop.textContent = JSON.stringify(data, null, 2);



                if (data.state === "completed") {
                     if (data.result && data.result.final) {
                        finalImageMobile.src = data.result.final;
                        finalImageMobile.alt = "WOMBO Dream Image";
                        finalImageDesktop.src = data.result.final;
                        finalImageDesktop.alt = "WOMBO Dream Image";
                        // Image is complete, enable the second button
                        requestButton2Mobile.disabled = true;
                        requestButton2Desktop.disabled = true;
                        polling = false; // Stop polling
                        if (timeoutId) {
                            clearTimeout(timeoutId); // Clear the timeout if it's still running
                        }
                        console.log("Image complete. Polling stopped.");
                     }
                    return; // Stop polling

                } else if (data.state === "pending") {
                    // Image is still pending, poll again after 1 second
                      // 清空图片区域
                    finalImageMobile.src = "";
                    finalImageMobile.alt = "No image generated yet.";
                    finalImageDesktop.src = "";
                    finalImageDesktop.alt = "No image generated yet.";
                    timeoutId = setTimeout(() => handleSecondRequest(isDesktop), 1000); // Store timeout ID
                } else {
                    // Handle other states or errors if needed
                    console.log("Task state:", data.state);
                    requestButton2Mobile.disabled = false;
                    requestButton2Desktop.disabled = false;
                     polling = false; // Stop polling in case of other states
                     if (timeoutId) {
                           clearTimeout(timeoutId); // Clear the timeout if it's still running
                     }
                }


            } catch (error) {
                // Update displays for both mobile and desktop in case of error
                jsonDisplay2Mobile.textContent = `Error: ${error}`;
                jsonDisplay2Desktop.textContent = `Error: ${error}`;
                console.error("Error:", error);
                polling = false; // Stop polling in case of error
                if (timeoutId) {
                    clearTimeout(timeoutId); // Clear the timeout if it's still running
                }
            }
        }


        // Attach event listeners to the buttons for both mobile and desktop
        requestButton1Mobile.addEventListener('click', () => handleFirstRequest(false));
        requestButton1Desktop.addEventListener('click', () => handleFirstRequest(true));
    </script>

</body>

</html>
