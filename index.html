<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 图像生成器 | SiliconFlow</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,line-clamp"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom animations */
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .spinner-bounce-dots .dot {
            width: 10px;
            height: 10px;
            background-color: #3b82f6;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .spinner-bounce-dots .dot1 {
            animation-delay: -0.32s;
        }
        .spinner-bounce-dots .dot2 {
            animation-delay: -0.16s;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* Custom transitions */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        /* Glow effect for buttons */
        .glow:hover {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        /* Custom file upload styling */
        .file-upload:hover {
            background-color: rgba(59, 130, 246, 0.05);
            border-color: #3b82f6;
        }
        /* Gradient background for main button */
        .gradient-bg {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
        }
        .gradient-bg:hover {
            background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
        }
        /* Custom checkbox styling */
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }

        .notification {
          position: fixed;
          bottom: 4rem;
          right: 1rem;
          z-index: 9999;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 font-sans leading-relaxed md:h-screen">
<!-- Parameters Section -->
<div class="params w-full md:w-1/4 p-4 bg-white md:border-r border-gray-200 overflow-y-auto flex flex-col space-y-4 md:h-screen border-b md:border-b-0 shadow-sm">
    <div class="text-center">
        <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-600 to-indigo-600 mb-2">
            AI 图像生成器</h1>
          <div class="flex justify-center space-x-4 mb-3">
              <a href="./edit.html" class="text-sm text-primary hover:text-blue-800 transition flex items-center" target="_blank">
                  <i class="fas fa-edit mr-1"></i>
              </a>
              <a href="./together.html" class="text-sm text-primary hover:text-blue-800 transition flex items-center" target="_blank">
                  <i class="fas fa-exchange-alt mr-1"></i>
              </a>
              <a href="./pollinations.html" class="text-sm text-primary hover:text-blue-800 transition flex items-center" target="_blank">
                  <i class="fas fa-seedling mr-1"></i>
              </a>
              <a href="./stability.html" class="text-sm text-primary hover:text-blue-800 transition flex items-center" target="_blank">
                  <i class="fas fa-cogs mr-1"></i>
              </a>
              <a href="./stable.html" class="text-sm text-primary hover:text-blue-800 transition flex items-center" target="_blank">
                  <i class="fas fa-tree mr-1"></i>
              </a>
              <a href="./wombo.html" class="text-sm text-primary hover:text-blue-800 transition flex items-center" target="_blank">
                  <i class="fas fa-paint-brush"></i>
              </a>
          </div>
    </div>
    <button type="button" id="toggleTranslateArea"
            class="w-full bg-gray-100 text-gray-700 py-2 px-3 rounded-lg text-sm font-medium cursor-pointer transition hover:bg-gray-200 flex items-center justify-center">
        <i class="fas fa-language mr-2"></i> 显示/隐藏 翻译&识别区
    </button>
    <div class="ai-translate-area hidden bg-gray-50 rounded-xl p-4 space-y-3 border border-gray-200">
        <div>
            <label for="apiKey" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
                <i class="fas fa-key mr-2 text-blue-500"></i> API 密钥:
            </label>
            <a href="https://cloud.siliconflow.cn/account/ak" target="_blank" rel="noreferrer"
               class="text-xs text-blue-500 hover:text-blue-700 hover:underline mb-1 block flex items-center">
                <i class="fas fa-external-link-alt mr-1"></i> 获取 硅基流动 API密钥
            </a>
            <div class="relative">
                <input type="text" id="apiKey" placeholder="你的 API 密钥"
                       class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 placeholder-gray-400">
                <i class="fas fa-key absolute left-2.5 top-3 text-gray-400"></i>
            </div>
        </div>
        <div>
            <label for="apiKeyInput" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
                <i class="fas fa-key mr-2 text-blue-500"></i> Gemini API 密钥:
            </label>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer"
               class="text-xs text-blue-500 hover:text-blue-700 hover:underline mb-1 block flex items-center">
                <i class="fas fa-external-link-alt mr-1"></i> 申请 Gemini API密钥
            </a>
            <div class="relative">
                <input type="text" id="apiKeyInput" placeholder="请输入 Gemini API Key"
                       class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 placeholder-gray-400">
                <i class="fab fa-google absolute left-2.5 top-3 text-gray-400"></i>
            </div>
        </div>
        <div>
            <label for="modelSelect" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
                <i class="fas fa-robot mr-2 text-blue-500"></i> 模型选择:
            </label>
            <div class="relative">
                <select id="modelSelect"
                        class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 appearance-none">
                    <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
                    <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                    <option value="gemini-2.0-flas-001">gemini-2.0-flas-001</option>
                    <option value="gemini-2.0-flash-thinking-exp">gemini-2.0-flash-thinking-exp</option>
                    <option value="gemini-2.0-flash-thinking-exp-1219">gemini-2.0-flash-thinking-exp-1219</option>
                    <option value="gemini-2.0-flash-thinking-exp-01-21">gemini-2.0-flash-thinking-exp-01-21</option>
                    <option value="gemini-2.0-flash-lite-preview-02-05">gemini-2.0-flash-lite-preview-02-05</option>
                    <option value="gemini-2.0-flash-lite-preview">gemini-2.0-flash-lite-preview</option>
                    <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
                    <option value="gemini-2.0-pro-exp-02-05">gemini-2.0-pro-exp-02-05</option>
                    <option value="gemini-2.0-pro-exp">gemini-2.0-pro-exp</option>
                    <option value="gemini-exp-1206">gemini-exp-1206</option>
                    <option value="gemini-2.0-flash-exp-image-generation">gemini-2.0-flash-exp-image-generation</option>
                    <option value="gemma-3-27b-it">gemma-3-27b-it</option>
                </select>
                <i class="fas fa-caret-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
            </div>
        </div>
        <div id="translateloadingIndicator" class="hidden text-center py-3">
            <div class="spinner-bounce-dots inline-block">
                <div class="dot dot1"></div>
                <div class="dot dot2"></div>
                <div class="dot dot3"></div>
            </div>
        </div>
        <div id="translationResult"
             class="hidden text-xs font-mono bg-white p-3 rounded-lg border border-gray-200 shadow-inner"></div>
        <div class="flex justify-between space-x-2">
            <button onclick="translateText()"
                    class="flex-1 bg-blue-500 text-white py-2 px-3 rounded-lg cursor-pointer text-sm font-bold transition duration-300 hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center glow">
                <i class="fas fa-exchange-alt"></i><span class="hidden xl:inline ml-1cap">翻译</span>
            </button>
            <button onclick="fillInput()"
                    class="flex-1 bg-orange-500 text-white py-2 px-3 rounded-lg cursor-pointer text-sm font-bold transition duration-300 hover:bg-orange-600 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center glow">
                <i class="fas fa-paste"></i><span class="hidden xl:inline ml-1cap">填入</span>
            </button>
            <button onclick="describeImage()"
                    class="flex-1 bg-green-500 text-white py-2 px-3 rounded-lg cursor-pointer text-sm font-bold transition duration-300 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center glow">
                <i class="fas fa-eye"></i><span class="hidden xl:inline ml-1cap">识别</span>
            </button>
        </div>
        <div class="image-upload-container border-2 border-dashed border-gray-300 rounded-xl p-4 w-full cursor-pointer relative overflow-hidden min-h-[100px] flex flex-col items-center justify-center text-center text-gray-500 hover:border-blue-400 transition file-upload"
             id="imageUploadContainer">
            <input type="file" id="imageUpload" accept="image/*" onchange="previewImage()"
                   class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
            <i class="fas fa-cloud-upload-alt text-2xl mb-2 text-gray-400"></i>
            <p class="text-sm">拖放或点击选择图片</p>
            <img id="imagePreview" src="#" alt="图片预览"
                 class="hidden max-w-full max-h-32 block mx-auto mt-2 rounded-lg shadow-sm">
        </div>
        <div>
            <label for="negativePrompt" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
                <i class="fas fa-ban mr-2 text-red-500"></i> 负面提示语:
            </label>
            <div class="relative">
                <input type="text" id="negativePrompt" placeholder="请输入负面提示词"
                       value="bad quality, low quality, deformed, distorted, bad proportions, ugly"
                       class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 placeholder-gray-400">
                <i class="fas fa-exclamation-triangle absolute left-2.5 top-3 text-gray-400"></i>
            </div>
        </div>
        <div>
            <label for="numInferenceSteps" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
                <i class="fas fa-footsteps mr-2 text-purple-500"></i> 推理步数 (1-50):
            </label>
            <div class="relative">
                <input type="number" id="numInferenceSteps" value="50" min="1" max="50"
                       class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 placeholder-gray-400">
                <i class="fas fa-sliders-h absolute left-2.5 top-3 text-gray-400"></i>
            </div>
        </div>
        <div>
            <label for="guidanceScale" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
                <i class="fas fa-balance-scale mr-2 text-yellow-500"></i> 引导比例 (0-20):
            </label>
            <div class="relative">
                <input type="number" id="guidanceScale" value="2.5" min="0" max="20" step="0.1"
                       class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 placeholder-gray-400">
                <i class="fas fa-tachometer-alt absolute left-2.5 top-3 text-gray-400"></i>
            </div>
        </div>
        <div>
            <label for="seed" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
                <i class="fas fa-seedling mr-2 text-green-500"></i> 种子 (0-9999999999):
            </label>
            <div class="flex items-center space-x-2">
                <div class="relative flex-grow">
                    <input type="number" id="seed" min="0" max="9999999999"
                           class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 placeholder-gray-400">
                    <i class="fas fa-random absolute left-2.5 top-3 text-gray-400"></i>
                </div>
                <button type="button" onclick="randomSeed()"
                        class="bg-teal-500 text-white py-2 px-3 rounded-lg cursor-pointer text-sm font-bold transition duration-300 hover:bg-teal-600 whitespace-nowrap flex items-center glow">
                    <i class="fas fa-dice mr-1"></i> 随机
                </button>
            </div>
        </div>
    </div>
    <!-- End ai-translate-area -->
    <div>
        <label for="model" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
            <i class="fas fa-cogs mr-2 text-blue-500"></i> 模型:
        </label>
        <div class="relative">
            <select id="model" onchange="setModelGuidanceScale()"
                    class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 appearance-none">
                <option value="Kwai-Kolors/Kolors">Kwai-Kolors/Kolors</option>
                <option value="black-forest-labs/FLUX.1-schnell">black-forest-labs/FLUX.1-schnell</option>
                <option value="stabilityai/stable-diffusion-xl-base-1.0">
                    stabilityai/stable-diffusion-xl-base-1.0
                </option>
                <option value="stabilityai/stable-diffusion-3-5-large">
                    stabilityai/stable-diffusion-3-5-large(很慢)
                </option>
                <option value="stabilityai/stable-diffusion-2-1">stabilityai/stable-diffusion-2-1</option>
                <option value="black-forest-labs/FLUX.1-dev">black-forest-labs/FLUX.1-dev(付费)</option>
            </select>
            <i class="fas fa-caret-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
        </div>
    </div>
    <div>
        <label for="imageSize" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
            <i class="fas fa-expand mr-2 text-blue-500"></i> 图像尺寸（宽×高）：
        </label>
        <div class="relative">
            <select id="imageSize"
                    class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 appearance-none">
                <option value="720x1280">默认720x1280 (9:16)</option>
                <option disabled>————方图————</option>
                <option value="512x512">512x512 (1:1)</option>
                <option value="1024x1024">1024x1024 (1:1)</option>
                <option value="1280x1280">1280x1280 (1:1)</option>
                <option value="1440x1440">1440x1440 (1:1)</option>
                <option value="1600x1600">1600x1600 (1:1)</option>
                <option value="1792x1792">1792x1792 (1:1)</option>
                <option value="2048x2048">2048x2048 (1:1)</option>
                <option disabled>————竖图————</option>
                <option value="480x640">480x640 (3:4)</option>
                <option value="600x800">600x800 (3:4)</option>
                <option value="768x1024">768x1024 (3:4)</option>
                <option value="900x1200">800x1200 (3:4)</option>
                <option value="960x1280">960x1280 (3:4)</option>
                <option value="1080x1440">1080x1440 (3:4)</option>
                <option value="1200x1600">1200x1600 (3:4)</option>
                <option value="540x960">540x960 (9:16 qHD)</option>
                <option value="720x1280">720x1280 (9:16 HD)</option>
                <option value="810x1440">810x1440 (9:16 HD+)</option>
                <option value="900x1600">900x1600 (9:16 HD+)</option>
                <option value="1080x1920">1080x1920 (9:16 FHD)</option>
                <option disabled>————横图————</option>
                <option value="640x480">640x480 (4:3 VGA)</option>
                <option value="800x600">800x600 (4:3 SVGA)</option>
                <option value="1024x768">1024x768 (4:3 XGA)</option>
                <option value="1280x960">1280x960 (4:3 QXGA)</option>
                <option value="1440x1080">1440x1080 (4:3 QXGA+)</option>
                <option value="1600x1200">1600x1200 (4:3 UXGA)</option>
                <option value="960x540">960x540 (16:9 qHD)</option>
                <option value="1280x720">1280x720 (16:9 HD)</option>
                <option value="1440x810">1440x810 (16:9 HD+)</option>
                <option value="1600x900">1600x900 (16:9 HD+)</option>
                <option value="1920x1080">1920x1080 (16:9 FHD)</option>
            </select>
            <i class="fas fa-caret-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
        </div>
    </div>
    <div>
        <label for="prompt" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
            <i class="fas fa-comment-dots mr-2 text-blue-500"></i> 提示语:
        </label>
        <textarea id="prompt" placeholder="请输入提示词"
                  class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition duration-300 placeholder-gray-400 min-h-[120px] resize-y"></textarea>
        <div class="mt-2 mb-3 flex justify-between space-x-2">
            <button onclick="pasteText()" title="粘贴"
                    class="flex-1 flex justify-center items-center bg-blue-100 border border-blue-300 rounded-lg p-2 cursor-pointer transition duration-300 hover:bg-blue-200 hover:border-blue-400">
                <i class="fas fa-paste text-blue-600"></i>
            </button>
            <button onclick="copyText()" title="复制"
                    class="flex-1 flex justify-center items-center bg-gray-100 border border-gray-300 rounded-lg p-2 cursor-pointer transition duration-300 hover:bg-gray-200 hover:border-gray-400">
                <i class="fas fa-copy text-gray-600"></i>
            </button>
            <button onclick="clearAll()" title="清除"
                    class="flex-1 flex justify-center items-center bg-red-100 border border-red-300 rounded-lg p-2 cursor-pointer transition duration-300 hover:bg-red-200 hover:border-red-400">
                <i class="fas fa-trash-alt text-red-600"></i>
            </button>
        </div>
    </div>
    <button id="generateButton" onclick="generateImage()"
            class="w-full gradient-bg text-white py-3 px-4 rounded-lg cursor-pointer text-base font-bold transition duration-300 hover:shadow-lg mt-auto flex items-center justify-center">
        <i class="fas fa-magic mr-2"></i> 生成图像
    </button>
    <div id="aiImageUploadContainer">
        <label for="ai-image-upload-container" class="block mb-1 font-bold text-sm text-gray-700 flex items-center">
            <i class="fas fa-image mr-2 text-blue-500"></i> 参考图:
        </label>
        <div class="ai-image-upload-container border-2 border-dashed border-gray-300 rounded-xl p-4 w-full cursor-pointer relative overflow-hidden min-h-[100px] flex flex-col items-center justify-center text-center text-gray-500 hover:border-blue-400 transition file-upload"
             >
            <input type="file" id="aiImageUpload" accept="image/*" onchange="previewAiImage()"
                   class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
            <i class="fas fa-image text-2xl mb-2 text-gray-400"></i>
            <p class="text-sm">拖放或点击选择图片<br>Kolors图生图</p>
            <img id="aiImagePreview" src="#" alt="图片预览"
                 class="hidden max-w-full max-h-32 block mx-auto mt-2 rounded-lg shadow-sm">
            <button type="button" id="aiImageClearButton" onclick="clearAiImage()"
                    class="hidden absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer hover:bg-opacity-70 z-10 transition">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    </div>
</div>
<!-- Result Area -->
<div class="result-area w-full md:w-1/2 p-4 bg-white flex flex-col items-center justify-start md:h-screen relative border-b md:border-b-0 shadow-inner">
  <div id="result" class="w-full h-full flex flex-col items-center justify-center px-4">
      <div class="relative w-fit h-full flex items-center justify-center">
          <img id="generatedImage" loading="lazy" src="https://api.yujn.cn/api/gzl_ACG.php?type=image&form=pe" alt="生成的图像"
               class="w-full max-h-[85vh] object-contain rounded-xl shadow-md cursor-zoom-in hover:shadow-lg transition-shadow hover:scale-105 transition-transform duration-200" />
          <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full w-8 h-8 flex items-center justify-center cursor-pointer hover:bg-opacity-70 transition z-10 hidden"
               id="fullscreenButton">
              <i class="fas fa-expand"></i>
          </div>
      </div>
      <div id="resultButtons" class="flex flex-wrap justify-center items-center w-full gap-2 px-2">
          <div class="flex items-center mt-4 w-full max-w-md">
              <input type="text" id="filenameInput" placeholder="自定义文件名"
                     class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
              <button onclick="downloadImage()" id="downloadButton"
                      class="bg-gray-400 hover:bg-orange-400 text-white font-bold py-2 px-4 rounded-r-md shadow-sm transition-colors flex items-center">
                  <i class="fas fa-download mr-2"></i>
                  <span>下载</span>
              </button>
          </div>
      </div>
  </div>
    <div id="loadingIndicator"
         class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-fit h-fit bg-black bg-opacity-70 flex flex-col items-center justify-center z-50 text-white rounded-xl p-6 shadow-xl">
        <div class="spinner-bounce-dots mb-4">
            <div class="dot dot1"></div>
            <div class="dot dot2"></div>
            <div class="dot dot3"></div>
        </div>
        <span class="text-lg font-bold italic">正在生成图像...</span>
        <p class="text-sm mt-2 opacity-80">这可能需要一些时间，请耐心等待</p>
    </div>
</div>
<!-- History Area -->
<div class="history-area w-full md:w-1/4 p-4 bg-gray-50 md:border-l border-gray-200 overflow-y-auto max-h-[70vh] md:max-h-screen shadow-inner">
    <div id="history">
      <h2 class="text-xl font-semibold mb-3 text-gray-800 flex items-center">
        <i class="fas fa-history mr-2 text-blue-500"></i> 历史记录
      </h2>
      <div class="flex space-x-2 mb-3">
        <button type="button" id="selectAllButton" onclick="toggleSelectAll()" class="bg-gray-200 text-gray-700 py-2 px-3 rounded-lg cursor-pointer text-sm font-bold transition duration-300 hover:bg-gray-300 flex items-center">
          <i class="fas fa-check-square"></i><span class="hidden xl:inline ml-2">全选</span>
        </button>
        <button type="button" id="deleteSelectedButton" onclick="deleteSelectedHistoryItems()" class="bg-red-500 text-white py-2 px-3 rounded-lg cursor-pointer text-sm font-bold transition duration-300 hover:bg-red-600 flex items-center glow">
          <i class="fas fa-trash-alt"></i><span class="hidden xl:inline ml-2">删除选中</span>
        </button>
      </div>
      <div id="historyList" class="space-y-3">
        <!-- History items will be dynamically added here -->
        <!-- Example Structure (Generated by JS):
        <div class="history-item bg-white border border-gray-200 rounded-lg p-3 flex items-start space-x-3 transition duration-200 cursor-pointer hover:bg-gray-100 group relative" data-id="1">
          <input type="checkbox" value="1" class="form-checkbox h-5 w-5 text-blue-600 rounded mt-1 custom-checkbox">
          <div class="image-container flex-shrink-0">
            <img src="base64_or_url" alt="历史图像" class="w-16 h-16 rounded-lg object-cover shadow-sm">
          </div>
          <div class="text-info-container flex-grow overflow-hidden">
            <p class="text-sm font-medium text-gray-800 line-clamp-2">Prompt text...</p>
            <p class="text-xs text-gray-500 mt-1 flex items-center">
              <i class="far fa-clock mr-1"></i> 24/07/29 10:30
            </p>
          </div>
          <button class="delete-button absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs transition duration-300 hover:bg-red-600 opacity-0 group-hover:opacity-100">
            <i class="fas fa-times"></i>
          </button>
        </div>
        -->
      </div>
    </div>
  </div>
  <!-- Notification Area (Positioned Fixed, styled with Tailwind) -->
  <!-- The showNotification JS function will create/append/remove these -->

  <script>
    // Local Storage Keys
    const API_KEY_KEY = 'apiKey';
    const IMAGE_HISTORY_KEY = 'imageHistory';
    const DB_NAME = 'imageGeneratorDB';
    const DB_VERSION = 1;
    const OBJECT_STORE_NAME = 'imageHistoryStore';

    let db; // IndexedDB 数据库对象

    // 初始化 IndexedDB
    function initIndexedDB() {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = function(event) {
        console.error('IndexedDB 打开失败:', event.target.error);
      };

      request.onsuccess = function(event) {
        db = event.target.result;
        console.log('IndexedDB 打开成功');
        displayHistory(); // 初始化时显示历史记录
      };

      request.onupgradeneeded = function(event) {
        const db = event.target.result;

        // 创建对象存储，如果它还不存在
        if (!db.objectStoreNames.contains(OBJECT_STORE_NAME)) {
          const objectStore = db.createObjectStore(OBJECT_STORE_NAME, { keyPath: 'id', autoIncrement: true });
          console.log('对象存储创建成功');
        }
      };
    }

    // 页面加载时初始化 IndexedDB
    window.addEventListener('load', initIndexedDB);

    // Load API Key from local storage on page load
    document.getElementById('apiKey').value = localStorage.getItem(API_KEY_KEY) || '';

    // Function to save API Key to local storage
    function saveApiKey(apiKey) {
      localStorage.setItem(API_KEY_KEY, apiKey);
    }

    // Function to convert URL image to Base64
    function urlToBase64(url) {
      return new Promise((resolve, reject) => {
        fetch(url)
          .then(response => response.blob())
          .then(blob => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          })
          .catch(reject);
      });
    }

    async function saveHistory(data) {
      // 注意：确保调用此函数时传入的是 data.base64Image 而不是 data.imageUrl
      if (!db) {
        console.error('IndexedDB is not initialized.');
        showNotification('无法保存历史记录：数据库未初始化', true);
        return;
      }
      if (!data.base64Image) {
        console.error('无法保存历史记录：缺少图像数据');
        showNotification('无法保存历史记录：缺少图像数据', true);
        return;
      }

      try {
        const now = new Date();
        const creationTime = `${now.getFullYear().toString().slice(-2)}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

        const tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');
        const store = tx.objectStore(OBJECT_STORE_NAME);

        const item = {
          prompt: data.prompt,
          negativePrompt: data.negativePrompt,
          imageSize: data.imageSize,
          numInferenceSteps: data.numInferenceSteps,
          guidanceScale: data.guidanceScale,
          seed: data.seed,
          imageData: data.base64Image, // 直接使用传入的 Base64 数据
          creationTime: creationTime,
          model: data.model // Store the model used
          // 'id' 将在添加成功后自动生成并获取
        };

        const addRequest = store.add(item); // 添加数据

        addRequest.onsuccess = (event) => {
          const newItemId = event.target.result; // 获取新添加项的 ID
          console.log('数据保存到 IndexedDB 成功, ID:', newItemId);
          item.id = newItemId; // 将 ID 添加回 item 对象，以便传递给 UI 函数
          prependHistoryItemToUI(item); // 调用新函数将项添加到 UI 顶部
        };

        addRequest.onerror = (event) => {
          console.error('添加数据到 IndexedDB 失败:', event.target.error);
          showNotification('保存历史记录失败', true);
        };

        tx.oncomplete = () => {
          console.log('IndexedDB 保存事务完成');
          // 此处不再调用 displayHistory()
        };

        tx.onerror = (event) => {
          console.error('IndexedDB 保存事务错误:', event.target.error);
          // 避免重复提示，addRequest.onerror 已处理
        };
      } catch (error) {
        // 这个 catch 主要捕获代码本身的同步错误
        console.error('保存历史记录时发生错误:', error);
        showNotification('保存历史记录时发生内部错误', true);
      }
    }

    // 函数：创建单个历史记录项的 DOM 元素
    function createHistoryItemElement(item) {
        const historyItem = document.createElement('div');
        // Added 'group' class for hover effect on delete button
        historyItem.className = 'history-item group bg-white border border-gray-200 rounded-md p-2 flex items-center space-x-2 transition duration-200 cursor-pointer relative hover:bg-gray-100 hover:scale-105';
        historyItem.dataset.id = item.id; // Use dataset for ID

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = item.id;
        checkbox.className = 'form-checkbox h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 flex-shrink-0';
        checkbox.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent triggering populateForm when clicking checkbox
        });
        historyItem.appendChild(checkbox);

        const imageContainer = document.createElement('div');
        imageContainer.className = 'image-container flex-shrink-0';
        let imageElement = document.createElement('img');
        imageElement.src = item.imageData;
        imageElement.alt = "历史图像";
        imageElement.className = 'max-h-16 w-auto rounded-md object-contain hover:scale-110 transition duration-200'; // Adjusted classes
        imageContainer.appendChild(imageElement);
        historyItem.appendChild(imageContainer);

        const textInfoContainer = document.createElement('div');
        textInfoContainer.className = 'text-info-container flex-grow overflow-hidden min-w-0'; // Added min-w-0

        const promptElement = document.createElement('p');
        promptElement.className = 'text-sm font-medium text-gray-800 line-clamp-2'; // Use line-clamp plugin
        promptElement.textContent = item.prompt || 'No Prompt'; // Fallback text
        promptElement.title = item.prompt; // Add title for full text on hover
        textInfoContainer.appendChild(promptElement);

        const creationTimeElement = document.createElement('p');
        creationTimeElement.className = 'text-xs text-gray-500 mt-0.5'; // Adjusted margin
        creationTimeElement.textContent = item.creationTime || 'No Date'; // Fallback text
        textInfoContainer.appendChild(creationTimeElement);

        historyItem.appendChild(textInfoContainer);

        const deleteButton = document.createElement('button');
        deleteButton.className = 'delete-button absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs transition duration-300 hover:bg-red-600 opacity-0 group-hover:opacity-100 focus:opacity-100'; // Show on group hover/focus
        deleteButton.innerHTML = '&times;'; // Use HTML entity for 'x'
        deleteButton.title = "删除此项";
        deleteButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent triggering populateForm
            deleteHistoryItem(item.id);
        });
        historyItem.appendChild(deleteButton);

        // Click the entire item (except checkbox/button) to populate form
        historyItem.addEventListener('click', () => populateForm(item));

        return historyItem;
    }


    // 函数：将新的历史记录项添加到 UI 列表的顶部
    function prependHistoryItemToUI(item) {
      const historyList = document.getElementById('historyList');
      if (!historyList) return; // 安全检查
      const historyItemElement = createHistoryItemElement(item); // 创建新项的 DOM 元素
      historyList.prepend(historyItemElement); // 将新项添加到列表的开头
    }

    // Function to display history from IndexedDB
    function displayHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = ''; // 清空现有列表

      if (!db) {
        console.warn('IndexedDB 未初始化');
        return;
      }

      const tx = db.transaction(OBJECT_STORE_NAME, 'readonly');
      const store = tx.objectStore(OBJECT_STORE_NAME);
      // 使用 IDBCursor 和 direction 'prev' 来直接获取降序排列的数据
      const request = store.openCursor(null, 'prev'); // 按 ID 降序打开游标

      request.onsuccess = (event) => {
        const cursor = event.target.result;
        if (cursor) {
          const item = cursor.value;
          const historyItemElement = createHistoryItemElement(item); // 使用新函数创建元素
          historyList.appendChild(historyItemElement); // 添加到列表末尾（因为是倒序读取）
          cursor.continue(); // 移动到下一个（更旧的）项目
        }
      };

      request.onerror = (event) => {
        console.error('从 IndexedDB 读取历史记录失败:', event.target.error);
      };
    }


    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('#historyList input[type="checkbox"]');
      const selectAllButton = document.getElementById('selectAllButton');
      // Check if *any* checkbox is currently unchecked
      const anyUnchecked = Array.from(checkboxes).some(checkbox => !checkbox.checked);

      // If any are unchecked, check all. Otherwise, uncheck all.
      checkboxes.forEach(checkbox => {
          checkbox.checked = anyUnchecked;
      });

      // Update button text
      selectAllButton.textContent = anyUnchecked ? '取消全选' : '全选';
    }


    function deleteSelectedHistoryItems() {
      const checkboxes = document.querySelectorAll('#historyList input[type="checkbox"]:checked');
      const idsToDelete = Array.from(checkboxes)
        .map(checkbox => parseInt(checkbox.value));

      if (idsToDelete.length === 0) {
        showNotification('请选择要删除的项。', true);
        return;
      }

      if (!db) {
        console.error('IndexedDB 未初始化，无法删除');
        showNotification('数据库错误，无法删除', true);
        return;
      }

      // Confirmation dialog
      if (!confirm(`确定要删除选中的 ${idsToDelete.length} 项历史记录吗？`)) {
          return; // User cancelled
      }

      const tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');
      const store = tx.objectStore(OBJECT_STORE_NAME);
      const historyList = document.getElementById('historyList');
      let deletedCount = 0;
      let failedCount = 0;

      idsToDelete.forEach(id => {
        const deleteRequest = store.delete(id);
        deleteRequest.onsuccess = () => {
          deletedCount++;
          // 从 UI 中移除对应的元素
          const itemToRemove = historyList.querySelector(`.history-item[data-id="${id}"]`);
          if (itemToRemove) {
            itemToRemove.remove(); // 直接从 DOM 中移除
          } else {
            console.warn(`尝试从 UI 删除历史记录项失败：未找到 data-id 为 ${id} 的元素。`);
          }
        };
        deleteRequest.onerror = (event) => {
          failedCount++;
          console.error(`从 IndexedDB 删除 ID ${id} 失败:`, event.target.error);
        };
      });

      tx.oncomplete = () => {
        console.log(`删除选定项事务完成: ${deletedCount} 成功, ${failedCount} 失败`);
        if (deletedCount > 0) {
          showNotification(`成功删除 ${deletedCount} 项历史记录`);
        }
        if (failedCount > 0) {
          showNotification(`有 ${failedCount} 项删除失败`, true);
        }
        // 清除全选状态
        document.getElementById('selectAllButton').textContent = '全选';
        // Checkboxes are already removed from DOM or handled individually if needed
      };

      tx.onerror = (event) => {
        // 这个错误通常指示整个事务失败，可能没有项被删除
        console.error('删除选定的历史记录项事务失败:', event.target.error);
        showNotification('删除选定的历史记录项时发生错误', true);
      };
    }

    function deleteHistoryItem(id) {
      if (!db) {
        console.error('IndexedDB 未初始化，无法删除');
        showNotification('数据库错误，无法删除', true);
        return;
      }

      const tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');
      const store = tx.objectStore(OBJECT_STORE_NAME);
      const request = store.delete(id);

      request.onsuccess = () => {
        console.log('成功从 IndexedDB 删除历史记录项', id);
        // 从 UI 中移除对应的元素
        const historyList = document.getElementById('historyList');
        const itemToRemove = historyList.querySelector(`.history-item[data-id="${id}"]`);
        if (itemToRemove) {
          itemToRemove.remove(); // 直接从 DOM 中移除
          showNotification('成功删除历史记录项');
        } else {
          console.warn(`尝试从 UI 删除历史记录项失败：未找到 data-id 为 ${id} 的元素。`);
        }
      };

      request.onerror = (event) => {
        console.error('从 IndexedDB 删除历史记录项失败:', event.target.error);
        showNotification('删除历史记录项失败', true);
      };
    }

    // Function to populate the form and display the image
    function populateForm(item) {
      document.getElementById('prompt').value = item.prompt || '';
      document.getElementById('negativePrompt').value = item.negativePrompt || 'bad quality, low quality, deformed, distorted, bad proportions, ugly'; // Default if null/undefined
      document.getElementById('imageSize').value = item.imageSize || '720x1280'; // Default size
      document.getElementById('numInferenceSteps').value = item.numInferenceSteps || 50; // Default steps
      document.getElementById('guidanceScale').value = item.guidanceScale || 2.5; // Default scale
      document.getElementById('seed').value = item.seed || '';
      document.getElementById('model').value = item.model || 'Kwai-Kolors/Kolors'; // Populate model

      // Clear AI image preview if the model doesn't support it or wasn't used
      if (item.model !== 'Kwai-Kolors/Kolors') {
          clearAiImage(); // Clear reference image if model changed or wasn't Kolors
      } else {
          // Optionally, if you stored the reference image used for Kolors, load it here
          // For now, we just clear it if the model isn't Kolors
      }


      document.getElementById('generatedImage').src = item.imageData; // Use Base64
      // Enable the download button
      document.getElementById('downloadButton').disabled = false;
      showNotification("已从历史记录填入");

      // Ensure the correct guidance scale is set based on the populated model
      setModelGuidanceScale();

      // Scroll the result image into view on smaller screens
        if (window.innerWidth < 768) { // md breakpoint
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }
    }

    let aiBase64Image = ""; // 用于存储Base64编码的图片

    function previewAiImage() {
      const file = document.getElementById("aiImageUpload").files[0];
      const reader = new FileReader();
      const previewElement = document.getElementById("aiImagePreview");
      const clearButton = document.getElementById("aiImageClearButton");
      const placeholderText = document.querySelector("#aiImageUploadContainer p");


      reader.onloadend = function() {
        aiBase64Image = reader.result; // 保存Base64编码
        previewElement.src = aiBase64Image;
        previewElement.classList.remove("hidden");
        clearButton.classList.remove("hidden");
        placeholderText.classList.add("hidden");
      }

      if (file) {
        reader.readAsDataURL(file);
      } else {
        previewElement.src = "#";
        previewElement.classList.add("hidden");
        clearButton.classList.add("hidden");
        placeholderText.classList.remove("hidden");
        aiBase64Image = ""; // 清空Base64编码
      }
    }

    function clearAiImage() {
      const aiImageUpload = document.getElementById("aiImageUpload");
      const aiImagePreview = document.getElementById("aiImagePreview");
      const aiImageClearButton = document.getElementById("aiImageClearButton");
      const aiImageUploadContainerP = document.querySelector("#aiImageUploadContainer p");

      aiImageUpload.value = ""; // 清除文件选择
      aiImagePreview.src = "#";
      aiImagePreview.classList.add("hidden");
      aiImageClearButton.classList.add("hidden");
      aiImageUploadContainerP.classList.remove("hidden");
      aiBase64Image = ""; // 清空Base64编码
    }

    const aiImageUploadContainer = document.getElementById("aiImageUploadContainer");
    const aiImageUploadContainerLabel = document.getElementById("aiImageUploadContainerLabel");


    // Drag and Drop for AI Image Upload
    aiImageUploadContainer.addEventListener("dragover", function(event) {
      event.preventDefault();
      aiImageUploadContainer.classList.add("border-blue-400", "bg-blue-50"); // Highlight effect
    });

    aiImageUploadContainer.addEventListener("dragleave", function(event) {
      event.preventDefault();
      aiImageUploadContainer.classList.remove("border-blue-400", "bg-blue-50");
    });

    aiImageUploadContainer.addEventListener("drop", function(event) {
      event.preventDefault();
      aiImageUploadContainer.classList.remove("border-blue-400", "bg-blue-50");

      const file = event.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) { // Basic type check
          document.getElementById("aiImageUpload").files = event.dataTransfer.files; // Assign dropped files
          previewAiImage(); // Trigger preview
      } else {
          showNotification("请拖放有效的图片文件。", true);
      }
    });

    async function generateImage() {
      const apiKey = document.getElementById('apiKey').value;
      const model = document.getElementById('model').value;
      const prompt = document.getElementById('prompt').value;
      const negativePrompt = document.getElementById('negativePrompt').value;
      const imageSize = document.getElementById('imageSize').value;
      const numInferenceSteps = parseInt(document.getElementById('numInferenceSteps').value);
      const guidanceScale = parseFloat(document.getElementById('guidanceScale').value);
      const seedValue = document.getElementById('seed').value;
      const seed = seedValue ? parseInt(seedValue) : undefined; // Use undefined if empty
      const generateButton = document.getElementById('generateButton');
      const loadingIndicatorElement = document.getElementById('loadingIndicator');
      const generatedImageElement = document.getElementById('generatedImage');
      const downloadButton = document.getElementById('downloadButton');

      if (!apiKey) {
          showNotification('请输入 API 密钥。', true);
          document.getElementById('apiKey').focus();
          return;
      }

      // Disable the generate button and show loading
      generateButton.disabled = true;
      let countdown = 10;
      generateButton.textContent = `生成中 (${countdown}s)`;
      loadingIndicatorElement.classList.remove('hidden'); // Use classList

      // Save API key to local storage
      saveApiKey(apiKey);

      const apiUrl = 'https://api.siliconflow.cn/v1/images/generations';

      const data = {
        model: model,
        prompt: prompt,
        negative_prompt: negativePrompt || undefined,
        image_size: imageSize,
        batch_size: 1,
        num_inference_steps: numInferenceSteps,
        guidance_scale: guidanceScale,
        seed: seed, // Already handles undefined if empty
        ...(model === 'Kwai-Kolors/Kolors' && aiBase64Image ? { image: aiBase64Image.split(',')[1] } : {}) // Send only base64 part
      };

       // Remove undefined keys
       Object.keys(data).forEach(key => data[key] === undefined && delete data[key]);


      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json' // Explicitly accept JSON
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
            let errorMsg = `HTTP 错误! 状态: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMsg += ` - ${errorData.message || JSON.stringify(errorData)}`;
            } catch (e) {
                errorMsg += ` - ${await response.text()}`;
            }
          throw new Error(errorMsg);
        }

        const result = await response.json();

        if (result.images && result.images.length > 0 && result.images[0].url) {
          const imageUrl = result.images[0].url;
          // Display image immediately from URL for faster feedback
          // generatedImageElement.src = imageUrl;
          // Convert to Base64 for history saving and potential direct download/copy
          const base64Image = await urlToBase64(imageUrl);

          generatedImageElement.src = base64Image; // Display Base64


          // Save history using base64 data
          await saveHistory({
            prompt: prompt,
            negativePrompt: negativePrompt,
            imageSize: imageSize,
            numInferenceSteps: numInferenceSteps,
            guidanceScale: guidanceScale,
            seed: result.images[0].seed || seed, // Use seed from response if available
            base64Image: base64Image, // Pass Base64 data
            model: model // Pass the model used
          });

          downloadButton.disabled = false;
          showNotification("图像生成成功!");
        } else {
            console.error("API response missing image URL:", result);
            generatedImageElement.src = 'https://api.yujn.cn/api/gzl_ACG.php?type=image&form=pe'; // Error image
            downloadButton.disabled = true;
            showNotification("图像生成失败：API 未返回有效图像。", true);
        }
      } catch (error) {
        console.error('生成图像时出错:', error);
        generatedImageElement.src = 'https://api.yujn.cn/api/gzl_ACG.php?type=image&form=pe'; // Error image
        downloadButton.disabled = true;
        showNotification(`图像生成失败: ${error.message}`, true);
      } finally {
        loadingIndicatorElement.classList.add('hidden'); // Use classList
        // Re-enable button after countdown
        const countdownInterval = setInterval(() => {
          countdown--;
           if (generateButton.disabled) { // Check if still disabled before updating text
               generateButton.textContent = `请稍后 (${countdown}s)`;
           }
          if (countdown <= 0) {
            clearInterval(countdownInterval);
             if (generateButton.disabled) { // Double check before enabling
                 generateButton.disabled = false;
                 generateButton.textContent = '生成图像';
             }
          }
        }, 1000);
      }
    }

    function downloadImage() {
    const generatedImage = document.getElementById('generatedImage');
    let downloadUrl = generatedImage.src; // 获取 Base64 数据
    const filenameInput = document.getElementById('filenameInput');

    // 生成默认文件名，如果输入为空
    let defaultFilename = `image-siliconflow-${Date.now()}`;
    const promptText = document.getElementById('prompt').value.trim();
    if (promptText) {
        defaultFilename = promptText.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').substring(0, 30);
    } else {
        defaultFilename = `image-siliconflow-${Date.now()}`;
    }

    const filename = filenameInput.value.trim() !== '' ? filenameInput.value.trim() : defaultFilename;
    const fileExtension = 'png'; // 强制使用 PNG 扩展名，因为我们处理的是 Base64
    const fullFilename = `${filename}.${fileExtension}`;

    // 检查 downloadUrl 是否是有效的 Base64 数据
    if (downloadUrl && downloadUrl.startsWith('data:image')) {
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = fullFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showNotification("图像已开始下载");
    } else {
        showNotification('没有有效的图像可供下载。', true);
    }
}

    // Notification function
    function showNotification(message, isError = false) {
        const notification = document.createElement('div');
        // Base classes + conditional error class
        notification.className = `notification transform py-2 px-4 rounded-md shadow-lg text-white text-sm z-[1000] transition-all duration-300 ease-out ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-0 translate-y-[-20px]`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Force reflow to enable transition
        void notification.offsetWidth;

        // Fade in and move down
        notification.classList.add('opacity-100', 'translate-y-0');


        setTimeout(() => {
            // Fade out and move up
             notification.classList.remove('opacity-100', 'translate-y-0');
             notification.classList.add('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300); // Wait for fade out transition
        }, 3000); // Notification visible duration
    }


    // Fullscreen functions
    document.getElementById('generatedImage').addEventListener('click', openFullscreen);

    function openFullscreen() {
      const elem = document.getElementById('generatedImage');
      if (!elem.src || elem.src.endsWith('AQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')) return; // Don't fullscreen placeholder

      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.mozRequestFullScreen) { /* Firefox */
        elem.mozRequestFullScreen();
      } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) { /* IE/Edge */
        elem.msRequestFullscreen();
      }
    }

    // No closeFullscreen function needed, browser UI handles it.

    // Random Seed Function
    function randomSeed() {
      const randomNumber = Math.floor(Math.random() * 9999999999);
      document.getElementById('seed').value = randomNumber;
    }

    // Toggle Translate Area
    const toggleTranslateAreaButton = document.getElementById('toggleTranslateArea');
    const translateArea = document.querySelector('.ai-translate-area');
    toggleTranslateAreaButton.addEventListener('click', function() {
      translateArea.classList.toggle('hidden');
      // Change button text based on visibility
       toggleTranslateAreaButton.textContent = translateArea.classList.contains('hidden')
           ? '———显示 翻译&识别区———'
           : '———隐藏 翻译&识别区———';
    });

    // --- Translation & Description Logic ---
    const translate_API_URL = "https://gemini.liyao.sbs/v1/chat/completions";
    let translate_MODEL = "gemini-2.0-flash-exp"; // Default model
    const translate_PROMPT = "Translate the content into English. Respond only with the translated content, and the response must be entirely in English without any other languages.";
    let translate_base64Image = ""; // Base64 for description image
    let translate_API_KEY = localStorage.getItem('gemini_api_key') || ""; // Use a specific key

    document.getElementById("apiKeyInput").value = translate_API_KEY; // Populate Gemini key input

    document.getElementById("modelSelect").addEventListener("change", function() {
      translate_MODEL = this.value;
    });

    // Save Gemini API Key when input changes
    document.getElementById("apiKeyInput").addEventListener('change', function() {
        translate_API_KEY = this.value;
        localStorage.setItem('gemini_api_key', translate_API_KEY);
    });


    async function translateText() {
      const translate_text = document.getElementById("prompt").value;
      const translate_translationResultDiv = document.getElementById("translationResult");
      const translate_loadingIndicator = document.getElementById("translateloadingIndicator");
      // API Key is already updated via event listener

       if (!translate_API_KEY) {
           showNotification('请输入 Gemini API 密钥。', true);
           document.getElementById('apiKeyInput').focus();
           return;
       }
        if (!translate_text) {
            showNotification('请输入需要翻译的内容。', true);
            document.getElementById('prompt').focus();
            return;
        }


      translate_loadingIndicator.style.display = "block";
      translate_translationResultDiv.classList.add("hidden"); // Use classList
      translate_translationResultDiv.innerText = "";

      try {
        const translate_response = await fetch(translate_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${translate_API_KEY}`,
          },
          body: JSON.stringify({
            model: translate_MODEL,
            messages: [
              { role: "system", content: translate_PROMPT },
              { role: "user", content: translate_text }
            ]
          })
        });

        if (!translate_response.ok) {
           let errorMsg = `HTTP error! status: ${translate_response.status}`;
            try {
                const errorData = await translate_response.json();
                errorMsg += ` - ${errorData.error?.message || JSON.stringify(errorData)}`;
            } catch (e) {
                 errorMsg += ` - ${await translate_response.text()}`;
            }
          throw new Error(errorMsg);
        }

        const translate_data = await translate_response.json();
        const translate_translatedText = translate_data.choices[0].message.content;

        translate_translationResultDiv.innerText = translate_translatedText;
        showNotification('翻译完成');

      } catch (error) {
        console.error("翻译出错:", error);
        translate_translationResultDiv.innerText = `翻译出错: ${error.message}`;
        showNotification(`翻译出错: ${error.message}`, true);
      } finally {
        translate_loadingIndicator.style.display = "none";
        translate_translationResultDiv.classList.remove("hidden"); // Use classList
      }
    }

    function fillInput() {
      const translate_translatedText = document.getElementById("translationResult").innerText;
      if (translate_translatedText && !translate_translatedText.startsWith("翻译出错")) {
          document.getElementById("prompt").value = translate_translatedText;
          showNotification("已填入");
      } else if (translate_translatedText.startsWith("翻译出错")) {
           showNotification("无法填入错误信息。", true);
      } else {
           showNotification("没有翻译结果可填入。", true);
      }
    }

    async function pasteText() {
      try {
        const translate_text = await navigator.clipboard.readText();
        document.getElementById("prompt").value = translate_text;
        showNotification("已粘贴");
      } catch (translate_err) {
        console.error('无法读取剪贴板: ', translate_err);
        showNotification('无法读取剪贴板内容。', true);
      }
    }

    function copyText() {
      const translate_text = document.getElementById("prompt").value;
       if (!translate_text) {
           showNotification('提示语为空，无法复制。', true);
           return;
       }
      navigator.clipboard.writeText(translate_text).then(function() {
        showNotification('提示语已复制！');
      }, function(translate_err) {
        console.error('无法复制文本: ', translate_err);
        showNotification('复制失败。', true);
      });
    }

    function previewImage() {
      const translate_file = document.getElementById("imageUpload").files[0];
      const translate_reader = new FileReader();
      const previewElement = document.getElementById("imagePreview");
      const placeholderText = document.querySelector("#imageUploadContainer p");


      translate_reader.onloadend = function() {
        translate_base64Image = translate_reader.result; // Save Base64
        previewElement.src = translate_base64Image;
        previewElement.classList.remove("hidden"); // Use classList
        placeholderText.classList.add("hidden"); // Use classList
      }

      if (translate_file) {
        translate_reader.readAsDataURL(translate_file);
      } else {
        previewElement.src = "#";
        previewElement.classList.add("hidden");
        placeholderText.classList.remove("hidden");
        translate_base64Image = ""; // Clear Base64
      }
    }

    const translate_imageUploadContainer = document.getElementById("imageUploadContainer");

    // Drag and Drop for Description Image
    translate_imageUploadContainer.addEventListener("dragover", function(event) {
      event.preventDefault();
      translate_imageUploadContainer.classList.add("border-blue-400", "bg-blue-50");
    });

    translate_imageUploadContainer.addEventListener("dragleave", function(event) {
      event.preventDefault();
      translate_imageUploadContainer.classList.remove("border-blue-400", "bg-blue-50");
    });

    translate_imageUploadContainer.addEventListener("drop", function(event) {
      event.preventDefault();
      translate_imageUploadContainer.classList.remove("border-blue-400", "bg-blue-50");

      const translate_file = event.dataTransfer.files[0];
       if (translate_file && translate_file.type.startsWith('image/')) {
           document.getElementById("imageUpload").files = event.dataTransfer.files; // Assign dropped files
           previewImage(); // Trigger preview
       } else {
           showNotification("请拖放有效的图片文件。", true);
       }
    });

    async function describeImage() {
      if (!translate_base64Image) {
        showNotification("请先选择要识别的图片！", true);
        return;
      }
       if (!translate_API_KEY) {
           showNotification('请输入 Gemini API 密钥。', true);
           document.getElementById('apiKeyInput').focus();
           return;
       }

      const translate_descriptionPrompt = `# 提示词：AI 文生图提示词助手... [Rest of your long prompt here] ... 仅输出提示词。`; // Keep your prompt
      const translate_loadingIndicator = document.getElementById("translateloadingIndicator"); // Use correct ID
      const translate_translationResultDiv = document.getElementById("translationResult");

      translate_loadingIndicator.style.display = "block";
      translate_translationResultDiv.classList.add("hidden");
      translate_translationResultDiv.innerText = "";

      try {
        const translate_response = await fetch(translate_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${translate_API_KEY}`,
          },
          body: JSON.stringify({
            model: translate_MODEL, // Consider using a vision-capable model if available/different
            messages: [
              {
                role: "user",
                content: [
                  { type: "text", text: translate_descriptionPrompt },
                  { type: "image_url", image_url: { url: translate_base64Image } } // Send full base64 URL
                ]
              }
            ],
             max_tokens: 300 // Limit token usage for description
          })
        });

        if (!translate_response.ok) {
           let errorMsg = `HTTP error! status: ${translate_response.status}`;
            try {
                const errorData = await translate_response.json();
                errorMsg += ` - ${errorData.error?.message || JSON.stringify(errorData)}`;
            } catch (e) {
                 errorMsg += ` - ${await translate_response.text()}`;
            }
          throw new Error(errorMsg);
        }

        const translate_data = await translate_response.json();
        // Check for potential safety blocks or empty responses
        if (!translate_data.choices || translate_data.choices.length === 0 || !translate_data.choices[0].message?.content) {
            console.warn("Gemini response missing content:", translate_data);
            let reason = "未知原因";
            if (translate_data.promptFeedback?.blockReason) {
                reason = `内容被阻止 (${translate_data.promptFeedback.blockReason})`;
            } else if (translate_data.choices?.[0]?.finishReason) {
                 reason = `完成原因: ${translate_data.choices[0].finishReason}`;
            }
            throw new Error(`API 未返回有效描述 (${reason})`);
        }

        const translate_imageDescription = translate_data.choices[0].message.content;
        document.getElementById("prompt").value = translate_imageDescription; // Fill main prompt
        translate_translationResultDiv.innerText = translate_imageDescription; // Show in result area
        showNotification("识别完成");

      } catch (error) {
        console.error("图片识别出错:", error);
        translate_translationResultDiv.innerText = `图片识别出错: ${error.message}`;
        showNotification(`图片识别出错: ${error.message}`, true);
      } finally {
        translate_loadingIndicator.style.display = "none";
        translate_translationResultDiv.classList.remove("hidden");
      }
    }

    function clearAll() {
        // Clear main prompt
        document.getElementById("prompt").value = "";
        // Clear translation/description area
        document.getElementById("translationResult").innerText = "";
        document.getElementById("translationResult").classList.add("hidden");
        // Clear description image preview
        document.getElementById("imagePreview").src = "#";
        document.getElementById("imagePreview").classList.add("hidden");
        document.querySelector("#imageUploadContainer p").classList.remove("hidden");
        translate_base64Image = "";
        document.getElementById("imageUpload").value = ""; // Clear file input
        showNotification("已清除提示语和识别区");
    }


      function showDownloadHelp() {
        alert(
          "如果下载的图像无法打开或显示为损坏，请尝试以下操作：\n\n" +
          "1. 确认文件名：确保您输入的自定义文件名不包含特殊字符（如 / \\ : * ? \" < > |）。\n" +
          "2. 浏览器问题：尝试在不同的浏览器（如 Chrome, Firefox）中下载。\n" +
          "3. 图像查看器：尝试使用不同的图像查看程序打开文件。\n" +
          "4. （旧版 Windows/IE）安全设置：\n" +
          "   - 打开 Internet Explorer -> 工具 -> Internet 选项 -> 安全 -> 自定义级别。\n" +
          "   - 找到“下载” -> “文件下载”，选择“启用”。\n" +
          "   - 找到“杂项” -> “启动应用程序和不安全文件”，选择“提示”。\n" +
          "   - 单击“确定”保存。（注意：修改安全设置有风险）\n\n" +
           "如果问题仍然存在，可能是生成过程中图像数据本身存在问题。"
        );
        return false; // Prevent default link behavior
      }

      function setModelGuidanceScale() {
        const modelSelect = document.getElementById('model');
        const guidanceScaleInput = document.getElementById('guidanceScale');
        const selectedModel = modelSelect.value;

        // Set default guidance scale based on model
        let defaultScale = 2.5; // Default for Kolors and Schnell
        if (selectedModel === "stabilityai/stable-diffusion-xl-base-1.0") {
          defaultScale = 7.0; // Common default for SDXL
        } else if (selectedModel === "stabilityai/stable-diffusion-3-5-large") {
          defaultScale = 4.5; // Common default for SD3
        } else if (selectedModel === "stabilityai/stable-diffusion-2-1") {
          defaultScale = 7.5; // Common default for SD 2.1
        }
        guidanceScaleInput.value = defaultScale;


        // Show/hide AI image upload based on model capability (only Kolors supports it here)
        const supportsImageInput = (selectedModel === "Kwai-Kolors/Kolors");
        aiImageUploadContainer.classList.toggle('hidden', !supportsImageInput);
        aiImageUploadContainerLabel.classList.toggle('hidden', !supportsImageInput);

         // If hiding, also clear the preview
         if (!supportsImageInput) {
             clearAiImage();
         }
      }

      // --- Keyboard Shortcuts ---
      const promptTextarea = document.getElementById('prompt');
      const generateButtonEl = document.getElementById('generateButton'); // Renamed variable

      promptTextarea.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) { // Added !event.isComposing
          event.preventDefault();
          if (!generateButtonEl.disabled) {
            generateButtonEl.click();
          }
        }
      });

      const filenameInput = document.getElementById('filenameInput');
      const downloadButtonEl = document.getElementById('downloadButton'); // Renamed variable

      filenameInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.isComposing) {
          event.preventDefault();
          if (!downloadButtonEl.disabled) {
            downloadButtonEl.click();
          }
        }
      });

       // Initial setup on load
        document.addEventListener('DOMContentLoaded', () => {
            setModelGuidanceScale(); // Set initial guidance scale and visibility
             // Ensure translate area is hidden initially if toggle button exists
             if (toggleTranslateAreaButton && translateArea) {
                 translateArea.classList.add('hidden');
                 toggleTranslateAreaButton.textContent = '———显示 翻译&识别区———';
             }
        });

  </script>

</body>
</html>