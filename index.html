<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI 图像生成器</title>
  <style>
    /* 基本 CSS 重置 */
    body, h1, h2, h3, p, input, select, button, textarea {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      color: #333;
      line-height: 1.6;
      display: flex;
      min-height: 100vh;
      height: 100vh;
      overflow: hidden;
    }
    .params p {
            text-align: center;
            margin-bottom: 10px;
        }
    /* 布局区域 */
    .params {
      width: 25%;
      padding: 20px;
      background-color: #fff;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      scrollbar-width: none;
    }

    .result-area {
      width: 50%;
      padding: 10px;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start; /* 内容顶部对齐 */
      height: 100%;
      overflow-y: auto;
      position: relative;
    }

    .history-area {
      width: 25%;
      padding: 20px;
      background-color: #f9f9f9;
      border-left: 1px solid #ccc;
      overflow-y: auto;
      height: 100%;
    }

    /* 通用样式 */
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #007bff;
    }

    label {
      display: block;
      margin-bottom: 3px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    input::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
      color: #999;
      opacity: 1; /* Firefox */
    }

    input:-ms-input-placeholder { /* Internet Explorer 10-11 */
      color: #999;
    }

    input::-ms-input-placeholder { /* Microsoft Edge */
      color: #999;
    }

    select {
      appearance: none;
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23343a40"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      min-width: fit-content;
      font-weight: bold;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #result {
      text-align: center;
      width: 100%;
      height: 100%; /* 占据整个结果区域高度 */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; /* 垂直居中图像 */
    }

    #generatedImage {
      width: 95%;
      max-height: 90%; /* 调整为按钮留出空间 */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      object-fit: contain;
    }

    #resultButtons {
      display: flex;
      justify-content: center;
      width: 100%; /* 占据整个结果区域宽度 */
      margin-top: 10px;
    }

    #resultText {
      font-size: 16px;
      color: #555;
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      text-align: center; /* 链接居中 */
    }

    #resultText a {
      color: #007bff;
      text-decoration: none;
    }

    #resultText a:hover {
      text-decoration: underline;
    }

    #copyUrlButton {
      background-color: #00aaff;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    #downloadButton {
      background-color: #ffa500;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    #copyUrlButton:hover, #downloadButton:hover {
      background-color: #218838;
    }

    /* 历史记录样式 */
    .image-container {
      padding-right: 10px; /* 添加右侧间距 */
    }

    .text-info-container p {
      margin: 0;
      font-size: 14px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2; /* 显示 2 行 */
      line-clamp: 2;
      -webkit-box-orient: vertical;
      text-overflow: ellipsis;
    }

    .history-item {
      border-bottom: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background-color 0.2s;
      cursor: pointer; /* 添加鼠标指针 */
      position: relative; /* 设置相对定位 */
    }

    .history-item:hover {
      background-color: #e7e7e7;
    }

    .history-item img {
      max-height: 100px;
      border-radius: 4px;
      margin-right: 10px;
      vertical-align: middle;
    }

    .history-item-details {
      flex-grow: 1;
      overflow: hidden;
    }

    .history-item-details p {
      margin: 0;
      font-size: 14px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      text-overflow: ellipsis;
    }

    .delete-button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.3s;
      min-width: fit-content;
      position: absolute;
      top: 5px;
      right: 5px;
    }

    .delete-button:hover {
      background-color: #c82333;
    }

    .seed-container {
      display: flex;
      align-items: center;
    }

    .seed-container input[type="number"] {
      flex-grow: 1;
      margin-right: 5px; /* 输入框和按钮之间的间距 */
    }

    .seed-container button {
      background-color: #4CAF50; /* 绿色 */
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      white-space: nowrap;
      padding: 4px 12px; /* 设置内边距为 4px 12px */
      min-width: fit-content;
    }

    .seed-container button:hover {
      background-color: #367c39;
    }

    .image-upload-container {
      display: flex;
      align-items: center; /* 垂直对齐标签和按钮 */
      justify-content: space-between;
      min-height: fit-content;
      max-width: 100%;
    }

    .image-upload-container p {
      margin-bottom: 0; /* 移除底部边距 */
      flex-grow: 1;  /* 标签占据剩余空间 */
      text-align: center; /* 水平居中 */
      color: gray; /* 设置灰色字 */
    }

    .image-upload-container label {
      margin-bottom: 0; /* 移除底部边距 */
      flex-grow: 1;  /* 标签占据剩余空间 */
    }

    /* 响应式设计 - 调整小屏幕上的列布局 */
    @media screen and (max-width: 1200px) {
      h1 {
        font-size: 24px;
        margin-bottom: 0;
      }      
    }
    @media (max-width: 800px) {
      body {
        flex-direction: column;
        height: auto;
        overflow: auto;
      }

      .params, .result-area, .history-area {
        width: calc(100% - 30px); /* 减去左右边距 */
        height: auto;
        border: none;
        padding: 15px;
      }

      .params {
        border-bottom: 1px solid #ccc;
      }

      .result-area {
        border-bottom: 1px solid #ccc;
      }
    }
    
    #toggleTranslateArea {
      background-color: white;
      color: #ccc;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.3s;
      margin-bottom: 10px;
    }

    .ai-translate-area {
      display: none; /* 默认隐藏 */
      margin-bottom: 10px;
      background-color: #f1f1f1;
      border-radius: 8px;
      padding: 4px 8px 8px;
    }

    #translationResult {
      display: none;
      font-size: 12px;
      font-family: monospace;
      background-color: #f9f9f9;
      padding: 4px;
      margin-bottom: 10px;
      border-radius: 5px;
    }

    #loadingIndicator {
      display: none;
      font-style: italic;
      color: #ffffff;
      z-index: 1000;
      position: absolute; /* 绝对定位 */
      top: 50%; /* 垂直居中 */
      left: 50%; /* 水平居中 */
      transform: translate(-50%, -50%); /* 精确居中 */
      background-color: rgba(0, 0, 0, 0.6);
      padding: 10px 20px;
      border-radius: 5px;
    }

    .button-container {
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      gap: 4px;
    }

    #apiKeyInput {
      margin: 0;
    }

    .model-select-container {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: center; /* 垂直居中 */
    }

    .model-select-container select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .image-upload-container {
      margin: 0 auto;
      border: 2px dashed #ccc;
      padding: 8px;
      border-radius: 8px;
      max-width: 100%;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      min-height: 100px;
    }

    .image-upload-container input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    #imagePreview {
      max-width: 100%;
    }

    .clear-button {
      background-color: #f44336; /* 红色 */
      margin-left: 4px;
    }

    .clear-button:hover {
      background-color: #da190b;
    }

    /* 添加在style标签内 */
    .copy-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .copy-notification.show {
      opacity: 1;
    }

        /* 跳跃点动画 (Bounce Dots Spinner) CSS */
        .spinner-bounce-dots {
      display: inline-block; /* 或者 block，根据您的布局需要 */
      width: auto; /* 让宽度自适应内容 */
      height: 20px;
      text-align: center; /* 水平居中 dots */
      margin-bottom: 10px; /* 与文字指示器保持间距, 如果不需要文字 "正在生成..." 可以移除 */
    }

    .spinner-bounce-dots .dot {
      width: 10px; /* 点的大小 */
      height: 10px;
      background-color: #007bff; /* 点的颜色，可修改 */
      border-radius: 50%;
      display: inline-block;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .spinner-bounce-dots .dot1 {
      animation-delay: -0.32s;
    }

    .spinner-bounce-dots .dot2 {
      animation-delay: -0.16s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
      }  40% {
        transform: scale(1.0);
      }
    }

  </style>
</head>
<body>
  <div class="params">
    <h1>AI 图像生成器</h1>
    <p>
      <a href="./edit.html" style="margin-bottom: 10px; font-size: 14px; color: #007bff; text-decoration: none;">Gemini对话生图编辑</a>
      |
      <a href="./together.html" style="margin-bottom: 10px; font-size: 14px; color: #007bff; text-decoration: none;">Tegether AI</a>
    </p>
    <label for="apiKey">API 密钥:</label>
    <a href="https://cloud.siliconflow.cn/account/ak" target="_blank" rel="noreferrer" style="color: #00aaff; font-size:small; text-decoration: none;">获取 硅基流动 API密钥</a>
    <input type="text" id="apiKey" placeholder="你的 API 密钥">

    <label for="model">模型:</label>
    <select id="model" onchange="setModelGuidanceScale()">
      <option value="Kwai-Kolors/Kolors">Kwai-Kolors/Kolors</option>
      <option value="black-forest-labs/FLUX.1-schnell">black-forest-labs/FLUX.1-schnell</option>
      <option value="stabilityai/stable-diffusion-xl-base-1.0">stabilityai/stable-diffusion-xl-base-1.0</option>
      <option value="stabilityai/stable-diffusion-3-5-large">stabilityai/stable-diffusion-3-5-large(很慢)</option>
      <option value="stabilityai/stable-diffusion-2-1">stabilityai/stable-diffusion-2-1</option>
      <option value="black-forest-labs/FLUX.1-dev">black-forest-labs/FLUX.1-dev(付费)</option>
    </select>

    <script>
      function setModelGuidanceScale() {
        const model = document.getElementById('model').value;
        if (model === "stabilityai/stable-diffusion-xl-base-1.0") {
          document.getElementById('guidanceScale').value = "7";
        } else if (model === "stabilityai/stable-diffusion-3-5-large") {
          document.getElementById('guidanceScale').value = "3.5";
        } else if (model === "stabilityai/stable-diffusion-2-1") {
          document.getElementById('guidanceScale').value = "20";
        } else if (model === "Kwai-Kolors/Kolors") {
          document.getElementById('guidanceScale').value = "2.5";
        } 
      }
    </script>

    <label for="prompt">提示语:</label>
    <textarea id="prompt" placeholder="请输入提示词" style="min-height:60px; resize: none;"></textarea>
    <div class="button-container">
      <button onclick="pasteText()">粘贴</button>
      <button onclick="copyText()">复制</button>
      <button onclick="clearAll()" class="clear-button">清除</button>
    </div>
    <button type="button" id="toggleTranslateArea">———显示/隐藏 翻译&识别区———</button>
    <div class="ai-translate-area">
      <label for="apiKeyInput">Gemini API 密钥:</label><a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" style="color: #00aaff; font-size:small; text-decoration: none;">申请 Gemini API密钥</a>
      <input type="text" id="apiKeyInput" placeholder="请输入 Gemini API Key">

      <div class="model-select-container">
        <select id="modelSelect">
          <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
          <option value="gemini-2.0-flash">gemini-2.0-flash</option>
          <option value="gemini-2.0-flas-001">gemini-2.0-flas-001</option>
          <option value="gemini-2.0-flash-thinking-exp">gemini-2.0-flash-thinking-exp</option>
          <option value="gemini-2.0-flash-thinking-exp-1219">gemini-2.0-flash-thinking-exp-1219</option>
          <option value="gemini-2.0-flash-thinking-exp-01-21">gemini-2.0-flash-thinking-exp-01-21</option>
          <option value="gemini-2.0-flash-lite-preview-02-05">gemini-2.0-flash-lite-preview-02-05</option>
          <option value="gemini-2.0-flash-lite-preview">gemini-2.0-flash-lite-preview</option>
          <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
          <option value="gemini-2.0-pro-exp-02-05">gemini-2.0-pro-exp-02-05</option>
          <option value="gemini-2.0-pro-exp">gemini-2.0-pro-exp</option>
          <option value="gemini-exp-1206">gemini-exp-1206</option>
          <option value="gemini-2.0-flash-exp-image-generation">gemini-2.0-flash-exp-image-generation</option>
          <option value="gemma-3-27b-it">gemma-3-27b-it</option>
        </select>
      </div>

      <div id="translateloadingIndicator" style="display: none;">
        <div class="spinner-bounce-dots">
          <div class="dot dot1"></div>
          <div class="dot dot2"></div>
          <div class="dot dot3"></div>
        </div>
      </div>
      <div id="translationResult"></div>

      <div class="button-container">
        <button onclick="translateText()">翻译 / 重新翻译</button>
        <button onclick="fillInput()" style="background-color: #ffa500;">填入</button>
        <button onclick="describeImage()">识别</button>
      </div>

      <div class="image-upload-container" id="imageUploadContainer">
        <input type="file" id="imageUpload" accept="image/*" onchange="previewImage()">
        <p>拖放或点击选择图片</p>
        <img id="imagePreview" src="#" alt="图片预览" style="display: none;">
      </div>
    </div>
    <label for="negativePrompt">负面提示语:</label>
    <input type="text" id="negativePrompt" placeholder="请输入负面提示词" value="bad quality, low quality, deformed, distorted, bad proportions, ugly">
    <label for="imageSize">图像尺寸（宽×高）：</label>
    <select id="imageSize">
      <option value="720x1280">默认720x1280 (9:16)</option>
      <option disabled>————方图————</option>
      <option value="512x512">512x512 (1:1)</option>
      <option value="1024x1024">1024x1024 (1:1)</option>
      <option value="1280x1280">1280x1280 (1:1)</option>
      <option value="1440x1440">1440x1440 (1:1)</option>
      <option value="1600x1600">1600x1600 (1:1)</option>
      <option value="1792x1792">1792x1792 (1:1)</option>
      <option value="2048x2048">2048x2048 (1:1)</option>
      <option disabled>————竖图————</option>
      <option value="480x640">480x640 (3:4)</option>
      <option value="600x800">600x800 (3:4)</option>
      <option value="768x1024">768x1024 (3:4)</option>
      <option value="540x960">540x960 (9:16 qHD)</option>
      <option value="720x1280">720x1280 (9:16 HD)</option>
      <option value="900x1600">900x1600 (9:16 HD+)</option>
      <option value="1080x1920">1080x1920 (9:16 FHD)</option>
      <option disabled>————横图————</option>
      <option value="640x480">640x480 (4:3 VGA)</option>
      <option value="800x600">800x600 (4:3 SVGA)</option>
      <option value="1024x768">1024x768 (4:3 XGA)</option>
      <option value="960x540">960x540 (16:9 qHD)</option>
      <option value="1280x720">1280x720 (16:9 HD)</option>
      <option value="1600x900">1600x900 (16:9 HD+)</option>
      <option value="1920x1080">1920x1080 (16:9 FHD)</option>
    </select>

    <label for="numInferenceSteps">推理步数 (1-50):</label>
    <input type="number" id="numInferenceSteps" value="50" min="1" max="50">

    <label for="guidanceScale">引导比例 (0-20):</label>
    <input type="number" id="guidanceScale" value="2.5" min="0" max="20" step="0.1">

    <label for="seed">种子 (0-9999999999):</label>
    <div class="seed-container">
      <input type="number" id="seed" min="0" max="9999999999">
      <button type="button" onclick="randomSeed()">随机</button>
    </div>

    <button id="generateButton" onclick="generateImage()" style="font-size: 14px; font-weight: bold; padding: 8px 16px;">生成图像</button>
  </div>

  <div class="result-area">
    <div id="result">
      <img id="generatedImage" src="https://api.yujn.cn/api/gzl_ACG.php?type=image&form=pe" alt="生成的图像">
      <div id="resultButtons">
        <div class="download-container" style="display: flex; justify-content: center;">
          <input type="text" id="filenameInput" placeholder="自定义文件名" style="margin-right: 5px;">
          <button onclick="downloadImage()" id="downloadButton" style="padding: 8px 8px; height: fit-content; margin-right: 5px;" disabled>下载图像</button>
        </div>
        <a href="#" onclick="showDownloadHelp()" style="font-size: small;text-decoration: none; color: #007bff; align-self: center;">下载图像无法打开？</a>
        <button id="copyUrlButton" onclick="copyImageUrl()" style="padding: 8px 8px; height: fit-content;">复制 URL</button>
      </div>
      <p id="resultText">
        <a href="#" id="imageUrlLink" target="_blank" rel="noreferrer" title="点击跳转"></a>
      </p>
    </div>
    <div id="loadingIndicator" style="display: none;"> <!-- 初始状态隐藏，JS控制显示 -->
      <div class="spinner-bounce-dots">
        <div class="dot dot1"></div>
        <div class="dot dot2"></div>
        <div class="dot dot3"></div>
      </div>
    </div>
  </div>

  <div class="history-area">
    <div id="history">
      <h2>历史记录:</h2>
      <div>
        <button type="button" id="selectAllButton" onclick="toggleSelectAll()" style="padding: 4px 8px;">全选</button>
        <button type="button" id="deleteSelectedButton" onclick="deleteSelectedHistoryItems()" style="padding: 4px 8px; background-color: #c82333;">删除选中</button>
      </div>
      <div id="historyList"></div>
      </div>    
  </div>

  <script>
    // Local Storage Keys
    const API_KEY_KEY = 'apiKey';
    const IMAGE_HISTORY_KEY = 'imageHistory';
    const DB_NAME = 'imageGeneratorDB';
    const DB_VERSION = 1;
    const OBJECT_STORE_NAME = 'imageHistoryStore';

    let db; // IndexedDB 数据库对象

    // 初始化 IndexedDB
    function initIndexedDB() {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = function(event) {
        console.error('IndexedDB 打开失败:', event.target.error);
      };

      request.onsuccess = function(event) {
        db = event.target.result;
        console.log('IndexedDB 打开成功');
        displayHistory(); // 初始化时显示历史记录
      };

      request.onupgradeneeded = function(event) {
        const db = event.target.result;

        // 创建对象存储，如果它还不存在
        if (!db.objectStoreNames.contains(OBJECT_STORE_NAME)) {
          const objectStore = db.createObjectStore(OBJECT_STORE_NAME, { keyPath: 'id', autoIncrement: true });
          console.log('对象存储创建成功');
        }
      };
    }

    // 页面加载时初始化 IndexedDB
    window.addEventListener('load', initIndexedDB);

    // Load API Key from local storage on page load
    document.getElementById('apiKey').value = localStorage.getItem(API_KEY_KEY) || '';

    // Function to save API Key to local storage
    function saveApiKey(apiKey) {
      localStorage.setItem(API_KEY_KEY, apiKey);
    }

    // Function to convert URL image to Base64
    function urlToBase64(url) {
      return new Promise((resolve, reject) => {
        fetch(url)
          .then(response => response.blob())
          .then(blob => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          })
          .catch(reject);
      });
    }

    // Function to save to IndexedDB
    async function saveHistory(data) {
      try {
        const base64Image = await urlToBase64(data.imageUrl);
        const now = new Date();
        const creationTime = `${now.getFullYear().toString().slice(-2)}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

        const tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');
        const store = tx.objectStore(OBJECT_STORE_NAME);

        const item = {
          prompt: data.prompt,
          negativePrompt: data.negativePrompt,
          imageSize: data.imageSize,
          numInferenceSteps: data.numInferenceSteps,
          guidanceScale: data.guidanceScale,
          seed: data.seed,
          imageData: base64Image, // 存储 Base64 字符串
          creationTime: creationTime
        };

        store.add(item);

        tx.oncomplete = () => {
          console.log('数据保存到 IndexedDB 成功');
          displayHistory();
        };

        tx.onerror = (event) => {
          console.error('保存数据到 IndexedDB 失败:', event.target.error);
        };
      } catch (error) {
        console.error('转换 URL 到 Base64 失败:', error);
      }
    }

    // Function to display history from IndexedDB
    function displayHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = ''; // 清空现有列表

      if (!db) {
        console.warn('IndexedDB 未初始化');
        return;
      }

      const tx = db.transaction(OBJECT_STORE_NAME, 'readonly');
      const store = tx.objectStore(OBJECT_STORE_NAME);
      const request = store.getAll();

      request.onsuccess = (event) => {
        let history = event.target.result;

        // 反转历史记录数组，先显示最新的记录
        history = history.reverse();

        history.forEach((item, index) => {
          const historyItem = document.createElement('div');
          historyItem.classList.add('history-item');

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = item.id; // 使用 id 作为 checkbox 的值
          checkbox.style.marginRight = '5px';
          historyItem.appendChild(checkbox);

          // 创建图像容器
          const imageContainer = document.createElement('div');
          imageContainer.classList.add('image-container');
          let imageElement = document.createElement('img');
          imageElement.src = item.imageData; // 使用 Base64 字符串
          imageElement.alt = "历史图像";
          imageContainer.appendChild(imageElement);
          historyItem.appendChild(imageContainer);

          // 创建文本信息容器
          const textInfoContainer = document.createElement('div');
          textInfoContainer.classList.add('text-info-container');

          const promptElement = document.createElement('p');
          promptElement.textContent = item.prompt;
          textInfoContainer.appendChild(promptElement);

          const creationTimeElement = document.createElement('p');
          creationTimeElement.textContent = item.creationTime;
          textInfoContainer.appendChild(creationTimeElement);

          historyItem.appendChild(textInfoContainer);

          const deleteButton = document.createElement('button');
          deleteButton.classList.add('delete-button');
          deleteButton.textContent = '×';
          deleteButton.addEventListener('click', (event) => {
            event.stopPropagation();
            deleteHistoryItem(item.id); // 使用 id 删除
          });

          historyItem.appendChild(deleteButton);
          historyItem.addEventListener('click', () => populateForm(item));
          historyList.appendChild(historyItem);
        });
      };

      request.onerror = (event) => {
        console.error('从 IndexedDB 读取历史记录失败:', event.target.error);
      };
    }

    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('#historyList input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
      checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
      });
    }

    function deleteSelectedHistoryItems() {
      const checkboxes = document.querySelectorAll('#historyList input[type="checkbox"]:checked');
      const idsToDelete = Array.from(checkboxes)
        .map(checkbox => parseInt(checkbox.value));

      if (idsToDelete.length === 0) {
        showNotification('请选择要删除的项。', true);
        return;
      }

      const tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');
      const store = tx.objectStore(OBJECT_STORE_NAME);

      idsToDelete.forEach(id => {
        store.delete(id);
      });

      tx.oncomplete = () => {
        console.log('成功删除选定的历史记录项');
        displayHistory();
        showNotification('成功删除选定的历史记录项');
      };

      tx.onerror = (event) => {
        console.error('删除选定的历史记录项失败:', event.target.error);
        showNotification('删除选定的历史记录项失败', true);
      };
    }

    // Function to delete a history item from IndexedDB
    function deleteHistoryItem(id) {
      const tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');
      const store = tx.objectStore(OBJECT_STORE_NAME);
      const request = store.delete(id);

      request.onsuccess = () => {
        console.log('成功删除历史记录项', id);
        displayHistory();
        showNotification('成功删除历史记录项');
      };

      request.onerror = (event) => {
        console.error('删除历史记录项失败:', event.target.error);
        showNotification('删除历史记录项失败', true);
      };
    }

    // Function to populate the form and display the image
    function populateForm(item) {
      document.getElementById('prompt').value = item.prompt;
      document.getElementById('negativePrompt').value = item.negativePrompt || '';
      document.getElementById('imageSize').value = item.imageSize;
      document.getElementById('numInferenceSteps').value = item.numInferenceSteps;
      document.getElementById('guidanceScale').value = item.guidanceScale;
      document.getElementById('seed').value = item.seed || '';

      document.getElementById('generatedImage').src = item.imageData; // 使用 Base64 
      // 使用 Base64 字符串
      document.getElementById('imageUrlLink').href = item.imageData; // 也可以将 Base64 字符串作为链接
      document.getElementById('imageUrlLink').textContent = 'Base64 Image Data';

      // Enable the download button
      document.getElementById('downloadButton').disabled = false;
      showNotification("已填入");
    }

    async function generateImage() {
      const apiKey = document.getElementById('apiKey').value;
      const model = document.getElementById('model').value;
      const prompt = document.getElementById('prompt').value;
      const negativePrompt = document.getElementById('negativePrompt').value;
      const imageSize = document.getElementById('imageSize').value;
      const numInferenceSteps = parseInt(document.getElementById('numInferenceSteps').value);
      const guidanceScale = parseFloat(document.getElementById('guidanceScale').value);
      const seed = parseInt(document.getElementById('seed').value);
      const generateButton = document.getElementById('generateButton');

      // Disable the generate button
      generateButton.disabled = true;
      let countdown = 10;
      generateButton.textContent = `生成中 (${countdown}s)`;

      // Save API key to local storage
      saveApiKey(apiKey);

      const loadingIndicatorElement = document.getElementById('loadingIndicator'); // 获取 loadingIndicator 元素
      loadingIndicatorElement.style.display = "block";

      const apiUrl = 'https://api.siliconflow.cn/v1/images/generations'; // 替换为你的 API 端点

      const data = {
        model: model,
        prompt: prompt,
        negative_prompt: negativePrompt || undefined, // 只有当不为空时才包含
        image_size: imageSize,
        batch_size: 1, // 固定为 1。不再使用输入。
        num_inference_steps: numInferenceSteps,
        guidance_scale: guidanceScale,
        seed: seed || undefined, // 只有当不为空时才包含
      };

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`, // Add "Bearer " to the API key
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`HTTP 错误! 状态: ${response.status}`);
        }

        const result = await response.json();

        if (result.images && result.images.length > 0) {
          const imageUrl = result.images[0].url;
          const base64Image = await urlToBase64(imageUrl); // 转换为 Base64

          document.getElementById('generatedImage').src = base64Image; // 显示 Base64
          document.getElementById('imageUrlLink').href = base64Image;
          document.getElementById('imageUrlLink').textContent = 'Base64 Image Data'; // 更改文本

          // Save history
          await saveHistory({
            prompt: prompt,
            negativePrompt: negativePrompt,
            imageSize: imageSize,
            numInferenceSteps: numInferenceSteps,
            guidanceScale: guidanceScale,
            seed: seed,
            imageUrl: imageUrl // 仍然保存 URL，虽然不直接使用
          });

          // Enable the download button
          document.getElementById('downloadButton').disabled = false;
          showNotification("图像生成成功!");
        } else {
          document.getElementById('generatedImage').src = 'https://img.liyao.sbs/file/1738502727198.png';
          document.getElementById('imageUrlLink').href = '#';
          document.getElementById('imageUrlLink').textContent = '无图像 URL';

          // Disable the download button
          document.getElementById('downloadButton').disabled = true;
        }
      } catch (error) {
        console.error('错误:', error);
        document.getElementById('generatedImage').src = 'https://img.liyao.sbs/file/1738502727198.png';
        document.getElementById('imageUrlLink').href = '#';
        document.getElementById('imageUrlLink').textContent = '无图像 URL';

        // Disable the download button
        document.getElementById('downloadButton').disabled = true;
        showNotification("图像生成失败!", true);
      } finally {
        loadingIndicatorElement.style.display = "none";
        // Re-enable button after 10 seconds
        const countdownInterval = setInterval(() => {
          countdown--;
          generateButton.textContent = `请稍后 (${countdown}s)`;
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            generateButton.disabled = false;
            generateButton.textContent = '生成图像';
          }
        }, 1000);
      }
    }

    function downloadImage() {
        const generatedImage = document.getElementById('generatedImage');
        let downloadUrl = generatedImage.src;
        const filenameInput = document.getElementById('filenameInput');
        const filename = filenameInput.value.trim() !== '' ? filenameInput.value.trim() : 'together'; // 获取文件名，如果为空则使用默认文件名
        const fileExtension = 'png'; // 文件扩展名
        const fullFilename = `${filename}.${fileExtension}`; // 完整文件名

        if (downloadUrl) {
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = fullFilename;  // 使用完整文件名
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showNotification("图像已开始下载");
        } else {
            showNotification('请先生成图像。', true);
        }
    }

    function copyImageUrl() {
      const imageUrl = document.getElementById('imageUrlLink').textContent;
      navigator.clipboard.writeText(imageUrl)
        .then(() => {
          showNotification('Base64 数据已复制到剪贴板！');
        })
        .catch(err => {
          console.error('复制 Base64 失败: ', err);
          showNotification('复制失败，请手动复制', true);
        });
    }

    // 新增的通知函数
    function showNotification(message, isError = false) {
      const notification = document.createElement('div');
      notification.className = 'copy-notification show';
      notification.textContent = message;
      
      if (isError) {
        notification.style.backgroundColor = '#dc3545';
      }

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 2000);
    }


    // Fullscreen functions
    document.getElementById('generatedImage').addEventListener('click', openFullscreen);

    function openFullscreen() {
      const generatedImage = document.getElementById('generatedImage');
      if (generatedImage.src) {
        if (generatedImage.requestFullscreen) {
          generatedImage.requestFullscreen();
        } else if (generatedImage.mozRequestFullScreen) { /* Firefox */
          generatedImage.mozRequestFullScreen();
        } else if (generatedImage.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
          generatedImage.webkitRequestFullscreen();
        } else if (generatedImage.msRequestFullscreen) { /* IE/Edge */
          generatedImage.msRequestFullscreen();
        }
      }
    }

    function closeFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) { /* Firefox */
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) { /* IE/Edge */
        document.msExitFullscreen();
      }
    }

    // Random Seed Function
    function randomSeed() {
      const randomNumber = Math.floor(Math.random() * 9999999999);
      document.getElementById('seed').value = randomNumber;
    }

    // Initial display of history on page load
    // displayHistory(); // 移动到 IndexedDB 初始化成功后

    // 获取按钮和翻译区域的元素
    const toggleTranslateAreaButton = document.getElementById('toggleTranslateArea');
    const translateArea = document.querySelector('.ai-translate-area');

    // 添加点击事件监听器
    toggleTranslateAreaButton.addEventListener('click', function() {
      // 切换翻译区域的显示状态
      if (translateArea.style.display === 'none') {
        translateArea.style.display = 'block';
      } else {
        translateArea.style.display = 'none';
      }
    });

    const translate_API_URL = "https://gemini.liyao.sbs/v1/chat/completions";
    let translate_MODEL = "gemini-2.0-flash-exp"; // 默认模型
    const translate_PROMPT = "Translate the content into English. Respond only with the translated content, and the response must be entirely in English without any other languages.";

    let translate_base64Image = ""; // 用于存储Base64编码的图片
    let translate_API_KEY = localStorage.getItem('openrouter_api_key') || ""; // 从 localStorage 获取 API Key

    // 页面加载时，将 API Key 填入输入框
    document.getElementById("apiKeyInput").value = translate_API_KEY;

    // 监听模型选择的变化
    document.getElementById("modelSelect").addEventListener("change", function() {
      translate_MODEL = this.value;
    });

    async function translateText() {
      const translate_text = document.getElementById("prompt").value;
      const translate_translationResultDiv = document.getElementById("translationResult");
      const translate_loadingIndicator = document.getElementById("translateloadingIndicator");
      translate_API_KEY = document.getElementById("apiKeyInput").value; // 获取 API Key
      translate_loadingIndicator.style.display = "block";
      translate_translationResultDiv.style.display = "none";
      translate_translationResultDiv.innerText = "";

      try {
        const translate_response = await fetch(translate_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${translate_API_KEY}`,
            "HTTP-Referer": "http://localhost:3000", // Replace with your actual domain or localhost
            "X-Title": "My Translation App" // Replace with your app name
          },
          body: JSON.stringify({
            model: translate_MODEL,
            messages: [
              {
                role: "system",
                content: translate_PROMPT
              },
              {
                role: "user",
                content: translate_text
              }
            ]
          })
        });

        if (!translate_response.ok) {
          throw new Error(`HTTP error! status: ${translate_response.status}`);
        }

        const translate_data = await translate_response.json();
        const translate_translatedText = translate_data.choices[0].message.content;

        translate_translationResultDiv.innerText = translate_translatedText;

        // 缓存 API Key
        localStorage.setItem('openrouter_api_key', translate_API_KEY);
        showNotification('翻译完成');

      } catch (error) {
        console.error("翻译出错:", error);
        translate_translationResultDiv.innerText = "翻译出错，请稍后再试。";
        showNotification("翻译出错，请稍后再试。", true);
      } finally {
        translate_loadingIndicator.style.display = "none";
        translate_translationResultDiv.style.display = "block";
      }
    }

    function fillInput() {
      const translate_translatedText = document.getElementById("translationResult").innerText;
      document.getElementById("prompt").value = translate_translatedText;
      showNotification("已填入");
    }

    async function pasteText() {
      try {
        const translate_text = await navigator.clipboard.readText();
        document.getElementById("prompt").value = translate_text;
        showNotification("已粘贴");
      } catch (translate_err) {
        console.error('Failed to read clipboard contents: ', translate_err);
        showNotification('无法读取剪贴板内容，请确保浏览器允许访问剪贴板。', true);
      }
    }

    function copyText() {
      const translate_text = document.getElementById("prompt").value;
      navigator.clipboard.writeText(translate_text).then(function() {
        showNotification('内容已复制到剪贴板！');
      }, function(translate_err) {
        console.error('Failed to copy text to clipboard: ', translate_err);
        showNotification('复制到剪贴板失败，请确保浏览器允许访问剪贴板。', true);
      });
    }

    function previewImage() {
      const translate_file = document.getElementById("imageUpload").files[0];
      const translate_reader = new FileReader();

      translate_reader.onloadend = function() {
        translate_base64Image = translate_reader.result; // 保存Base64编码
        document.getElementById("imagePreview").src = translate_base64Image;
        document.getElementById("imagePreview").style.display = "block";
        document.querySelector("#imageUploadContainer p").style.display = "none"; // 隐藏提示文字
      }

      if (translate_file) {
        translate_reader.readAsDataURL(translate_file);
      } else {
        document.getElementById("imagePreview").src = "#";
        document.getElementById("imagePreview").style.display = "none";
        document.querySelector("#imageUploadContainer p").style.display = "block"; // 显示提示文字
        translate_base64Image = ""; // 清空Base64编码
      }
    }

    const translate_imageUploadContainer = document.getElementById("imageUploadContainer");

    // 拖放事件
    translate_imageUploadContainer.addEventListener("dragover", function(event) {
      event.preventDefault();
      translate_imageUploadContainer.style.backgroundColor = "#eee";
    });

    translate_imageUploadContainer.addEventListener("dragleave", function(event) {
      event.preventDefault();
      translate_imageUploadContainer.style.backgroundColor = "";
    });

    translate_imageUploadContainer.addEventListener("drop", function(event) {
      event.preventDefault();
      translate_imageUploadContainer.style.backgroundColor = "";

      const translate_file = event.dataTransfer.files[0];
      document.getElementById("imageUpload").files = event.dataTransfer.files; // 兼容拖拽
      previewImage();
    });

    async function describeImage() {
      if (!translate_base64Image) {
        alert("请先选择图片！");
        return;
      }

      const translate_descriptionPrompt = `# 提示词：图片识别英文提示词生成助手

**你的定位**：专业的图片识别英文提示词生成助手，用于将图片内容转化为高质量的英文文生图提示词。

**你的能力**：

*   精确分析上传的图片，识别图片中的主体、场景、风格、色彩、构图等关键元素。
*   基于图片内容，生成简洁、清晰、富有表现力的英文文生图提示词。
*   提示词能够准确描述图片的核心内容，并适用于各种主流文生图模型。
*   根据图片风格，选择合适的艺术风格关键词，例如：photorealistic, abstract, impressionistic, cyberpunk 等。

**你的知识储备**：

*   掌握丰富的视觉词汇，能够准确描述各种图像元素。
*   熟悉英文文生图提示词的常用结构和关键词搭配。
*   了解不同艺术风格和摄影技巧的英文表达方式。
*   具备图像识别和理解能力，能够有效提取图片信息。

**使用指南**：

1.  用户上传图片。
2.  你分析图片内容，并生成相应的英文文生图提示词。

**输出要求**：

*   仅输出 Markdown 格式的英文文生图提示词。
*   输出结果不要放在代码块中，不要出现英文文生图提示词以外的任何内容。
*   提示词应详细、精确、易于理解。`;
      const translate_loadingIndicator = document.getElementById("loadingIndicator");
      const translate_translationResultDiv = document.getElementById("translationResult"); // 获取翻译结果的 div
      translate_API_KEY = document.getElementById("apiKeyInput").value; // 获取 API Key
      translate_loadingIndicator.style.display = "block";
      translate_translationResultDiv.style.display = "none";
      translate_translationResultDiv.innerText = ""; // 清空之前的结果
      try {
        const translate_response = await fetch(translate_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${translate_API_KEY}`,
            "HTTP-Referer": "http://localhost:3000", // Replace with your actual domain or localhost
            "X-Title": "My Translation App" // Replace with your app name
          },
          body: JSON.stringify({
            model: translate_MODEL,
            messages: [
              {
                role: "user",
                content: [
                  {
                    "type": "text",
                    "text": translate_descriptionPrompt
                  },
                  {
                    "type": "image_url",
                    "image_url": {
                      "url": translate_base64Image
                    }
                  }
                ]
              }
            ]
          })
        });

        if (!translate_response.ok) {
          throw new Error(`HTTP error! status: ${translate_response.status}`);
        }

        const translate_data = await translate_response.json();
        const translate_imageDescription = translate_data.choices[0].message.content;
        document.getElementById("prompt").value = translate_imageDescription; // 将识别结果填入输入框
        translate_translationResultDiv.innerText = translate_imageDescription; // 将识别结果显示在翻译结果的位置

            // 缓存 API Key
            showNotification("识别完成");
            localStorage.setItem('openrouter_api_key', translate_API_KEY);

          } catch (error) {
            console.error("图片识别出错:", error);
            translate_translationResultDiv.innerText = "图片识别出错，请稍后再试。"; // 错误信息也显示在翻译结果的位置
            showNotification("图片识别出错，请稍后再试。", true);
          } finally {
            translate_loadingIndicator.style.display = "none";
            translate_translationResultDiv.style.display = "block";
          }
        }

      function clearAll() {
        document.getElementById("prompt").value = "";
        document.getElementById("translationResult").innerText = "";
        document.getElementById("imagePreview").src = "#";
        document.getElementById("imagePreview").style.display = "none";
        translate_base64Image = "";
        document.getElementById("imageUpload").value = ""; // 清除文件选择
        document.querySelector("#imageUploadContainer p").style.display = "block"; // 显示提示文字
        document.getElementById("translationResult").style.display = "none";
      }

      function showDownloadHelp() {
        alert(
          "风险提示： 修改 Internet Explorer 安全设置可能会降低系统的安全性，请谨慎操作。\n" +
          "打开 Internet Explorer，选择“工具” -> “Internet 选项” -> “安全” -> “自定义级别”。\n" +
          "在“设置”列表中，找到“下载” -> “文件下载”，选择“启用”。\n" +
          "找到“杂项” -> “启动应用程序和不安全文件”，选择“提示”。\n" +
          "单击“确定”保存设置。"
        );
        return false; // 阻止链接跳转
      }
  </script>

</body>
</html>
