<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Diffusion 3 Medium Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
        .truncate-2-lines {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* number of lines to show */
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
    </style>
</head>

<body class="gradient-bg text-gray-100 min-h-screen">
    <div class="md:flex md:h-screen md:overflow-hidden">
        <!-- Left Panel - Controls (Mobile: full width, Desktop: 1/4 width) -->
        <div class="md:w-1/4 md:overflow-y-auto md:border-r md:border-gray-700 p-4">
            <header class="mb-6">
                <div class="flex items-center justify-center space-x-3 mb-2">
                        <i class="fas fa-robot text-white text-2xl"></i>
                        <h1 class="text-2xl font-bold wrap" onclick="window.location.href='./index.html'">Stable Diffusion 3</h1>
                </div>
                <div class="flex items-center justify-center space-x-2 text-sm text-primary mb-4">
                    <button onclick="window.history.back()" class="text-sm text-primary transition flex items-center"
                        title="返回">
                        <i class="fas fa-arrow-left mr-2"></i>
                    </button>
                    <a href="./edit.html" class="text-sm text-primary transition" title="Edit" target="_blank">
                        <i class="fas fa-edit mr-2"></i>
                    </a>
                    <a href="./together.html" class="text-sm text-primary transition" title="together.ai" target="_blank">
                        <i class="fas fa-exchange-alt mr-2"></i>
                    </a>
                    <a href="./pollinations.html" class="text-sm text-primary transition" title="Pollinations" target="_blank">
                        <i class="fas fa-seedling mr-2"></i>
                    </a>
                    <a href="./stable.html" class="text-sm text-primary transition" title="Stable" target="_blank">
                        <i class="fas fa-tree"></i>
                    </a>
                </div>
            </header>

            <div class="space-y-6">
                <!-- Prompt Section -->
                <div class="flex flex-col items-center">
                    <div class="w-full">
                        <label for="prompt" class="block text-sm font-medium mb-1 flex items-center">
                            <i class="fas fa-comment-dots mr-2 text-primary-400"></i>
                            提示词
                        </label>
                        <textarea id="prompt" rows="3"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all"
                            placeholder="Describe the image you want to generate..." onkeydown="if (event.keyCode == 13) { generateImage(); return false; }"></textarea>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="pasteText()" class="bg-blue-900 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-md transition-all flex items-center space-x-1">
                            <i class="fas fa-paste py-1 px-2"></i><span class="hidden xl:inline ml-2">粘贴</span>
                        </button>
                        <button onclick="copyText()" class="bg-gray-700 hover:bg-gray-600 text-white text-sm py-1 px-3 rounded-md transition-all flex items-center space-x-1" id="copy-prompt-btn">
                            <i class="fas fa-copy py-1 px-2"></i><span class="hidden xl:inline ml-2">复制</span>
                        </button>
                        <button onclick="clearAll()" class="bg-red-900 hover:bg-red-600 text-white text-sm py-1 px-3 rounded-md transition-all flex items-center space-x-1">
                            <i class="fas fa-trash-alt py-1 px-2"></i><span class="hidden xl:inline ml-2">清除</span>
                        </button>
                    </div>   
                </div>

                <!-- Negative Prompt -->
                <div>
                    <label for="negative-prompt" class="block text-sm font-medium mb-1 flex items-center">
                        <i class="fas fa-ban mr-2 text-red-400"></i>
                        负面提示词
                    </label>
                    <textarea id="negative-prompt" rows="2"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all" onkeydown="if (event.keyCode == 13) { generateImage(); return false; }">bad quality, low quality, deformed, distorted, bad proportions, ugly</textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Seed -->
                    <div>
                        <label for="seed" class="block text-sm font-medium mb-1 flex items-center">
                            <i class="fas fa-seedling mr-2 text-yellow-400"></i>
                            种子
                        </label>
                        <div class="relative">
                            <input type="number" id="seed"
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all"
                                placeholder="Random">
                            <button onclick="document.getElementById('seed').value = ''"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Resolution -->
                    <div>
                        <label for="resolution" class="block text-sm font-medium mb-1 flex items-center">
                            <i class="fas fa-expand mr-2 text-blue-400"></i>
                            分辨率
                        </label>
                        <select id="resolution"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all">
                            <option value="720x1280">默认 720x1280 (9:16)</option>
                            <option disabled>──── 方图 ────</option>
                            <option value="512x512">512x512 (1:1)</option>
                            <option value="1024x1024">1024x1024 (1:1)</option>
                            <option value="1280x1280">1280x1280 (1:1)</option>
                            <option value="1440x1440">1440x1440 (1:1)</option>
                            <option value="1600x1600">1600x1600 (1:1)</option>
                            <option value="1792x1792">1792x1792 (1:1)</option>
                            <option value="2048x2048">2048x2048 (1:1)</option>
                            <option disabled>──── 竖图 ────</option>
                            <option value="480x640">480x640 (3:4)</option>
                            <option value="600x800">600x800 (3:4)</option>
                            <option value="768x1024">768x1024 (3:4)</option>
                            <option value="800x1200">800x1200 (3:4)</option>
                            <option value="960x1280">960x1280 (3:4)</option>
                            <option value="1080x1440">1080x1440 (3:4)</option>
                            <option value="1200x1600">1200x1600 (3:4)</option>
                            <option value="540x960">540x960 (9:16 qHD)</option>
                            <option value="720x1280">720x1280 (9:16 HD)</option>
                            <option value="810x1440">810x1440 (9:16 HD+)</option>
                            <option value="900x1600">900x1600 (9:16 HD+)</option>
                            <option value="1080x1920">1080x1920 (9:16 FHD)</option>
                            <option disabled>──── 横图 ────</option>
                            <option value="640x480">640x480 (4:3 VGA)</option>
                            <option value="800x600">800x600 (4:3 SVGA)</option>
                            <option value="1024x768">1024x768 (4:3 XGA)</option>
                            <option value="1280x960">1280x960 (4:3 QXGA)</option>
                            <option value="1440x1080">1440x1080 (4:3 QXGA+)</option>
                            <option value="1600x1200">1600x1200 (4:3 UXGA)</option>
                            <option value="960x540">960x540 (16:9 qHD)</option>
                            <option value="1280x720">1280x720 (16:9 HD)</option>
                            <option value="1440x810">1440x810 (16:9 HD+)</option>
                            <option value="1600x900">1600x900 (16:9 HD+)</option>
                            <option value="1920x1080">1920x1080 (16:9 FHD)</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Tiling -->
                    <div>
                        <label for="tiling" class="block text-sm font-medium mb-1 flex items-center">
                            <i class="fas fa-border-all mr-2 text-purple-400"></i>
                            Tiling
                        </label>
                        <select id="tiling"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all">
                            <option value="false">Disabled</option>
                            <option value="true" selected>Enabled</option>
                        </select>
                    </div>

                    <!-- Guidance Scale -->
                    <div>
                        <label for="guidance" class="block text-sm font-medium mb-1 flex items-center">
                            <i class="fas fa-sliders-h mr-2 text-green-400"></i>
                            引导比例
                        </label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="guidance-range" min="1" max="20" value="5"
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <input type="number" id="guidance" min="1" max="20" value="5"
                                class="w-16 bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm text-center">
                        </div>
                    </div>
                </div>

                <!-- Steps -->
                <div>
                    <label for="steps" class="block text-sm font-medium mb-1 flex items-center">
                        <i class="fas fa-footsteps mr-2 text-cyan-400"></i>
                        步数
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="steps-range" min="1" max="50" value="28"
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <input type="number" id="steps" min="1" max="50" value="28"
                            class="w-16 bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm text-center">
                    </div>
                </div>

                <!-- Generate Button -->
                <button id="generate-btn" onclick="generateImage()"
                    class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-lg transition-all flex items-center justify-center space-x-2">
                    <i class="fas fa-magic"></i>
                    <span>生成图片</span>
                </button>
            </div>
        </div>

        <!-- Right Panel - Results (Mobile: below controls, Desktop: 1/2 width) -->
        <div class="md:w-1/2 md:overflow-y-auto p-4">
            <div
                class="bg-gray-800/50 rounded-xl border border-gray-700 p-4 h-full min-h-[400px] md:min-h-[calc(100vh-48px)] flex flex-col">

                <!-- Image Container -->
                <div id="image-container"
                    class="flex-1 flex items-center justify-center rounded-lg bg-gray-900/50 border-2 border-dashed border-gray-700 relative overflow-hidden">
                    <div id="loading-message"
                        class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-900/80 z-10">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500 mb-4">
                        </div>
                        <p class="text-lg font-medium">Generating your image...</p>
                        <p class="text-sm text-gray-400 mt-1">This may take a few moments</p>
                        <div class="w-full max-w-xs bg-gray-700 rounded-full h-1.5 mt-4">
                            <div id="progress-bar" class="bg-primary-500 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="error-message"
                        class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-900/80 z-10 p-4 text-center">
                        <div class="bg-red-500/20 p-3 rounded-full mb-3">
                            <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                        </div>
                        <p class="text-lg font-medium text-red-400">Error Generating Image</p>
                        <p class="text-sm text-gray-300 mt-1">Please check your prompt and try again</p>
                        <button onclick="document.getElementById('error-message').classList.add('hidden')"
                            class="mt-4 text-sm bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-redo mr-1"></i> Try Again
                        </button>
                    </div>

                    <div id="placeholder" class="text-center p-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-800 mb-4">
                            <i class="fas fa-image text-gray-500 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-300">No image generated yet</h3>
                        <p class="mt-1 text-sm text-gray-500">Enter a prompt and click "Generate Image" to create
                            your first artwork</p>
                    </div>

                    <img id="generated-image" class="hidden w-full h-full object-contain rounded-lg"
                        alt="Generated Image" onerror="handleImageError()">
                </div>

                <!-- Generation Info -->
                <div id="generation-info" class="hidden mt-4 text-xs text-gray-400 space-y-1">
                    <div class="flex justify-between">
                        <span>Seed: <span id="info-seed" class="font-mono">-</span></span>
                        <span>Resolution: <span id="info-resolution" class="font-mono">-</span></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Guidance: <span id="info-guidance" class="font-mono">-</span></span>
                        <span>Steps: <span id="info-steps" class="font-mono">-</span></span>
                    </div>
                </div>
                <div class="flex justify-center items-center mt-4">
                    <div class="flex">
                        <input type="text" id="filenameInput" placeholder="自定义文件名"
                                onkeydown="if (event.keyCode == 13) { downloadImage(); return false; }"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-black">
                        <button onclick="downloadImage()"
                                id="download-btn"
                                class="bg-gray-400 hover:bg-orange-400 text-white font-bold py-2 px-4 rounded-r-md shadow-sm transition-colors flex items-center">
                            <i class="fas fa-download mr-2"></i>
                            <span>下载</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Panel (Desktop: 1/4 width, always visible on desktop) -->
        <div class="md:w-1/4 md:overflow-y-auto md:border-l md:border-gray-700 p-4">
            <h2 class="text-lg font-medium mb-4">历史记录</h2>
            <div id="history-container" class="space-y-4">
                <!-- History items will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const promptTextarea = document.getElementById('prompt');
        const negativePromptTextarea = document.getElementById('negative-prompt');
        const seedInput = document.getElementById('seed');
        const resolutionSelect = document.getElementById('resolution');
        const tilingSelect = document.getElementById('tiling');
        const guidanceRange = document.getElementById('guidance-range');
        const guidanceInput = document.getElementById('guidance');
        const stepsRange = document.getElementById('steps-range');
        const stepsInput = document.getElementById('steps');
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const copyPromptBtn = document.getElementById('copy-prompt-btn');
        const imageContainer = document.getElementById('image-container');
        const generatedImage = document.getElementById('generated-image');
        const placeholder = document.getElementById('placeholder');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const generationInfo = document.getElementById('generation-info');
        const progressBar = document.getElementById('progress-bar');
        const historyContainer = document.getElementById('history-container');

        // Event Listeners
        guidanceRange.addEventListener('input', syncGuidanceInputs);
        guidanceInput.addEventListener('input', syncGuidanceInputs);
        stepsRange.addEventListener('input', syncStepsInputs);
        stepsInput.addEventListener('input', syncStepsInputs);
        copyPromptBtn.addEventListener('click', copyPrompt);

        //IndexDB
        let db;

        // Initialize IndexedDB
        const openDB = () => {
            return new Promise((resolve, reject) => {
                if (!('indexedDB' in window)) {
                    console.error('This browser doesn\'t support IndexedDB');
                    reject('IndexedDB not supported');
                    alert("您的浏览器不支持 IndexDB，历史记录功能无法使用。");
                    return;
                }

                const request = indexedDB.open('SDImageHistoryDB', 1);

                request.onerror = (event) => {
                    console.error("Database open error:", event);
                    console.error("Error details:", event.target.error); // 详细错误信息
                    reject(event);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const objectStore = db.createObjectStore('history', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    objectStore.createIndex('timestamp', 'timestamp', {
                        unique: false
                    });
                    console.log("Database setup completed");
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("Database opened successfully");
                    resolve(db);
                };
            });
        };

        const addToHistory = (params, imageBase64) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['history'], 'readwrite');
                const objectStore = transaction.objectStore('history');

                const historyItem = {
                    params: params,
                    imageBase64: imageBase64, // 保存 base64 字符串
                    timestamp: new Date().getTime()
                };

                const request = objectStore.add(historyItem);

                request.onsuccess = () => {
                    console.log('Added to history', historyItem);
                    resolve();
                };

                request.onerror = (event) => {
                    console.error("Error adding to history:", event);
                    reject(event);
                };
            });
        };

        const loadHistory = () => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['history'], 'readonly');
                const objectStore = transaction.objectStore('history');
                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    const history = event.target.result;
                    resolve(history);
                };

                request.onerror = (event) => {
                    console.error("Error loading history:", event);
                    reject(event);
                };
            });
        };

        const deleteHistoryItem = (id) => {
            const transaction = db.transaction(['history'], 'readwrite');
            const objectStore = transaction.objectStore('history');
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                console.log('Deleted from history', id);
                // Refresh the history display
                loadHistory().then(history => displayHistory(history));
            };

            request.onerror = (event) => {
                console.error("Error deleting from history:", event);
            };
        };

        const displayHistory = (history) => {
            historyContainer.innerHTML = ''; // Clear existing history

            history.sort((a, b) => b.timestamp - a.timestamp);

            history.forEach(item => {
                const historyItemDiv = document.createElement('div');
                historyItemDiv.className =
                    'bg-gray-800 rounded-lg p-4 flex items-center space-x-4 hover:bg-gray-700 transition-colors cursor-pointer relative'; // Add 'relative'
                historyItemDiv.onclick = () => loadFromHistory(item);

                const imagePreview = document.createElement('img');
                imagePreview.src = item.imageBase64;
                imagePreview.alt = 'History Image';
                imagePreview.className = 'w-20 h-20 object-cover rounded-lg';

                const textContainer = document.createElement('div');
                textContainer.className = 'flex-1 min-w-0';

                const promptText = document.createElement('p');
                promptText.textContent = item.params.prompt;
                promptText.className = 'text-sm font-medium text-gray-300 truncate-2-lines';

                const timeText = document.createElement('p');
                const date = new Date(item.timestamp);
                const now = new Date();
                const diff = now.getTime() - date.getTime();
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                let timeDisplay;
                if (days > 0) {
                    timeDisplay = date.toLocaleDateString();
                } else if (hours > 0) {
                    timeDisplay = `${hours} 小时 ${minutes % 60} 分钟前`;
                } else {
                    timeDisplay = `${minutes} 分钟前`;
                }
                timeText.textContent = timeDisplay;
                timeText.className = 'text-xs text-gray-500';

                textContainer.appendChild(promptText);
                textContainer.appendChild(timeText);

                historyItemDiv.appendChild(imagePreview);
                historyItemDiv.appendChild(textContainer);

                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.className =
                    'absolute top-2 right-2 text-gray-500 hover:text-red-500 transition-colors';
                deleteButton.innerHTML = '<i class="fas fa-trash"></i>'; // Use trash icon for delete
                deleteButton.onclick = (event) => {
                    event.stopPropagation(); // Prevent history item click
                    deleteHistoryItem(item.id);
                };
                historyItemDiv.appendChild(deleteButton);

                historyContainer.appendChild(historyItemDiv);
            });
        };

        const loadFromHistory = (item) => {
            // Load parameters
            promptTextarea.value = item.params.prompt;
            negativePromptTextarea.value = item.params.negativePrompt;
            seedInput.value = item.params.seed || '';
            resolutionSelect.value = item.params.resolution;
            tilingSelect.value = item.params.tiling;
            guidanceRange.value = item.params.guidance;
            guidanceInput.value = item.params.guidance;
            stepsRange.value = item.params.steps;
            stepsInput.value = item.params.steps;

            // Display image
            generatedImage.src = item.imageBase64; // 使用保存的 base64 字符串
            generatedImage.classList.remove('hidden');
            placeholder.classList.add('hidden');
            generationInfo.classList.remove('hidden');

            // Update generation info
            const [width, height] = item.params.resolution.split("x").map(Number);
            document.getElementById('info-seed').textContent = item.params.seed || 'random';
            document.getElementById('info-resolution').textContent = `${width}x${height}`;
            document.getElementById('info-guidance').textContent = item.params.guidance;
            document.getElementById('info-steps').textContent = item.params.steps;
        };

        function syncGuidanceInputs(e) {
            if (e.target.id === 'guidance-range') {
                guidanceInput.value = e.target.value;
            } else {
                guidanceRange.value = e.target.value;
            }
        }

        function syncStepsInputs(e) {
            if (e.target.id === 'steps-range') {
                stepsInput.value = e.target.value;
            } else {
                stepsRange.value = e.target.value;
            }
        }

        function downloadImage() {
            if (!generatedImage.src) return;

            // 生成默认文件名
            let defaultFilename = `image-sd3-${Date.now()}`;
            const promptText = promptTextarea.value.trim();
            if (promptText) {
                defaultFilename = promptText.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').substring(0, 30);
            } else {
                defaultFilename = `image-sd3-${Date.now()}`;
            }

            // 使用用户输入的文件名，如果存在，否则使用默认文件名
            const filename = document.getElementById('filenameInput').value.trim() !== '' ? document.getElementById('filenameInput').value.trim() : defaultFilename;

            const link = document.createElement('a');
            link.href = generatedImage.src;
            link.download = `${filename}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyPrompt() {
            if (!promptTextarea.value) return;

            navigator.clipboard.writeText(promptTextarea.value).then(() => {
                const originalText = copyPromptBtn.innerHTML;
                copyPromptBtn.innerHTML = '<i class="fas fa-check py-1 px-2"></i> <span class="ml-2">已复制</span>';
                setTimeout(() => {
                    copyPromptBtn.innerHTML = originalText;
                }, 2000);
            });
        }

        function updateProgress(progress) {
            progressBar.style.width = `${progress}%`;
        }

        async function generateImage() {
            const prompt = promptTextarea.value.trim();
            if (!prompt) {
                alert('Please enter a prompt');
                return;
            }

            // UI State Updates
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> <span>Generating...</span>';
            placeholder.classList.add('hidden');
            generatedImage.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            generationInfo.classList.add('hidden');

            // Simulate progress (in a real app, you'd get this from the API)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 5;
                if (progress > 95) progress = 95;
                updateProgress(progress);
            }, 500);

            try {
                const negativePrompt = document.getElementById("negative-prompt").value;
                const seed = document.getElementById("seed").value === "" ? null : parseInt(document.getElementById("seed").value);
                const resolution = document.getElementById("resolution").value;
                const [width, height] = resolution.split("x").map(Number);
                const tiling = document.getElementById("tiling").value === "true";
                const guidance = parseInt(guidanceInput.value);
                const steps = parseInt(stepsInput.value);

                // Generate a new session hash for each request
                const sessionHash = generateSessionHash();

                const firstResponse = await fetch('https://stabilityai-stable-diffusion-3-medium.hf.space/queue/join', {
                    method: 'POST',
                    headers: {
                        'authority': 'stabilityai-stable-diffusion-3-medium.hf.space',
                        'accept': 'application/json',
                        'content-type': 'application/json',
                        'origin': 'https://stabledifffusion.com',
                        'priority': 'u=1, i',
                        'referer': 'https://stabledifffusion.com/',
                        'sec-fetch-dest': 'empty',
                        'sec-fetch-mode': 'cors',
                        'sec-fetch-site': 'cross-site',
                        'user-agent': navigator.userAgent
                    },
                    body: JSON.stringify({
                        "data": [prompt, negativePrompt, seed, tiling, width, height, guidance, steps],
                        "event_data": null,
                        "fn_index": 1,
                        "trigger_id": 5,
                        "session_hash": sessionHash
                    })
                });

                if (!firstResponse.ok) {
                    throw new Error(`HTTP error! status: ${firstResponse.status}`);
                }

                const firstResponseData = await firstResponse.json();
                const eventId = firstResponseData.event_id;

                // Process the SSE stream
                await processStream(sessionHash);

                // Update generation info
                document.getElementById('info-seed').textContent = seed || 'random';
                document.getElementById('info-resolution').textContent = `${width}x${height}`;
                document.getElementById('info-guidance').textContent = guidance;
                document.getElementById('info-steps').textContent = steps;
                generationInfo.classList.remove('hidden');
            } catch (error) {
                console.error("Error:", error);
            } finally {
                clearInterval(progressInterval);
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> <span>生成图片</span>';

                // Hide error message
                errorMessage.classList.add('hidden');
            }
        }

        async function processStream(sessionHash) {
            return new Promise((resolve, reject) => {
                let eventSource = null;
                let retryTimeout;
                let reconnectAttempts = 0;
                const maxReconnectAttempts = 3;
                const maxTotalTime = 30000; // 30 seconds
                const startTime = Date.now();
                let imageUrlFound = false;
                let resolved = false;
                let initialConnectionAttempted = false;

                const startEventSource = () => {
                    eventSource = new EventSource(`https://stabilityai-stable-diffusion-3-medium.hf.space/queue/data?session_hash=${sessionHash}`);
                    initialConnectionAttempted = true;

                    const resetRetryTimeout = () => {
                        clearTimeout(retryTimeout);
                        retryTimeout = setTimeout(() => {
                            console.log("EventSource timeout, closing and retrying...");
                            if (eventSource && eventSource.readyState !== EventSource.close());
                    startEventSource();
                }, 30000); // 调整超时时间
            };

            eventSource.addEventListener('open', () => {
                console.log('EventSource connected');
                reconnectAttempts = 0;
                resetRetryTimeout();
                errorMessage.classList.add('hidden');
            });

            eventSource.addEventListener('message', async (event) => {
                resetRetryTimeout();

                const data = JSON.parse(event.data);

                if (data && data.msg === "close_stream") {
                    console.log("Received close_stream message. Stopping generation.");
                    loadingMessage.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                        eventSource.close();
                    }

                    if (!resolved) {
                        reject(new Error("Stream closed by server."));
                        resolved = true;
                    }
                    return;
                }

                if (data && data.output && data.output.data && data.output.data[0] && data.output.data[0].url) {
                    const imageUrl = data.output.data[0].url;
                    imageUrlFound = true;
                    loadingMessage.classList.remove('hidden'); // 确保加载动画显示
                    try {
                        const fetchedImageUrl = await tryFetchImageWithRetry(imageUrl, 10, 1000);

                        generatedImage.src = fetchedImageUrl;
                        generatedImage.onload = async () => {
                            // --- Existing code START ---
                            generatedImage.classList.remove('hidden');
                            loadingMessage.classList.add('hidden');
                            updateProgress(100);
                            clearTimeout(retryTimeout);
                            errorMessage.classList.add('hidden'); // 确保成功时错误信息隐藏
                            if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                                eventSource.close();
                            }

                            // Convert image to base64 and store in history
                            const imageBase64 = await convertImageToBase64(fetchedImageUrl);
                            const params = {
                                prompt: promptTextarea.value,
                                negativePrompt: negativePromptTextarea.value,
                                seed: seedInput.value,
                                resolution: resolutionSelect.value,
                                tiling: tilingSelect.value,
                                guidance: guidanceInput.value,
                                steps: stepsInput.value
                            };
                            await addToHistory(params, imageBase64);
                            const history = await loadHistory();
                            displayHistory(history);


                            if (!resolved) {
                                resolve(fetchedImageUrl);
                                resolved = true;
                            }
                            // --- Existing code END ---

                            // ---- ADD THIS LINE ----
                            // Reset the onload handler to prevent it from firing again when loading from history
                            generatedImage.onload = null;
                            // ---- END OF ADDED LINE ----
                        };

                        generatedImage.onerror = (err) => {
                            console.error("Failed to load generated image:", err); // More accurate description
                            loadingMessage.classList.add('hidden');
                            errorMessage.classList.remove('hidden');
                            clearTimeout(retryTimeout);
                            if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                                eventSource.close();
                            }

                            // ---- ADD THESE LINES ----
                            // Also clear onload handler on error
                            generatedImage.onload = null;
                            // Reset onerror to the default handler after this specific load fails
                            generatedImage.onerror = handleImageError;
                            // ---- END OF ADDED LINES ----

                            if (!resolved) {
                                reject(err);
                                resolved = true;
                            }
                        };
                    } catch (err) {
                        console.error("Failed to load image after multiple retries:", err);
                        loadingMessage.classList.add('hidden');
                        errorMessage.classList.remove('hidden');
                        clearTimeout(retryTimeout);
                        if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                            eventSource.close();
                        }

                        if (!resolved) {
                            reject(err);
                            resolved = true;
                        }
                    }
                } else if (data.msg === "estimation" || data.msg === "process_starts" || data.msg === "progress") {
                    if (data.progress_data && data.progress_data.progress !== undefined) {
                        updateProgress(data.progress_data.progress * 100);
                    }
                }
            });

            const handleErrorOrClose = (event) => {
                clearTimeout(retryTimeout);
                if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                    eventSource.close();
                    eventSource = null;
                }

                const elapsedTime = Date.now() - startTime;
                if (elapsedTime >= maxTotalTime || imageUrlFound) {
                    console.warn("Max total time exceeded or URL found. Stopping generation.");
                    loadingMessage.classList.add('hidden');
                    if (!imageUrlFound) {
                        errorMessage.classList.remove('hidden');
                    }
                    if (!resolved) {
                        reject(new Error("Max total time exceeded or URL found. Generation stopped."));
                        resolved = true;
                    }
                    return;
                }

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect EventSource (attempt ${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(startEventSource, 3000);
                } else {
                    console.warn("Max reconnect attempts reached. Stopping reconnection.");
                    loadingMessage.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    if (!resolved) {
                        reject(new Error("Max reconnect attempts reached."));
                        resolved = true;
                    }
                }
            };

            eventSource.addEventListener('error', handleErrorOrClose);
            eventSource.addEventListener('close', handleErrorOrClose);

            setTimeout(() => {
                const elapsedTime = Date.now() - startTime;
                if (elapsedTime >= maxTotalTime || imageUrlFound) {
                    console.warn("Max total time exceeded. Stopping generation.");
                    if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                        eventSource.close();
                    }
                    loadingMessage.classList.add('hidden');
                    if (!imageUrlFound && initialConnectionAttempted) {
                        errorMessage.classList.remove('hidden');
                    }
                    if (!resolved) {
                        reject(new Error("Max total time exceeded. Generation stopped."));
                        resolved = true;
                    }
                }
            }, maxTotalTime);
        };

        startEventSource();
    });
}

async function tryFetchImageWithRetry(imageUrl, maxRetries, initialDelay) {
    let attempts = 0;
    let delay = initialDelay;

    while (attempts < maxRetries) {
        try {
            const response = await fetch(imageUrl);

            if (response.ok) {
                const blob = await response.blob();
                const objectURL = URL.createObjectURL(blob);

                // 确保在成功加载图片后隐藏 error message
                if (!errorMessage.classList.contains('hidden')) {
                    errorMessage.classList.add('hidden');
                }

                generatedImage.src = objectURL; // 设置图片源
                generatedImage.classList.remove('hidden'); // 显示图片
                loadingMessage.classList.add('hidden'); // 隐藏加载信息
                updateProgress(100);

                return objectURL; // 返回本地URL
            } else {
                console.log(`Image fetch failed (attempt ${attempts + 1}/${maxRetries}), status: ${response.status}, retrying in ${delay}ms...`);
            }
        } catch (error) {
            console.error(`Image fetch failed (attempt ${attempts + 1}/${maxRetries}):`, error, `retrying in ${delay}ms...`);
        }

        await new Promise(resolve => setTimeout(resolve, 1000));
    }

    throw new Error("Failed to fetch image after multiple retries.");
}

        function generateSessionHash() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function handleImageError() {
            console.error('Failed to load image:', generatedImage.src);
            generatedImage.src = 'path/to/placeholder.png'; // 仅在加载失败时设置
            // 或者显示错误提示信息
            errorMessage.classList.remove('hidden');
        }
        // Utility function to convert image URL to base64
        const convertImageToBase64 = (url) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.setAttribute('crossOrigin', 'anonymous'); // Enable CORS
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                };
                img.onerror = (error) => {
                    console.error('Error converting image to base64:', error);
                    reject(error);
                };
                img.src = url;
            });
        };

        // Initialize IndexedDB and load history on page load
        (async () => {
            try {
                await openDB();
                const history = await loadHistory();
                displayHistory(history);
            } catch (error) {
                console.error("Initialization error:", error);
            }
        })();

        function pasteText() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('prompt').value = text;
                })
                .catch(err => {
                    console.error('Failed to read clipboard contents: ', err);
                    alert('无法读取剪贴板内容，请确保浏览器允许访问剪贴板。');
                });
        }

        function clearAll() {
            document.getElementById('prompt').value = '';
        }

    </script>
</body>

</html>
