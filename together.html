<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>FLUX Schnell AI 图像生成器 | Together</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AI 图片生成器，使用 FLUX Schnell 无限模型生成图片。">
<meta name="keywords" content="AI, 图片生成器, FLUX Schnell 无限, together.ai, API, 生成图片">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* Custom styles */
  :root {
    --primary: #6366f1;
    --primary-hover: #4f46e5;
    --secondary: #f59e0b;
    --success: #10b981;
    --danger: #ef4444;
    --dark: #1e293b;
    --light: #f8fafc;
  }

  body {
    background-color: #f9fafb; /* bg-gray-50 */
    color: #1f2937; /* text-gray-800 */
    font-family: sans-serif; /* font-sans */
    height: 100vh;
    overflow: hidden;
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .fade-in {
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 4px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--gray);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
  }

  .tooltip {
    position: relative;
  }

  .tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }

  .tooltip-text {
    background-color: #27272a; /* bg-gray-800 */
    color: #fff; /* text-white */
    font-size: 0.75rem; /* text-xs */
    border-radius: 0.25rem; /* rounded */
    padding: 0.25rem 0.5rem; /* py-1 px-2 */
    visibility: hidden;
    opacity: 0;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    transition: all 0.3s;
  }

  /* 新增的生成按钮样式 */
  #generate-button {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
    color: white;
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
    transition: all 0.3s ease;
    border: none;
  }

  #generate-button:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 50%, #1e40af 100%);
    box-shadow: 0 6px 8px rgba(37, 99, 235, 0.4);
    transform: translateY(-2px);
  }

  #generate-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
  }

  #generate-button:disabled {
    background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 50%, #3b82f6 100%);
    transform: none;
    box-shadow: none;
  }

  .history-item {
    transition: all 0.2s;
  }

  .history-item:hover {
    background-color: #cfcfcf; /* bg-orange-100 */
    transform: translateY(2px);
  }

  .history-item img:hover {
    transform: scale(1.1);
    transition: all 0.2s;
  }

  /* 优化后的通知样式 */
  .notification {
    position: fixed; /* fixed */
    z-index: 50; /* z-50 */
    border-radius: 0.5rem; /* rounded-lg */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
    padding: 0.75rem 1.5rem; /* px-6 py-3 */
    display: flex; /* flex */
    align-items: center; /* items-center */
    bottom: 4rem;
    right: 1em;
    transform: translateX(120%);
    transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease;
    opacity: 0;
    max-width: 320px;
  }

  .notification.show {
    transform: translateX(0);
    opacity: 1;
  }

  .notification.success {
    background-color: #f0fdf4; /* bg-green-100 */
    color: #166534; /* text-green-800 */
    border-left: 4px solid #16a34a; /* border-l-4 border-green-500 */
  }

  .notification.error {
    background-color: #fee2e2; /* bg-red-100 */
    color: #721c24; /* text-red-800 */
    border-left: 4px solid #dc2626; /* border-l-4 border-red-500 */
  }

  .notification.info {
    background-color: #eff6ff; /* bg-blue-100 */
    color: #1e40af; /* text-blue-800 */
    border-left: 4px solid #3b82f6; /* border-l-4 border-blue-500 */
  }

  .notification .icon {
    margin-right: 0.75rem; /* mr-3 */
    font-size: 1.25rem; /* text-xl */
  }

  .notification .close-btn {
    margin-left: 1rem; /* ml-4 */
    color: #6b7280; /* text-gray-500 */
    cursor: pointer; /* cursor-pointer */
  }

  .notification .close-btn:hover {
    color: #4b5563; /* hover:text-gray-700 */
  }

  #loader {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    width: fit-content;
    height: fit-content;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 5px;
    padding: 2rem
  }

  .loader {
    width: 4rem; /* w-5 */
    height: 4rem; /* h-5 */
    border: 5px solid #e5e7eb; /* border-2 border-gray-200 */
    border-top-color: var(--primary); /* border-t-primary */
    border-radius: 9999px; /* rounded-full */
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Responsive adjustments */
  @media (max-width: 1024px) {
    body {
      flex-direction: column;
      height: auto;
      overflow: auto;
    }

    .left-column,
    .middle-column,
    .right-column {
      width: 100% !important;
      height: auto !important;
    }

    .left-column {
      border-right: none !important;
      border-bottom: 1px solid #e2e8f0;
    }

    .middle-column {
      border-bottom: 1px solid #e2e8f0;
    }

    .right-column {
      max-height: 70vh;
    }

    .notification {
      bottom: 0.5rem;
      right: 0.5rem;
      max-width: calc(100% - 1rem);
    }
  }
</style>
</head>

<body class="flex">
  <!-- Left Column - Controls -->
  <div id="loader" class="ml-3 hidden">
    <div class="loader"></div>
  </div>
  <div class="left-column w-1/4 h-full bg-white border-r border-gray-200 overflow-y-auto scrollbar-hide p-4 flex flex-col space-y-4">
    <div class="flex flex-col items-center">
      <h1 class="text-2xl font-bold text-primary flex items-center mb-2" onclick="window.location.href='./index.html'">
        <i class="fas fa-robot mr-2"></i>
        FLUX Schnell
      </h1>
      <div class="flex space-x-2 items-center justify-center">
        <button onclick="window.history.back()" class="text-sm text-primary transition mr-2" title="返回">
            <i class="fas fa-arrow-left"></i>
        </button>
        |
        <a href="./edit.html" class="text-sm text-primary transition" title="Gemini编辑">
          <i class="fas fa-edit mr-2"></i>
        </a>
        |
        <a href="./pollinations.html" class="text-sm text-primary transition" title="Pollinations">
            <i class="fas fa-seedling"></i>
        </a>
      </div>
    </div>
    
    <button type="button" id="toggleTranslateArea" class="flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg transition-colors">
      <i class="fas fa-cog mr-2"></i>
      <span>参数设置</span>
      <i class="fas fa-chevron-down ml-2 text-xs"></i>
    </button>
    
    <div class="setting-area bg-gray-50 rounded-lg p-4 hidden fade-in">
      <div class="space-y-4">
        <div>
          <label for="api-key" class="block text-sm font-bold text-gray-700 mb-1 flex items-center">
            <i class="fas fa-key mr-2 text-primary"></i> API Key
          </label>
          <div class="relative">
            <input type="text" id="api-key" name="api-key" placeholder="请输入您的API Key" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
            <button onclick="copyToClipboard('api-key')" class="absolute right-2 top-2 text-gray-400 hover:text-primary">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1 flex items-center">
            <i class="fas fa-language mr-2 text-primary"></i> 翻译设置
          </label>
          <input type="text" id="translation-api-key" name="translation-api-key" placeholder="Gemini API Key"
                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary mb-2">
          <select id="modelSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
            <option value="gemini-2.0-flash">gemini-2.0-flash</option>
            <option value="gemini-2.0-flas-001">gemini-2.0-flas-001</option>
            <option value="gemini-2.0-flash-thinking-exp">gemini-2.0-flash-thinking-exp</option>
            <option value="gemini-2.0-flash-thinking-exp-1219">gemini-2.0-flash-thinking-exp-1219</option>
            <option value="gemini-2.0-flash-thinking-exp-01-21">gemini-2.0-flash-thinking-exp-01-21</option>
            <option value="gemini-2.0-flash-lite-preview-02-05">gemini-2.0-flash-lite-preview-02-05</option>
            <option value="gemini-2.0-flash-lite-preview">gemini-2.0-flash-lite-preview</option>
            <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
            <option value="gemini-2.0-pro-exp-02-05">gemini-2.0-pro-exp-02-05</option>
            <option value="gemini-2.0-pro-exp">gemini-2.0-pro-exp</option>
            <option value="gemini-exp-1206">gemini-exp-1206</option>
            <option value="gemini-2.0-flash-exp-image-generation">gemini-2.0-flash-exp-image-generation</option>
            <option value="gemma-3-27b-it">gemma-3-27b-it</option>
          </select>
        </div>

        <div>
          <label for="steps" class="block text-sm font-bold text-gray-700 mb-1 flex items-center">
            <i class="fas fa-tachometer-alt mr-2 text-primary"></i> 步数 (Steps)
          </label>
          <div class="flex items-center space-x-4">
            <input type="range" id="steps" name="steps" min="1" max="4" value="4" step="1"
                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                   oninput="updateStepsValue(this.value)">
            <span id="stepsValue" class="text-primary font-bold text-lg">4</span>
          </div>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1 flex items-center">
            <i class="fas fa-ruler-combined mr-2 text-primary"></i> 自定义尺寸
          </label>
          <div class="flex items-center space-x-2">
            <input type="number" id="width" name="width" min="64" max="1792" placeholder="宽度"
                   class="w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
            <span class="text-gray-500">×</span>
            <input type="number" id="height" name="height" min="64" max="1792" placeholder="高度"
                   class="w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
          </div>
          <p class="mt-1 text-xs text-gray-500">宽和高都要为16的整数倍，64~1792之间。</p>
        </div>
        
        <div>
          <label for="seed" class="block text-sm font-bold text-gray-700 mb-1 flex items-center">
            <i class="fas fa-seedling mr-2 text-primary"></i> 种子数 (Seed)
          </label>
          <div class="flex">
            <input type="number" id="seed" name="seed" placeholder="留空则随机"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
            <button type="button" id="random-seed-button" onclick="clearSeed()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-r-md transition-colors">
              <i class="fas fa-eraser"></i>
            </button>
          </div>
        </div>

      </div>
    </div>
    
    <div class="space-y-4">
      <div>
        <label for="imageSize" class="block text-sm font-bold text-gray-700 mb-1 flex items-center">
          <i class="fas fa-expand mr-2 text-primary"></i> 预设分辨率
        </label>
        <select id="imageSize" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
          <option value="1008x1792">默认 1008x1792 (9:16)</option>
          <option disabled>————方图————</option>
          <option value="512x512">512x512</option>
          <option value="1024x1024">1024x1024</option>
          <option value="1200×1200">1200x1200</option>
          <option value="1440x1440">1440x1440</option>
          <option value="1600x1600">1600x1600</option>
          <option value="1792x1792">1792x1792</option>
          <option disabled>————3:4 竖图————</option>
          <option value="480x640">480x640</option>
          <option value="768x1024">768x1024</option>
          <option value="960x1280">960x1280</option>
          <option value="1200x1600">1200x1600</option>
          <option value="1344x1792">1344x1792</option>
          <option disabled>————9:16 竖图————</option>
          <option value="432x768">432x768</option>
          <option value="576x1024">576x1024</option>
          <option value="720x1280">720x1280</option>
          <option value="864x1536">864x1536</option>
          <option value="1008x1792">1008x1792</option>
          <option disabled>————4:3 横图————</option>
          <option value="640x480">640x480</option>
          <option value="1024x768">1024x768</option>
          <option value="1280x960">1280x960</option>
          <option value="1600x1200">1600x1200</option>
          <option value="1792x1344">1792x1344</option>
          <option disabled>————16:9 横图————</option>
          <option value="768x432">768x432</option>
          <option value="1024x576">1024x576</option>
          <option value="1280x720">1280x720</option>
          <option value="1536x864">1536x864</option>
          <option value="1792x1008">1792x1008</option>
        </select>
      </div>
      
      <div>
        <label for="prompt" class="block text-sm font-bold text-gray-700 mb-1 flex items-center">
          <i class="fas fa-comment-dots mr-2 text-primary"></i> 提示词 (Prompt)
        </label>
        <textarea id="prompt" name="prompt" placeholder="请输入【英文】提示词" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></textarea>
        <div class="flex space-x-2 mt-2">
          <button type="button" onclick="pastePrompt()" class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-3 rounded flex items-center justify-center tooltip">
            <i class="fas fa-paste"></i>
            <span class="tooltip-text">从剪贴板粘贴</span>
          </button>
          <button type="button" onclick="copyPrompt()" class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-3 rounded flex items-center justify-center tooltip">
            <i class="far fa-copy"></i>
            <span class="tooltip-text">复制到剪贴板</span>
          </button>
          <button type="button" onclick="translatePrompt()" class="flex-1 bg-green-100 hover:bg-green-200 text-green-800 py-2 px-3 rounded flex items-center justify-center tooltip">
            <i class="fas fa-language"></i>
            <span class="tooltip-text">翻译为英文</span>
          </button>
          <button type="button" onclick="fillPrompt()" class="flex-1 bg-orange-100 hover:bg-orange-200 text-orange-800 py-2 px-3 rounded flex items-center justify-center tooltip">
            <i class="fas fa-arrow-up"></i>
            <span class="tooltip-text">填入翻译结果</span>
          </button>
        </div>
        
        <div class="mt-2">
          <textarea id="translated-text" rows="2" readonly
                    class="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-md bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors"
                    placeholder="翻译结果将显示在这里"></textarea>
        </div>
      </div>
      
      <div class="flex items-center">
        <button id="generate-button" onclick="generateImage()"
                class="flex-1 bg-primary hover:bg-primary-hover text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors flex items-center justify-center">
          <i class="fas fa-magic mr-2"></i>
          <span>生成图片</span>
        </button>
      </div>
      <div id="error-message" class="text-red-500 text-sm mt-1"></div>
    </div>
  </div>
  
  <!-- Middle Column - Image Display -->
  <div class="middle-column w-2/4 h-full bg-gray-100 overflow-y-auto scrollbar-hide flex flex-col items-center p-4">
    <div id="image-container" class="w-fit h-full flex flex-col items-center justify-center bg-white rounded-xl shadow-md p-4">
      <img id="output-image" loading="lazy" src="https://api.yujn.cn/api/gzl_ACG.php?type=image&form=pe" alt="生成的AI图片"
           class="w-full max-h-[85vh] object-contain rounded-lg cursor-zoom-in hover:shadow-lg transition-shadow hover:scale-105 transition-transform duration-300">
      <div class="flex items-center mt-4 w-full max-w-md">
        <input type="text" id="filename" placeholder="自定义文件名"
               class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
        <button onclick="downloadImage()"
                class="bg-gray-400 hover:bg-orange-400 text-white font-bold py-2 px-4 rounded-r-md shadow-sm transition-colors flex items-center">
          <i class="fas fa-download mr-2"></i>
          <span>下载</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Right Column - History -->
  <div class="right-column w-1/4 h-full bg-white border-l border-gray-200 overflow-y-auto scrollbar-hide p-4">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold text-gray-800 flex items-center">
        <i class="fas fa-history mr-2 text-primary"></i>
        历史记录
      </h3>
      <button onclick="clearHistory()" class="text-sm text-red-500 hover:text-red-700 flex items-center">
        <i class="fas fa-trash-alt mr-1"></i>
        清空
      </button>
    </div>
    <div id="history-container" class="space-y-2">
      <!-- 历史记录内容将在这里动态生成 -->
    </div>
  </div>
  
  <!-- 优化后的通知组件 -->
  <div id="notification" class="notification hidden">
    <span class="icon"></span>
    <span class="message"></span>
    <span class="close-btn" onclick="hideNotification()">
      <i class="fas fa-times"></i>
    </span>
  </div>

  <script>
    // IndexedDB 数据库名称和版本
    const DB_NAME = 'image_generator_db';
    const DB_VERSION = 1;
    const OBJECT_STORE_NAME = 'image_history';
    let db; // 用于存储数据库实例
    // 初始化 IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = (event) => {
          console.error("IndexedDB error:", event.target.error);
          reject(event.target.error);
        };
        request.onsuccess = (event) => {
          db = event.target.result;
          console.log("IndexedDB opened successfully");
          resolve(db);
        };
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          // 创建对象仓库
          const objectStore = db.createObjectStore(OBJECT_STORE_NAME, {
            keyPath: 'timestamp' // 使用时间戳作为键
          });
          console.log("Object store created");
        };
      });
    }
    // 添加历史记录到 IndexedDB
    async function addHistoryItem(item) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([OBJECT_STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(OBJECT_STORE_NAME);
        const request = objectStore.add(item);
        request.onsuccess = () => {
          console.log('Added item to IndexedDB');
          resolve();
        };
        request.onerror = (event) => {
          console.error("Error adding item:", event.target.error);
          reject(event.target.error);
        };
      });
    }
    // 获取所有历史记录
    async function getAllHistoryItems() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([OBJECT_STORE_NAME], 'readonly');
        const objectStore = transaction.objectStore(OBJECT_STORE_NAME);
        const request = objectStore.getAll();
        request.onsuccess = (event) => {
          const history = event.target.result;
          resolve(history.reverse()); // 反转数组，使最新的记录在前面
        };
        request.onerror = (event) => {
          console.error("Error getting all items:", event.target.error);
          reject(event.target.error);
        };
      });
    }
    // 删除历史记录项
    async function deleteHistoryItemFromDB(timestamp) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([OBJECT_STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(OBJECT_STORE_NAME);
        const request = objectStore.delete(timestamp);
        request.onsuccess = () => {
          console.log('Deleted item from IndexedDB');
          resolve();
        };
        request.onerror = (event) => {
          console.error("Error deleting item:", event.target.error);
          reject(event.target.error);
        };
      });
    }
    // 清空历史记录
    async function clearHistoryFromDB() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([OBJECT_STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(OBJECT_STORE_NAME);
        const request = objectStore.clear();
        request.onsuccess = () => {
          console.log('All history cleared from IndexedDB');
          resolve();
        };
        request.onerror = (event) => {
          console.error("Error clearing history:", event.target.error);
          reject(event.target.error);
        };
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
    // 页面加载时检查本地缓存的 API Key
    const cachedApiKey = localStorage.getItem('apiKey_image_generator');
    if (cachedApiKey) {
      document.getElementById('api-key').value = cachedApiKey;
    }
    const cachedTranslationApiKey = localStorage.getItem('translationApiKey');
    if (cachedTranslationApiKey) {
      document.getElementById('translation-api-key').value = cachedTranslationApiKey;
    }

    // 初始化 IndexedDB
    initDB()
      .then(() => {
        // 初始化历史记录
        updateHistory();
      })
      .catch(error => {
        console.error("Failed to initialize IndexedDB:", error);
        showNotification('无法初始化数据库，历史记录可能无法加载', 'error');
      });
    
    // 设置区域切换
    const toggleTranslateAreaButton = document.getElementById('toggleTranslateArea');
    const translateArea = document.querySelector('.setting-area');
    const chevronIcon = toggleTranslateAreaButton.querySelector('.fa-chevron-down');
    
    toggleTranslateAreaButton.addEventListener('click', function() {
      translateArea.classList.toggle('hidden');
      chevronIcon.classList.toggle('fa-chevron-down');
      chevronIcon.classList.toggle('fa-chevron-up');
    });
    
    // 图片点击放大/缩小
    const outputImage = document.getElementById('output-image');
    outputImage.addEventListener('click', function() {
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        outputImage.requestFullscreen();
      }
    });
    
    // 翻译结果点击复制
    const translatedText = document.getElementById('translated-text');
    translatedText.addEventListener('click', function() {
      this.select();
      document.execCommand('copy');
      showNotification('翻译结果已复制', 'success');
    });

    // 文件名输入框回车键触发下载
    const filenameInput = document.getElementById('filename');
    filenameInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            downloadImage();
        }
    });
  });

    // --- Keyboard Shortcuts ---
    const promptTextarea = document.getElementById('prompt');
    const generateButtonEl = document.getElementById('generate-button'); // Renamed variable

    promptTextarea.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) { // Added !event.isComposing
        event.preventDefault();
        if (!generateButtonEl.disabled) {
          generateButtonEl.click();
        }
      }
    });
    async function generateImage() {
      const generateButton = document.getElementById('generate-button');
      const loader = document.getElementById('loader');
      const apiKey = document.getElementById('api-key').value;
      const prompt = document.getElementById('prompt').value;
      let width = document.getElementById('width').value;
      let height = document.getElementById('height').value;
      const imageSize = document.getElementById('imageSize').value;

      if (!width || !height) {
        const [sizeWidth, sizeHeight] = imageSize.split('x');
        width = parseInt(sizeWidth);
        height = parseInt(sizeHeight);
      } else {
        width = parseInt(width);
        height = parseInt(height);
      }
      const steps = parseInt(document.getElementById('steps').value);
      const seedInput = document.getElementById('seed').value;
      const seed = seedInput ? parseInt(seedInput) : null;
      const errorMessageDiv = document.getElementById('error-message');
      errorMessageDiv.textContent = '';

      if (!apiKey) {
        showNotification('API Key 不能为空！', 'error');
        return;
      }
      if (!prompt) {
        showNotification('提示词不能为空！', 'error');
        return;
      }

      const apiUrl = "https://api.together.xyz/v1/images/generations";
      const headers = {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      };
      const requestBody = {
        "model": "black-forest-labs/FLUX.1-schnell-Free",
        "prompt": prompt,
        "width": width,
        "height": height,
        "steps": steps,
        "n": 1,
        "response_format": "b64_json",
        "stop": [],
        "update_at": new Date().toISOString()
      };

      if (seed !== null) {
        requestBody.seed = seed;
      }
      
      // 禁用按钮并显示加载动画
      generateButton.disabled = true;
      generateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>生成中...</span>';
      loader.classList.remove('hidden');
      
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody)
        });

        localStorage.setItem('apiKey_image_generator', apiKey);

        if (!response.ok) {
          const errorData = await response.json();
          console.error("API error:", errorData);
          showNotification(`生成图片失败: ${errorData.error || '请查看控制台错误信息'}`, 'error');
          generateButton.disabled = false;
          generateButton.innerHTML = '<i class="fas fa-magic mr-2"></i><span>生成图片</span>';
          loader.classList.add('hidden');
          return;
        }

        const data = await response.json();
        if (data.data && data.data.length > 0 && data.data[0].b64_json) {
          const base64Image = data.data[0].b64_json;
          const imageUrl = `data:image/png;base64,${base64Image}`;
          const outputImage = document.getElementById('output-image');
          outputImage.src = imageUrl;
          errorMessageDiv.textContent = '';

          // 请求成功后缓存 API Key
          localStorage.setItem('apiKey_image_generator', apiKey);

          // 启动倒计时
          startCountdown(5);

          // 缓存历史记录
          cacheHistory({
            prompt: prompt,
            width: width,
            height: height,
            steps: steps,
            seed: seed,
            imageUrl: imageUrl
          });

          // 更新历史记录显示
          updateHistory();
          showNotification('图片生成成功!', 'success');
        } else {
          showNotification('未能在响应中找到图片数据', 'error');
          console.error("Unexpected API response format:", data);
          generateButton.disabled = false;
          generateButton.innerHTML = '<i class="fas fa-magic mr-2"></i><span>生成图片</span>';
          loader.classList.add('hidden');
        }

      } catch (error) {
        console.error("Fetch error:", error);
        showNotification('网络请求错误，请检查网络连接', 'error');
        generateButton.disabled = false;
        generateButton.innerHTML = '<i class="fas fa-magic mr-2"></i><span>生成图片</span>';
        loader.classList.add('hidden');
      }
    }

    function downloadImage() {
      const imageUrl = document.getElementById('output-image').src;
      const filenameInput = document.getElementById('filename');

      // 生成默认文件名，如果输入为空
      let defaultFilename = 'generated-image';
      // 假设prompt元素存在并能获取到
      const promptText = document.getElementById('prompt')?.value?.trim();
      if (promptText) {
        defaultFilename = promptText.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').substring(0, 30);
      } else {
        defaultFilename = `image-tgz-${Date.now()}`;
      }

      const filename = filenameInput.value.trim() !== '' ? filenameInput.value.trim() : defaultFilename;
      const fullFilename = `${filename}.png`; // 强制使用png后缀

      // 只在 imageUrl 是 Base64 字符串时才下载
      if (imageUrl && imageUrl.startsWith('data:image')) {
        const downloadLink = document.createElement('a');
        downloadLink.href = imageUrl;
        downloadLink.download = fullFilename;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        showNotification("图片下载中...", 'info');
      } else {
        showNotification("无法下载：图像不是有效的Base64数据。", 'error');
        console.warn("尝试下载非Base64图像:", imageUrl); // 记录日志方便调试
      }
    }

    function randomSeed() {
      const seedInput = document.getElementById('seed');
      const randomSeedValue = Math.floor(Math.random() * 100000000000000) + 1;
      seedInput.value = randomSeedValue;
      showNotification('随机种子已生成', 'success');
    }

    function clearSeed() {
      document.getElementById('seed').value = '';
      showNotification('已清除种子', 'info');
    }

    function updateStepsValue(value) {
      document.getElementById('stepsValue').innerText = value;
    }

    function startCountdown(seconds) {
      const generateButton = document.getElementById('generate-button');
      const loader = document.getElementById('loader');
      let remainingTime = seconds;

      // 更新按钮文本显示倒计时
      generateButton.innerHTML = `<span>请等待 (${remainingTime}s)</span>`;

      // 禁用按钮
      generateButton.disabled = true;
      loader.classList.remove('hidden');

      const countdownInterval = setInterval(() => {
        remainingTime--;

        if (remainingTime >= 0) {
          generateButton.innerHTML = `<span>请等待 (${remainingTime}s)</span>`;
        } else {
          clearInterval(countdownInterval);
          generateButton.innerHTML = '<i class="fas fa-magic mr-2"></i><span>生成图片</span>';
          generateButton.disabled = false;
          loader.classList.add('hidden');
        }
      }, 1000);
    }

// 缓存历史记录
async function cacheHistory(data) {
  const item = {
    ...data,
    timestamp: new Date().toISOString()
  };

  try {
    await addHistoryItem(item);
    console.log("History item cached successfully.");
  } catch (error) {
    console.error("Failed to cache history:", error);
    showNotification('缓存历史记录失败', 'error');
  }
}

// 更新历史记录显示
async function updateHistory() {
  const historyContainer = document.getElementById('history-container');
  historyContainer.innerHTML = '';

  try {
    const history = await getAllHistoryItems();

    if (history.length === 0) {
      historyContainer.innerHTML = `
        <div class="text-center py-8 text-gray-400">
          <i class="fas fa-image fa-2x mb-2"></i>
          <p>暂无历史记录</p>
        </div>
      `;
      return;
    }

    history.forEach((item) => {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item bg-white p-3 rounded-lg shadow-sm cursor-pointer flex items-start relative hover:shadow-md transition-all';

      const imagePreview = document.createElement('img');
      imagePreview.src = item.imageUrl;
      imagePreview.alt = '历史图片';
      imagePreview.className = 'w-16 h-16 object-cover rounded-md mr-3';
      historyItem.appendChild(imagePreview);

      const textContainer = document.createElement('div');
      textContainer.className = 'flex-1 overflow-hidden';

      const promptText = document.createElement('p');
      promptText.textContent = item.prompt;
      promptText.className = 'text-sm text-gray-700 truncate';
      textContainer.appendChild(promptText);

      const detailsText = document.createElement('p');
      detailsText.className = 'text-xs text-gray-500 mt-1';
      detailsText.innerHTML = `
        ${item.width}×${item.height} · 步数: ${item.steps} · ${new Date(item.timestamp).toLocaleString()}
      `;
      textContainer.appendChild(detailsText);

      historyItem.appendChild(textContainer);

      const deleteButton = document.createElement('button');
      deleteButton.className = 'absolute top-0 right-1 text-gray-400 hover:text-red-500 transition-colors';
      deleteButton.innerHTML = '<i class="fas fa-times"></i>';
      deleteButton.onclick = function (event) {
        event.stopPropagation();
        deleteHistoryItem(item.timestamp); // Pass the timestamp
      };
      historyItem.appendChild(deleteButton);

      historyItem.onclick = function () {
        fillForm(item);
      };

      historyContainer.appendChild(historyItem);
    });
  } catch (error) {
    console.error("Failed to update history:", error);
    showNotification('无法加载历史记录', 'error');
  }
}

    async function pastePrompt() {
      const promptInput = document.getElementById('prompt');
      try {
        const text = await navigator.clipboard.readText();
        promptInput.value = text;
        showNotification('已从剪贴板粘贴', 'success');
      } catch (err) {
        console.error('Failed to read clipboard contents: ', err);
        showNotification('无法读取剪贴板内容', 'error');
      }
    }

    function copyPrompt() {
      const promptInput = document.getElementById('prompt');
      promptInput.select();
      document.execCommand('copy');
      showNotification('提示词已复制', 'success');
    }
    
    async function translatePrompt() {
      const apiKey = document.getElementById('translation-api-key').value;
      const prompt = document.getElementById('prompt').value;
      const model = document.getElementById('modelSelect').value;
      const translatedTextarea = document.getElementById('translated-text');

      if (!apiKey) {
        showNotification('翻译 API Key 不能为空！', 'error');
        return;
      }

      if (!prompt) {
        showNotification('提示词不能为空！', 'error');
        return;
      }

      const apiUrl = "https://gemini.liyao.sbs/v1/chat/completions";
      const headers = {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      };

      const requestBody = {
        "model": model,
        "messages": [
          {
            "role": "user",
            "content": `Translate the content into English. Respond only with the translated content, and the response must be entirely in English without any other languages. Content: ${prompt}`
          }
        ]
      };

      try {
        const translateButton = document.querySelector('button[onclick="translatePrompt()"]');
        const originalText = translateButton.innerHTML;
        translateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>翻译中...</span>';
        translateButton.disabled = true;

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error("API error:", errorData);
          showNotification(`翻译失败: ${errorData.error || '请查看控制台错误信息'}`, 'error');
          translateButton.innerHTML = originalText;
          translateButton.disabled = false;
          return;
        }

        const data = await response.json();
        if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
          const translatedContent = data.choices[0].message.content;
          translatedTextarea.value = translatedContent;

          // 缓存 API Key
          localStorage.setItem('translationApiKey', apiKey);
          showNotification('翻译成功', 'success');
        } else {
          showNotification('未能成功翻译，请检查API响应格式。', 'error');
          console.error("Unexpected API response format:", data);
        }

      } catch (error) {
        console.error("Fetch error:", error);
        showNotification('网络请求错误，请检查网络连接', 'error');
      } finally {
        const translateButton = document.querySelector('button[onclick="translatePrompt()"]');
        translateButton.innerHTML = '<i class="fas fa-language mr-2"></i><span>翻译</span>';
        translateButton.disabled = false;
      }
    }

    function fillPrompt() {
      const translatedText = document.getElementById('translated-text').value;
      document.getElementById('prompt').value = translatedText;
      showNotification('翻译结果已填入', 'success');
    }

// 删除历史记录项
async function deleteHistoryItem(timestamp) {
  try {
    await deleteHistoryItemFromDB(timestamp);
    await updateHistory(); // 重新加载历史记录
    showNotification('历史记录已删除', 'info');
  } catch (error) {
    console.error("Failed to delete history item:", error);
    showNotification('删除历史记录失败', 'error');
  }
}

// 清空历史记录
async function clearHistory() {
  if (confirm('确定要清空所有历史记录吗？此操作不可撤销。')) {
    try {
      await clearHistoryFromDB();
      await updateHistory(); // 重新加载历史记录
      showNotification('历史记录已清空', 'info');
    } catch (error) {
      console.error("Failed to clear history:", error);
      showNotification('清空历史记录失败', 'error');
    }
  }
}

    // 填充表单
    function fillForm(item) {
      document.getElementById('prompt').value = item.prompt;
      document.getElementById('steps').value = item.steps;
      document.getElementById('stepsValue').innerText = item.steps;
      document.getElementById('seed').value = item.seed;
      const imageSizeSelect = document.getElementById('imageSize');
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');

      // 检查历史记录项中是否存在 width 和 height
      if (item.width && item.height) {
        // 查找 imageSize select 中是否有匹配的选项
        let found = false;
        for (let i = 0; i < imageSizeSelect.options.length; i++) {
          if (imageSizeSelect.options[i].value === `${item.width}x${item.height}`) {
            imageSizeSelect.selectedIndex = i;
            found = true;
            break;
          }
        }

        // 如果在 imageSize select 中没有找到匹配的选项，则填充到 width 和 height 输入框中
        if (!found) {
          widthInput.value = item.width;
          heightInput.value = item.height;
        } else {
          widthInput.value = '';
          heightInput.value = '';
        }
      }

      const outputImage = document.getElementById('output-image');
      outputImage.src = item.imageUrl;
      showNotification('历史记录已加载', 'success');
    }

    // 复制文本到剪贴板
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      element.select();
      document.execCommand('copy');
      showNotification('已复制到剪贴板', 'success');
    }

    // 显示通知
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      const icon = notification.querySelector('.icon');
      const messageSpan = notification.querySelector('.message');
      
      // 设置通知内容和样式
      notification.className = `notification ${type}`;
      messageSpan.textContent = message;
      
      // 设置图标
      switch(type) {
        case 'success':
          icon.innerHTML = '<i class="fas fa-check-circle"></i>';
          break;
        case 'error':
          icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
          break;
        default:
          icon.innerHTML = '<i class="fas fa-info-circle"></i>';
      }
      
      // 显示通知
      notification.classList.remove('hidden');
      notification.classList.add('show');
      
      // 5秒后自动隐藏
      setTimeout(() => {
        hideNotification();
      }, 5000);
    }
    
    // 隐藏通知
    function hideNotification() {
      const notification = document.getElementById('notification');
      notification.classList.remove('show');
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 300);
    }
  </script>
</body>
</html>