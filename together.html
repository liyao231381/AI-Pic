<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>AI 图片生成器</title>
<style>
  /* 基本 CSS 重置 */
  body, h1, h2, h3, p, input, select, button, textarea {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: sans-serif;
    background-color: #f4f4f4;
    color: #333;
    line-height: 1.6;
    display: flex;
    min-height: 100vh;
    height: 100vh;
    overflow: hidden;
  }

  .left-column {
    width: 25%;
    padding: 20px;
    background-color: #fff;
    border-right: 1px solid #ccc;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    scrollbar-width: none;
  }

  .middle-column {
    width: 50%;
    padding: 10px;
    background-color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; /* 内容顶部对齐 */
    height: 100%;
    overflow-y: auto;
  }

  .right-column {
    width: 25%;
    padding: 20px;
    background-color: #f9f9f9;
    border-left: 1px solid #ccc;
    overflow-y: auto;
    height: 100%;
  }


    /* 通用样式 */
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #007bff;
    }

    label {
      display: block;
      margin-bottom: 3px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
      resize: vertical;
    }

    textarea {
      min-height: 120px;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    input::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
      color: #999;
      opacity: 1; /* Firefox */
    }

    input:-ms-input-placeholder { /* Internet Explorer 10-11 */
      color: #999;
    }

    input::-ms-input-placeholder { /* Microsoft Edge */
      color: #999;
    }

    select {
      appearance: none;
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23343a40"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      min-width: fit-content;
      font-weight: bold;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #random-seed-button {
      padding: 6px 10px;
      max-width: fit-content;
      margin-left: 5px;
    }

  /* 加载动画样式 */
  .loader {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 2s linear infinite;
    display: none; /* 初始状态隐藏 */
    margin-left: 5px; /* 调整与文字的间距 */
    vertical-align: middle;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  #image-container {
    margin-top: 10px;
    text-align: center;
    width: 100%;
    height: 96%; /* 占据整个结果区域高度 */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center; /* 垂直居中图像 */
  }

  #output-image {
    width: 95%;
    max-height: 95%; /* 调整为按钮留出空间 */
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 10px;
    cursor: pointer;
    object-fit: contain;
  }

  /* 图片和按钮间距 */
  #error-message {
    color: red;
    margin-top: 10px;
  }

  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 20px;
    border-radius: 10px;
    background: #5ddcff;
    outline: none;
    -webkit-transition: 0.2s;
    transition: opacity 0.2s;
    border: none;
    opacity: 0.7;
  }

  input[type="range"]:hover {
    opacity: 1;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
  }

  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
  }

  .delete-button {
    background-color: red;
    color: white;
    padding: 0 4px;
    border: none;
    position: absolute;
    top: 5px;
    right: 5px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
  }

</style>
</head>

<body>
    <div class="left-column">
      <h1>FLUX Schnell无限</h1>
      <a href="./index.html">返回首页</a>
      <div class="input-group">
        <label for="api-key">API Key:</label>
        <input type="text" id="api-key" name="api-key" placeholder="请输入您的API Key">
        <a href="https://api.together.ai/settings/api-keys" target="_blank">获取together.ai API Key</a>
      </div>

      <div class="input-group">
        <label for="prompt">提示词 (Prompt):</label>
        <textarea id="prompt" name="prompt" placeholder="请输入提示词，例如: A cat wearing sunglasses"></textarea>
      </div>

      <div class="input-group">
        <label for="imageSize">预设分辨率:</label>
        <select id="imageSize">
          <option value="1008x1792">默认 1008x1792 (9:16)</option>
          <option disabled>————方图————</option>
          <option value="512x512">512x512 (1:1)</option>
          <option value="1024x1024">1024x1024 (1:1)</option>
          <option disabled>————3:4 竖图————</option>
          <option value="480x640">480x640 (3:4)</option>
          <option value="768x1024">768x1024 (3:4)</option>
          <option value="960x1280">960x1280 (3:4)</option>
          <option value="1344x1792">1344x1792 (3:4)</option>
          <option disabled>————9:16 竖图————</option>
          <option value="432x768">432x768 (9:16)</option>
          <option value="576x1024">576x1024 (9:16)</option>
          <option value="720x1280">720x1280 (9:16)</option>
          <option value="864x1536">864x1536 (9:16)</option>
          <option value="1008x1792">1008x1792 (9:16)</option>
          <option disabled>————4:3 横图————</option>
          <option value="640x480">640x480 (4:3)</option>
          <option value="1024x768">1024x768 (4:3)</option>
          <option value="1280x960">1280x960 (4:3)</option>
          <option value="1792x1344">1792x1344 (4:3)</option>
          <option disabled>————16:9 横图————</option>
          <option value="768x432">768x432 (16:9)</option>
          <option value="1024x576">1024x576 (16:9)</option>
          <option value="1280x720">1280x720 (16:9)</option>
          <option value="1536x864">1536x864 (16:9)</option>
          <option value="1792x1008">1792x1008 (16:9)</option>
        </select>
      </div>


      <div class="input-group">
        <strong>自定义分辨率：</strong>
        <input type="number" id="width" name="width" min="64" max="1792" style="min-width: 60px; width: 15%; display: inline-block;"
          placeholder="宽度">
        <span> × </span>
        <input type="number" id="height" name="height" min="64" max="1792" style="min-width: 60px; width: 15%; display: inline-block;"
          placeholder="高度">
        <p style="margin-top: 0px; font-style: italic; color: #9a9a9a; font-size: small;"> 宽和高都要为16的整数倍，64~1792之间。</p>
      </div>

      <div class="input-group">
        <label for="steps">步数 (Steps):</label>
        <input type="range" id="steps" name="steps" min="1" max="4" value="4" step="1"
          oninput="updateStepsValue(this.value)" style="width: 80%;">
        <span id="stepsValue" style="margin-left: 10px; font-weight: bold; font-size: larger; color: #007bff;">4</span>
      </div>

      <div class="input-group">
        <label for="seed">种子数 (Seed, 可选):</label>
        <input type="number" id="seed" name="seed" placeholder="留空则随机" style="width: 80%; display: inline-block;">
        <button type="button" id="random-seed-button" onclick="randomSeed()">随机</button>
      </div>

      <div>
        <button id="generate-button" onclick="generateImage()">生成图片</button>
        <span class="loader"></span>
      </div>
    </div>

    <div class="middle-column">
      <div id="image-container" style="display: none;">
        <img id="output-image" src="#" alt="生成的AI图片">
        <button onclick="downloadImage()">下载图片</button>
      </div>

      <div id="error-message"></div>
    </div>

    <div class="right-column">
      <h2>历史记录</h2>
      <div id="history-container">
        <!-- 历史记录内容将在这里动态生成 -->
      </div>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 页面加载时检查本地缓存的 API Key
      const cachedApiKey = localStorage.getItem('apiKey_image_generator');
      if (cachedApiKey) {
        document.getElementById('api-key').value = cachedApiKey;
      }
    });

    async function generateImage() {
      const generateButton = document.getElementById('generate-button');
      const loader = document.querySelector('.loader');
      const apiKey = document.getElementById('api-key').value;
      const prompt = document.getElementById('prompt').value;
      let width = document.getElementById('width').value;
      let height = document.getElementById('height').value;
      const imageSize = document.getElementById('imageSize').value;

      if (!width || !height) {
        const [sizeWidth, sizeHeight] = imageSize.split('x');
        width = parseInt(sizeWidth);
        height = parseInt(sizeHeight);
      } else {
        width = parseInt(width);
        height = parseInt(height);
      }
      const steps = parseInt(document.getElementById('steps').value);
      const seedInput = document.getElementById('seed').value;
      const seed = seedInput ? parseInt(seedInput) : null; // 如果留空则为 null
      const errorMessageDiv = document.getElementById('error-message');
      errorMessageDiv.textContent = ''; // 清空错误信息

      if (!apiKey) {
        errorMessageDiv.textContent = 'API Key 不能为空！';
        return;
      }
      if (!prompt) {
        errorMessageDiv.textContent = '提示词不能为空！';
        return;
      }

      const apiUrl = "https://api.together.xyz/v1/images/generations";
      const headers = {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      };
      const requestBody = {
        "model": "black-forest-labs/FLUX.1-schnell-Free",
        "prompt": prompt,  // 修正：直接使用 prompt 字符串，不再放入数组
        "width": width,
        "height": height,
        "steps": steps,
        "n": 1,
        "response_format": "b64_json",
        "stop": [],
        "update_at": new Date().toISOString() // 使用当前时间
      };

      if (seed !== null) {
        requestBody.seed = seed; // 只有当 seed 不为 null 时才添加到请求体中
      }
      // 禁用按钮并显示加载动画
      generateButton.disabled = true;
      loader.style.display = 'inline-block';
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody)
        });

        localStorage.setItem('apiKey_image_generator', apiKey);

        if (!response.ok) {
          const errorData = await response.json();
          console.error("API error:", errorData); // 打印详细错误信息到控制台
          errorMessageDiv.textContent = `生成图片失败: ${response.status} ${response.statusText} - ${errorData.message || '请查看控制台错误信息'}`;
          return;
        }

        const data = await response.json();
        if (data.data && data.data.length > 0 && data.data[0].b64_json) {
          const base64Image = data.data[0].b64_json;
          const imageUrl = `data:image/png;base64,${base64Image}`;
          const outputImage = document.getElementById('output-image');
          outputImage.src = imageUrl;
          document.getElementById('image-container').style.display = 'block'; // 显示图片容器
          errorMessageDiv.textContent = ''; // 清空错误信息

          // 请求成功后缓存 API Key
          localStorage.setItem('apiKey_image_generator', apiKey);

          // 启动倒计时
          startCountdown(5);

          // 缓存历史记录
          cacheHistory({
            prompt: prompt,
            width: width,
            height: height,
            steps: steps,
            seed: seed,
            imageUrl: imageUrl
          });

          // 更新历史记录显示
          updateHistory();

        } else {
          errorMessageDiv.textContent = '未能在响应中找到图片数据。请检查API响应格式。';
          console.error("Unexpected API response format:", data); // 打印完整的响应数据到控制台
        }

      } catch (error) {
        console.error("Fetch error:", error);
        errorMessageDiv.textContent = '网络请求错误，请检查网络连接或稍后再试。';
      } finally {
        // 隐藏加载动画并启用按钮（如果倒计时结束）
        loader.style.display = 'none';
      }
    }

    function downloadImage() {
      const imageUrl = document.getElementById('output-image').src;
      const downloadLink = document.createElement('a');
      downloadLink.href = imageUrl;
      downloadLink.download = 'ai_generated_image.png'; // 下载的文件名
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    function randomSeed() {
      const seedInput = document.getElementById('seed');
      const randomSeedValue = Math.floor(Math.random() * 100000000000000) + 1;
      seedInput.value = randomSeedValue;
    }

    function updateStepsValue(value) {
      document.getElementById('stepsValue').innerText = value;
    }

    function startCountdown(seconds) {
      const generateButton = document.getElementById('generate-button');
      let remainingTime = seconds;

      // 更新按钮文本显示倒计时
      generateButton.textContent = `生成图片 (${remainingTime}s)`;

      // 禁用按钮
      generateButton.disabled = true;

      const countdownInterval = setInterval(() => {
        remainingTime--;

        if (remainingTime >= 0) {
          generateButton.textContent = `生成图片 (${remainingTime}s)`;
        } else {
          clearInterval(countdownInterval);
          generateButton.textContent = '生成图片';
          generateButton.disabled = false;
        }
      }, 1000);
    }

    // 缓存历史记录
    function cacheHistory(data) {
      let history = JSON.parse(localStorage.getItem('image_history') || '[]');
      history.unshift({
        ...data,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('image_history', JSON.stringify(history));
    }

    // 更新历史记录显示
    function updateHistory() {
      const historyContainer = document.getElementById('history-container');
      historyContainer.innerHTML = ''; // 清空历史记录

      let history = JSON.parse(localStorage.getItem('image_history') || '[]');

      history.forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.style.borderBottom = '1px solid #ccc';
        historyItem.style.padding = '10px';
        historyItem.style.display = 'flex';
        historyItem.style.alignItems = 'flex-start'; /* 顶部对齐 */
        historyItem.style.position = 'relative'; /* 为删除按钮定位 */

        const imagePreview = document.createElement('img');
        imagePreview.src = item.imageUrl;
        imagePreview.alt = '历史图片';
        imagePreview.style.width = '25%'; /* 1/3 宽度 */
        imagePreview.style.height = 'auto';
        imagePreview.style.marginRight = '10px';
        historyItem.appendChild(imagePreview);

        const textContainer = document.createElement('div');
        textContainer.style.width = '75%'; /* 2/3 宽度 */
        textContainer.style.display = 'flex';
        textContainer.style.flexDirection = 'column';

        const promptText = document.createElement('span');
        promptText.textContent = item.prompt;
        promptText.style.flexGrow = '1';
        promptText.style.userSelect = 'none'; /* 提示词不可复制 */
        promptText.style.overflow = 'hidden'; /* 隐藏超出部分 */
        promptText.style.textOverflow = 'ellipsis'; /* 显示省略号 */
        promptText.style.display = '-webkit-box';
        promptText.style.webkitLineClamp = '3'; /* 最多显示3行 */
        promptText.style.webkitBoxOrient = 'vertical';
        textContainer.appendChild(promptText);

        const timestampText = document.createElement('span');
        timestampText.textContent = new Date(item.timestamp).toLocaleString();
        timestampText.style.fontSize = '0.8em';
        timestampText.style.color = '#666';
        timestampText.style.fontStyle = 'italic'; /* 斜体 */
        textContainer.appendChild(timestampText);

        historyItem.appendChild(textContainer);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = '×';
        deleteButton.style.background = 'red';
        deleteButton.className = 'delete-button';
        deleteButton.onclick = function (event) {
          event.stopPropagation(); /* 阻止事件冒泡 */
          deleteHistoryItem(index);
        };
        historyItem.appendChild(deleteButton);

        historyItem.onclick = function () {
          fillForm(item);
        };

        historyContainer.appendChild(historyItem);
      });
    }

    // 删除历史记录项
    function deleteHistoryItem(index) {
      let history = JSON.parse(localStorage.getItem('image_history') || '[]');
      history.splice(index, 1);
      localStorage.setItem('image_history', JSON.stringify(history));
      updateHistory(); // 刷新历史记录显示
    }

    // 填充表单
    function fillForm(item) {
      document.getElementById('prompt').value = item.prompt;
      document.getElementById('width').value = item.width;
      document.getElementById('height').value = item.height;
      document.getElementById('steps').value = item.steps;
      document.getElementById('stepsValue').innerText = item.steps;
      document.getElementById('seed').value = item.seed;

      const outputImage = document.getElementById('output-image');
      outputImage.src = item.imageUrl;
      document.getElementById('image-container').style.display = 'block';
    }

    // 页面加载时更新历史记录
    document.addEventListener('DOMContentLoaded', function () {
      // 页面加载时检查本地缓存的 API Key
      const cachedApiKey = localStorage.getItem('apiKey_image_generator');
      if (cachedApiKey) {
        document.getElementById('api-key').value = cachedApiKey;
      }
      updateHistory();
    });
  </script>
</body>

</html>
